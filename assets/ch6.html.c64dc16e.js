import{_ as t}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as n,c as o,a as s,w as i,e,r as c,d as p}from"./app.887b133c.js";const l={},r=e(`<h1 id="chap6-functional-programming-\u51FD\u6570\u5F0F\u7F16\u7A0B" tabindex="-1"><a class="header-anchor" href="#chap6-functional-programming-\u51FD\u6570\u5F0F\u7F16\u7A0B" aria-hidden="true">#</a> Chap6. FUNCTIONAL PROGRAMMING \u51FD\u6570\u5F0F\u7F16\u7A0B</h1><p>In many ways, the concepts of functional programming predate programming itself. This paradigm is strongly based on the l-calculus invented by Alonzo Church in the 1930s.</p><blockquote><p>\u51FD\u6570\u5F0F\u7F16\u7A0B\u6240\u4F9D\u8D56\u7684\u539F\u7406\uFF0C\u5728\u5F88\u591A\u65B9\u800C\u5176\u5B9E\u662F\u65E9\u4E8E\u7F16\u7A0B\u672C\u8EAB\u51FA\u73B0\u7684\u3002\u56E0\u4E3A\u51FD\u6570\u5F0F\u7F16\u7A0B\u8FD9\u79CD\u8303\u5F0F\u5F3A\u70C8\u4F9D\u8D56\u4E8E Alonzo Church \u5728 20 \u4E16\u7EAA 30 \u5E74\u4EE3\u53D1\u660E\u7684 \u03BB \u6F14\u7B97\u3002</p></blockquote><h2 id="squares-of-integers-\u6574\u6570\u5E73\u65B9" tabindex="-1"><a class="header-anchor" href="#squares-of-integers-\u6574\u6570\u5E73\u65B9" aria-hidden="true">#</a> SQUARES OF INTEGERS \u6574\u6570\u5E73\u65B9</h2><p>To explain what functional programming is, it\u2019s best to examine some examples. Let\u2019s investigate a simple problem: printing the squares of the first 25 integers.</p><blockquote><p>\u6211\u4EEC\u6700\u597D\u8FD8\u662F\u7528\u4E00\u4E2A\u4F8B\u5B50\u6765\u89E3\u91CA\u4EC0\u4E48\u662F\u51FD\u6570\u5F0F\u7F16\u7A0B\u3002\u8BF7\u770B\u4E0B\u9762\u7684\u8FD9\u4E2A\u4F8B\u5B50\uFF1A\u8FD9\u6BB5\u4EE3\u7801\u60F3\u8981\u8F93\u51FA\u524D 25 \u4E2A\u6574\u6570\u7684\u5E73\u65B9\u503C\u3002</p></blockquote><p>In a language like Java, we might write the following:</p><blockquote><p>\u5982\u679C\u4F7F\u7528 Java \u8BED\u8A00\uFF0C\u4EE3\u7801\u5982\u4E0B\uFF1A</p></blockquote><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Squint</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">25</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>In a language like Clojure, which is a derivative of Lisp, and is functional, we might implement this same program as follows:</p><blockquote><p>\u4E0B\u9762\u6211\u4EEC\u6539\u7528 Clojure \u8BED\u8A00\u6765\u5199\u8FD9\u4E2A\u7A0B\u5E8F\uFF0CClojure \u662F LISP \u8BED\u8A00\u7684\u4E00\u79CD\u884D\u751F\u4F53\uFF0C\u5C5E\u4E8E\u51FD\u6570\u5F0F\u7F16\u7A0B\u8BED\u8A00\u3002\u5176\u4EE3\u7801\u5982\u4E0B\uFF1A</p></blockquote><div class="language-lisp ext-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token car">println</span> <span class="token punctuation">(</span><span class="token car">take</span> <span class="token number">25</span> <span class="token punctuation">(</span><span class="token car">map</span> <span class="token punctuation">(</span><span class="token car">fn</span> <span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token car">*</span> x x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token car">range</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>If you don\u2019t know Lisp, then this might look a little strange. So let me reformat it a bit and add some comments.</p><blockquote><p>\u5982\u679C\u8BFB\u8005\u5BF9 LISP \u4E0D\u719F\u6089\uFF0C\u8FD9\u6BB5\u4EE3\u7801\u53EF\u80FD\u770B\u8D77\u6765\u5F88\u5947\u602A\u3002\u6CA1\u5173\u7CFB\uFF0C\u8BA9\u6211\u4EEC\u6362\u4E00\u79CD\u683C\u5F0F\uFF0C\u7528\u6CE8\u91CA\u6765\u8BF4\u660E\u4E00\u4E0B\u5427\uFF1A</p></blockquote><div class="language-lisp ext-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token car">println</span> <span class="token comment">;___________________ Print</span>
  <span class="token punctuation">(</span><span class="token car">take</span> <span class="token number">25</span> <span class="token comment">;_________________ the first 25</span>
    <span class="token punctuation">(</span><span class="token car">map</span> <span class="token punctuation">(</span><span class="token car">fn</span> <span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token car">*</span> x x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">;__ squares</span>
      <span class="token punctuation">(</span><span class="token car">range</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">;___________ of Integers</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>It should be clear that println, take, map, and range are all functions. In Lisp, you call a function by putting it in parentheses. For example, (range) calls the range function.</p><blockquote><p>\u5F88\u660E\u663E\uFF0C\u8FD9\u91CC\u7684 println\u3001take\u3001map \u548C range \u90FD\u662F\u51FD\u6570\u3002\u5728 LISP \u4E2D\uFF0C\u51FD\u6570\u662F\u901A\u8FC7\u62EC\u53F7\u6765\u8C03\u7528\u7684\uFF0C\u4F8B\u5982\uFF08range\uFF09\u8868\u8FBE\u5F0F\u5C31\u662F\u5728\u8C03\u7528 range \u51FD\u6570\u3002</p></blockquote><p>The expression <code>(fn [x] (* x x))</code> is an anonymous function that calls the multiply function, passing its input argument in twice. In other words, it computes the square of its input.</p><blockquote><p>\u800C\u8868\u8FBE\u5F0F <code>(fn [x] (* xx))</code> \u5219\u662F\u4E00\u4E2A\u533F\u540D\u51FD\u6570\uFF0C\u8BE5\u51FD\u6570\u7528\u540C\u6837\u7684\u503C\u4F5C\u4E3A\u53C2\u6570\u8C03\u7528\u4E86\u4E58\u6CD5\u51FD\u6570\u3002\u6362\u53E5\u8BDD\u8BF4\uFF0C\u8BE5\u51FD\u6570\u8BA1\u7B97\u7684\u662F\u5E73\u65B9\u503C\u3002</p></blockquote><p>Looking at the whole thing again, it\u2019s best to start with the innermost function call.</p><blockquote><p>\u73B0\u5728\u8BA9\u6211\u4EEC\u56DE\u8FC7\u5934\u518D\u770B\u4E00\u4E0B\u8FD9\u6574\u53E5\u4EE3\u7801\uFF0C\u4ECE\u6700\u5185\u4FA7\u7684\u51FD\u6570\u8C03\u7528\u5F00\u59CB\uFF1A</p></blockquote><ul><li>The range function returns a never-ending list of integers starting with 0.</li><li>This list is passed into the map function, which calls the anonymous squaring function on each element, producing a new never-ending list of all the squares.</li><li>The list of squares is passed into the take function, which returns a new list with only the first 25 elements.</li><li>The println function prints its input, which is a list of the first 25 squares of integers.</li></ul><hr><blockquote><ul><li>range \u51FD\u6570\u4F1A\u8FD4\u56DE\u4E00\u4E2A\u4ECE 0 \u5F00\u59CB\u7684\u6574\u6570\u65E0\u7A77\u5217\u8868\u3002</li><li>\u7136\u540E\u8BE5\u5217\u8868\u4F1A\u88AB\u4F20\u5165 map \u51FD\u6570\uFF0C\u5E76\u9488\u5BF9\u5217\u8868\u4E2D\u7684\u6BCF\u4E2A\u5143\u7D20\uFF0C\u8C03\u7528\u6C42\u5E73\u65B9\u503C\u7684\u533F\u540D\u51FD\u6570\uFF0C\u4EA7\u751F\u4E86\u4E00\u4E2A\u65E0\u7A77\u591A\u7684\u3001\u5305\u542B\u5E73\u65B9\u503C\u7684\u5217\u8868\u3002</li><li>\u63A5\u7740\u518D\u5C06\u8FD9\u4E2A\u5217\u8868\u4F20\u5165 take \u51FD\u6570\uFF0C\u540E\u8005\u4F1A\u8FD4\u56DE\u4E00\u4E2A\u4EC5\u5305\u542B\u524D 25 \u4E2A\u5143\u7D20\u7684 \u65B0\u5217\u8868\u3002</li><li>println \u51FD\u6570\u5C06\u5B83\u7684\u53C2\u6570\u8F93\u51FA\uFF0C\u8BE5\u53C2\u6570\u5C31\u662F\u4E0A\u9762\u8FD9\u4E2A\u5305\u542B\u4E86 25 \u4E2A\u5E73\u65B9\u503C\u7684 \u5217\u8868\u3002</li></ul></blockquote><p>If you find yourself terrified by the concept of never-ending lists, don\u2019t worry. Only the first 25 elements of those never-ending lists are actually created. That\u2019s because no element of a never-ending list is evaluated until it is accessed.</p><blockquote><p>\u8BFB\u8005\u4E0D\u7528\u62C5\u5FC3\u4E0A\u9762\u63D0\u5230\u7684\u65E0\u7A77\u5217\u8868\u3002\u56E0\u4E3A\u8FD9\u4E9B\u5217\u8868\u4E2D\u7684\u5143\u7D20\u53EA\u6709\u5728\u88AB\u8BBF\u95EE\u65F6\u624D\u4F1A\u88AB\u521B\u5EFA\uFF0C\u6240\u4EE5\u5B9E\u9645\u4E0A\u53EA\u6709\u524D 25 \u4E2A\u5143\u7D20\u662F\u771F\u6B63\u88AB\u521B\u5EFA\u4E86\u7684\u3002</p></blockquote><p>If you found all of that confusing, then you can look forward to a glorious time learning all about Clojure and functional programming. It is not my goal to teach you about these topics here.</p><blockquote><p>\u5982\u679C\u4E0A\u8FF0\u5185\u5BB9\u8FD8\u662F\u8BA9\u8BFB\u8005\u89C9\u5F97\u4E91\u91CC\u96FE\u91CC\u7684\u8BDD\uFF0C\u53EF\u4EE5\u81EA\u884C\u5B66\u4E60\u4E00\u4E0B Clojure \u548C\u51FD\u6570\u5F0F\u7F16\u7A0B\uFF0C\u672C\u4E66\u7684\u76EE\u6807\u5E76\u4E0D\u662F\u8981\u6559\u4F60\u5B66\u4F1A\u8FD9\u95E8\u8BED\u8A00\uFF0C\u56E0\u6B64\u4E0D\u518D\u5C55\u5F00\u3002</p></blockquote><p>Instead, my goal here is to point out something very dramatic about the difference between the Clojure and Java programs. The Java program uses a mutable variable\u2014a variable that changes state during the execution of the program. That variable is i\u2014the loop control variable. No such mutable variable exists in the Clojure program. In the Clojure program, variables like x are initialized, but they are never modified.</p><blockquote><p>\u76F8\u53CD\uFF0C\u6211\u4EEC\u8BA8\u8BBA\u5B83\u7684\u4E3B\u8981\u76EE\u6807\u662F\u8981\u7A81\u663E\u51FA Clojure \u548C Java \u8FD9\u4E24\u79CD\u8BED\u8A00\u4E4B\u95F4\u7684\u5DE8\u5927\u533A\u522B\u3002\u5728 Java \u7A0B\u5E8F\u4E2D\uFF0C\u6211\u4EEC\u4F7F\u7528\u7684\u662F\u53EF\u53D8\u91CF\uFF0C\u5373\u53D8\u91CF i\uFF0C\u8BE5\u53D8\u91CF\u7684\u503C\u4F1A\u968F\u7740\u7A0B\u5E8F\u6267\u884C\u7684\u8FC7\u7A0B\u800C\u6539\u53D8\uFF0C\u6545\u88AB\u79F0\u4E3A\u5FAA\u73AF\u63A7\u5236\u53D8\u91CF\u3002\u800C Clojure \u7A0B\u5E8F\u4E2D\u662F\u4E0D\u5B58\u5728\u8FD9\u79CD\u53D8\u91CF\u7684\uFF0C\u53D8\u91CF x \u4E00\u65E6\u88AB\u521D\u59CB\u5316\u4E4B\u540E\uFF0C\u5C31\u4E0D\u4F1A\u518D\u88AB\u66F4\u6539\u4E86\u3002</p></blockquote><p>This leads us to a surprising statement: Variables in functional languages do not vary.</p><blockquote><p>\u8FD9\u53E5\u8BDD\u6709\u70B9\u51FA\u4EBA\u610F\u6599\uFF1A\u51FD\u6570\u5F0F\u7F16\u7A0B\u8BED\u8A00\u4E2D\u7684\u53D8\u91CF\uFF08Variable\uFF09\u662F\u4E0D\u53EF\u53D8\uFF08Vary\uFF09\u7684\u3002</p></blockquote><h2 id="immutability-and-architecture-\u4E0D\u53EF\u53D8\u6027\u4E0E\u8F6F\u4EF6\u67B6\u6784" tabindex="-1"><a class="header-anchor" href="#immutability-and-architecture-\u4E0D\u53EF\u53D8\u6027\u4E0E\u8F6F\u4EF6\u67B6\u6784" aria-hidden="true">#</a> IMMUTABILITY AND ARCHITECTURE \u4E0D\u53EF\u53D8\u6027\u4E0E\u8F6F\u4EF6\u67B6\u6784</h2><p>Why is this point important as an architectural consideration? Why would an architect be concerned with the mutability of variables? The answer is absurdly simple: All race conditions, deadlock conditions, and concurrent update problems are due to mutable variables. You cannot have a race condition or a concurrent update problem if no variable is ever updated. You cannot have deadlocks without mutable locks.</p><blockquote><p>\u4E3A\u4EC0\u4E48\u4E0D\u53EF\u53D8\u6027\u662F\u8F6F\u4EF6\u67B6\u6784\u8BBE\u8BA1\u9700\u8981\u8003\u8651\u7684\u91CD\u70B9\u5462\uFF1F\u4E3A\u4EC0\u4E48\u8F6F\u4EF6\u67B6\u6784\u5E05\u8981\u64CD\u5FC3\u53D8\u91CF\u7684\u53EF\u53D8\u6027\u5462\uFF1F\u7B54\u6848\u663E\u800C\u6613\u89C1\uFF1A\u6240\u6709\u7684\u7ADE\u4E89\u95EE\u9898\u3001\u6B7B\u9501\u95EE\u9898\u3001\u5E76\u53D1\u66F4\u65B0\u95EE\u9898\u90FD\u662F\u7531\u53EF\u53D8\u53D8\u91CF\u5BFC\u81F4\u7684\u3002\u5982\u679C\u53D8\u91CF\u6C38\u8FDC\u4E0D\u4F1A\u88AB\u66F4\u6539\uFF0C\u90A3\u5C31\u4E0D\u53EF\u80FD\u4EA7\u751F\u7ADE\u4E89\u6216\u8005\u5E76\u53D1\u66F4\u65B0\u95EE\u9898\u3002\u5982\u679C\u9501\u72B6\u6001\u662F\u4E0D\u53EF\u53D8\u7684\uFF0C\u90A3\u5C31\u6C38\u8FDC\u4E0D\u4F1A\u4EA7\u751F\u6B7B\u9501\u95EE\u9898\u3002</p></blockquote><p>In other words, all the problems that we face in concurrent applications\u2014all the problems we face in applications that require multiple threads, and multiple processors\u2014cannot happen if there are no mutable variables.</p><blockquote><p>\u6362\u53E5\u8BDD\u8BF4\uFF0C\u4E00\u5207\u5E76\u53D1\u5E94\u7528\u9047\u5230\u7684\u95EE\u9898\uFF0C\u4E00\u5207\u7531\u4E8E\u4F7F\u7528\u591A\u7EBF\u7A0B\u3001\u591A\u5904\u7406\u5668\u800C\u5F15\u8D77\u7684\u95EE\u9898\uFF0C\u5982\u679C\u6CA1\u6709\u53EF\u53D8\u53D8\u91CF\u7684\u8BDD\u90FD\u4E0D\u5BF9\u80FD\u53D1\u5DE5\u3002</p></blockquote><p>As an architect, you should be very interested in issues of concurrency. You want to make sure that the systems you design will be robust in the presence of multiple threads and processors. The question you must be asking yourself, then, is whether immutability is practicable.</p><blockquote><p>\u4F5C\u4E3A\u4E00\u4E2A\u8F6F\u4EF6\u67B6\u6784\u5E08\uFF0C\u5F53\u7136\u5E94\u8BE5\u8981\u5BF9\u5E76\u53D1\u95EE\u9898\u4FDD\u6301\u9AD8\u5EA6\u5173\u6CE8\u3002\u6211\u4EEC\u9700\u8981\u786E\u4FDD\u81EA\u5DF1\u8BBE\u8BA1\u7684\u7CFB\u7EDF\u5728\u591A\u7EBF\u7A0B\u3001\u591A\u5904\u7406\u5668\u73AF\u5883\u4E2D\u80FD\u7A33\u5B9A\u5DE5\u4F5C\u3002\u6240\u4EE5\u5728\u8FD9\u91CC\uFF0C\u6211\u4EEC\u5B9E\u9645\u5E94\u8BE5\u8981\u95EE\u7684\u95EE\u9898\u662F\uFF1A\u4E0D\u53EF\u53D8\u6027\u662F\u5426\u5B9E\u9645\u53EF\u884C\uFF1F</p></blockquote><p>The answer to that question is affirmative, if you have infinite storage and infinite processor speed. Lacking those infinite resources, the answer is a bit more nuanced. Yes, immutability can be practicable, if certain compromises are made.</p><blockquote><p>\u5982\u679C\u6211\u4EEC\u80FD\u5FFD\u7565\u5B58\u50A8\u5668\u4E0E\u5904\u7406\u5668\u5728\u901F\u5EA6\u4E0A\u7684\u9650\u5236\uFF0C\u90A3\u4E48\u7B54\u6848\u662F\u80AF\u5B9A\u7684\u3002\u5426\u5219\u7684\u8BDD\uFF0C\u4E0D\u53EF\u53D8\u6027\u53EA\u6709\u5728\u4E00\u5B9A\u60C5\u51B5\u4E0B\u662F\u53EF\u884C\u7684\u3002</p></blockquote><p>Let\u2019s look at some of those compromises.</p><blockquote><p>\u4E0B\u9762\u8BA9\u6211\u4EEC\u6765\u770B\u4E00\u4E0B\u5B83\u5177\u4F53\u8BE5\u5982\u4F55\u505A\u5230\u53EF\u884C\u3002</p></blockquote><h2 id="segregation-of-mutability-\u53EF\u53D8\u6027\u7684\u9694\u79BB" tabindex="-1"><a class="header-anchor" href="#segregation-of-mutability-\u53EF\u53D8\u6027\u7684\u9694\u79BB" aria-hidden="true">#</a> SEGREGATION OF MUTABILITY \u53EF\u53D8\u6027\u7684\u9694\u79BB</h2><p>One of the most common compromises in regard to immutability is to segregate the application, or the services within the application, into mutable and immutable components. The immutable components perform their tasks in a purely functional way, without using any mutable variables. The immutable components communicate with one or more other components that are not purely functional, and allow for the state of variables to be mutated (Figure 6.1).</p><blockquote><p>\u4E00\u79CD\u5E38\u89C1\u65B9\u5F0F\u662F\u5C06\u5E94\u7528\u7A0B\u5E8F\uFF0C\u6216\u8005\u662F\u5E94\u7528\u7A0B\u5E8F\u7684\u5185\u90E8\u670D\u52A1\u8FDB\u884C\u5207\u5206\uFF0C\u5212\u5206\u4E3A\u53EF\u53D8\u7684\u548C\u4E0D\u53EF\u53D8\u7684\u4E24\u79CD\u7EC4\u4EF6\u3002\u4E0D\u53EF\u53D8\u7EC4\u4EF6\u7528\u7EAF\u51FD\u6570\u7684\u65B9\u5F0F\u6765\u6267\u884C\u4EFB\u52A1\uFF0C\u671F\u95F4\u4E0D\u66F4\u6539\u4EFB\u4F55\u72B6\u6001\u3002\u8FD9\u4E9B\u4E0D\u53EF\u53D8\u7684\u7EC4\u4EF6\u5C06\u901A\u8FC7\u4E0E\u4E00\u4E2A\u6216\u591A\u4E2A\u975E\u51FD\u6570\u5F0F\u7EC4\u4EF6\u901A\u4FE1\u7684\u65B9\u5F0F\u6765\u4FEE\u6539\u53D8\u91CF\u72B6\u6001\uFF08\u53C2\u89C1\u56FE 6.1\uFF09\u3002</p></blockquote>`,46),u=p("Mutating state and transactional memory"),h=e(`<p>Since mutating state exposes those components to all the problems of concurrency, it is common practice to use some kind of transactional memory to protect the mutable variables from concurrent updates and race conditions.</p><blockquote><p>\u7531\u4E8E\u72B6\u6001\u7684\u4FEE\u6539\u4F1A\u5BFC\u81F4\u4E00\u7CFB\u5217\u5E76\u53D1\u95EE\u9898\u7684\u4EA7\u751F\uFF0C\u6240\u4EE5\u6211\u4EEC\u901A\u5E38\u4F1A\u91C7\u7528\u67D0\u79CD\u4E8B\u52A1\u578B\u5185\u5B58\u6765\u4FDD\u62A4\u53EF\u53D8\u53D8\u91CF\uFF0C\u907F\u514D\u540C\u6B65\u66F4\u65B0\u548C\u7ADE\u4E89\u72B6\u6001\u7684\u53D1\u751F\u3002</p></blockquote><p>Transactional memory simply treats variables in memory the same way a database treats records on disk.1 It protects those variables with a transaction- or retry-based scheme.</p><blockquote><p>\u4E8B\u52A1\u578B\u5185\u5B58\u57FA\u672C\u4E0A\u4E0E\u6570\u636E\u5E93\u4FDD\u62A4\u78C1\u76D8\u6570\u636E\u7684\u65B9\u5F0F 1 \u7C7B\u4F3C\uFF0C\u901A\u5E38\u91C6\u7528\u7684\u662F\u4E8B\u52A1\u6216\u8005\u91CD\u8BD5\u673A\u5236\u3002</p></blockquote><p>A simple example of this approach is Clojure\u2019s atom facility:</p><blockquote><p>\u4E0B\u9762\u6211\u4EEC\u53EF\u4EE5\u7528 Clojure \u4E2D\u7684 atom \u673A\u5236\u6765\u5199\u4E00\u4E2A\u7B80\u5355\u7684\u4F8B\u5B50\uFF1A</p></blockquote><div class="language-clojure ext-clojure line-numbers-mode"><pre class="language-clojure"><code><span class="token punctuation">(</span><span class="token keyword">def</span> counter <span class="token punctuation">(</span><span class="token function">atom</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">; initialize counter to 0</span>
<span class="token punctuation">(</span><span class="token function">swap!</span> counter inc<span class="token punctuation">)</span>    <span class="token comment">; safely increment counter.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>In this code, the counter variable is defined as an atom. In Clojure, an atom is a special kind of variable whose value is allowed to mutate under very disciplined conditions that are enforced by the swap! function.</p><blockquote><p>\u5728\u8FD9\u6BB5\u4EE3\u7801\u4E2D\uFF0Ccounter \u53D8\u91CF\u88AB\u5B9A\u4E49\u4E3A atom \u7C7B\u578B\u3002\u5728 Clojure \u4E2D\uFF0Catom \u662F\u4E00\u7C7B\u7279\u6B8A\u7684\u53D8\u91CF\uFF0C\u5B83\u88AB\u5141\u8BB8\u5728 swap!\u51FD\u6570\u5B9A\u4E49\u7684\u4E25\u683C\u6761\u4EF6\u4E0B\u8FDB\u884C\u66F4\u6539\u3002</p></blockquote><p>The swap! function, shown in the preceding code, takes two arguments: the atom to be mutated, and a function that computes the new value to be stored in the atom. In our example code, the counter atom will be changed to the value computed by the inc function, which simply increments its argument.</p><blockquote><p>\u81F3\u4E8E swap! \u51FD\u6570\uFF0C\u5982\u540C\u4E0A\u9762\u4EE3\u7801\u6240\u5199\uFF0C\u5B83\u9700\u8981\u4E24\u4E2A\u53C2\u6570\uFF1A\u4E00\u4E2A\u662F\u88AB\u7528\u6765\u4FEE\u6539\u7684 atom \u7C7B\u578B\u5B9E\u4F8B\uFF0C\u53E6\u4E00\u4E2A\u662F\u7528\u6765\u8BA1\u7B97\u65B0\u503C\u7684\u51FD\u6570\u3002\u5728\u4E0A\u9762\u7684\u4EE3\u7801\u4E2D\uFF0Cinc \u51FD\u6570\u4F1A\u5C06\u53C2\u6570\u52A0 1 \u5E76\u5B58\u5165 counter \u8FD9\u4E2A atom \u5B9E\u4F8B\u3002</p></blockquote><p>The strategy used by swap! is a traditional compare and swap algorithm. The value of counter is read and passed to inc. When inc returns, the value of counter is locked and compared to the value that was passed to inc. If the value is the same, then the value returned by inc is stored in counter and the lock is released. Otherwise, the lock is released, and the strategy is retried from the beginning.</p><blockquote><p>\u5728\u8FD9\u91CC\uFF0Cswap!\u6240\u91C7\u7528\u7684\u7B56\u7565\u662F\u4F20\u7EDF\u7684\u6BD4\u8F83+\u66FF\u6362\u7B97\u6CD5\u3002\u5373\u5148\u8BFB\u53D6 counter \u53D8\u91CF\u7684\u503C\uFF0C\u518D\u5C06\u5176\u4F20\u5165 inc \u51FD\u6570\u3002\u7136\u540E\u5F53 inc \u51FD\u6570\u8FD4\u56DE\u65F6\uFF0C\u5C06\u539F\u5148\u7528\u9501\u4FDD\u62A4\u8D77\u6765\u7684 counter \u503C\u4E0E\u4F20\u5165 inc \u65F6\u7684\u503C\u8FDB\u884C\u6BD4\u8F83\u3002\u5982\u679C\u4E24\u8FB9\u7684\u503C\u4E00\u81F4\uFF0C\u5219\u5C06 inc \u51FD\u6570\u8FD4\u56DE\u7684\u503C\u5B58\u5165 counter\uFF0C\u91CA\u653E\u9501\u3002\u5426\u5219\uFF0C\u5148\u91CA\u653E\u9501\uFF0C\u518D\u4ECE\u5934\u8FDB\u884C\u91CD\u8BD5\u3002</p></blockquote><p>The atom facility is adequate for simple applications. Unfortunately, it cannot completely safeguard against concurrent updates and deadlocks when multiple dependent variables come into play. In those instances, more elaborate facilities can be used.</p><blockquote><p>\u5F53\u7136\uFF0Catom \u8FD9\u4E2A\u673A\u5236\u53EA\u9002\u7528\u4E8E\u4E0A\u9762\u8FD9\u79CD\u7B80\u5355\u7684\u5E94\u7528\u7A0B\u5E8F\uFF0C\u5B83\u5E76\u4E0D\u9002\u7528\u4E8E\u89E3\u51B3\u7531\u591A\u4E2A\u76F8\u5173\u53D8\u91CF\u540C\u65F6\u9700\u8981\u66F4\u6539\u6240\u5F15\u53D1\u7684\u5E76\u53D1\u66F4\u65B0\u95EE\u9898\u548C\u6B7B\u9501\u95EE\u9898\uFF0C\u8981\u60F3\u89E3\u51B3\u8FD9\u4E9B\u95EE\u9898\uFF0C\u6211\u4EEC\u5C31\u9700\u8981\u7528\u5230\u66F4\u590D\u6742\u7684\u673A\u5236\u3002</p></blockquote><p>The point is that well-structured applications will be segregated into those components that do not mutate variables and those that do. This kind of segregation is supported by the use of appropriate disciplines to protect those mutated variables.</p><blockquote><p>\u8FD9\u91CC\u7684\u8981\u70B9\u662F\uFF1A\u4E00\u4E2A\u67B6\u6784\u8BBE\u8BA1\u826F\u597D\u7684\u5E94\u7528\u7A0B\u5E8F\u5E94\u8BE5\u5C06\u72B6\u6001\u4FEE\u6539\u7684\u90E8\u5206\u548C\u4E0D\u9700\u8981\u4FEE\u6539\u72B6\u6001\u7684\u90E8\u5206\u9694\u79BB\u6210\u5355\u72EC\u7684\u7EC4\u4EF6\uFF0C\u7136\u540E\u7528\u5408\u9002\u7684\u673A\u5236\u6765\u4FDD\u62A4\u53EF\u53D8\u91CF\u3002</p></blockquote><p>Architects would be wise to push as much processing as possible into the immutable components, and to drive as much code as possible out of those components that must allow mutation.</p><blockquote><p>\u8F6F\u4EF6\u67B6\u6784\u5E08\u5E94\u8BE5\u7740\u529B\u4E8E\u5C06\u5927\u90E8\u5206\u5904\u7406\u903B\u8F91\u90FD\u5F52\u4E8E\u4E0D\u53EF\u53D8\u7EC4\u4EF6\u4E2D\uFF0C\u53EF\u53D8\u72B6\u6001\u7EC4\u4EF6\u7684\u903B\u8F91\u5E94\u8BE5\u8D8A\u5C11\u8D8A\u597D\u3002</p></blockquote><h2 id="event-sourcing-\u4E8B\u4EF6\u6EAF\u6E90" tabindex="-1"><a class="header-anchor" href="#event-sourcing-\u4E8B\u4EF6\u6EAF\u6E90" aria-hidden="true">#</a> EVENT SOURCING \u4E8B\u4EF6\u6EAF\u6E90</h2><p>The limits of storage and processing power have been rapidly receding from view. Nowadays it is common for processors to execute billions of instructions per second and to have billions of bytes of RAM. The more memory we have, and the faster our machines are, the less we need mutable state.</p><blockquote><p>\u968F\u7740\u5B58\u50A8\u548C\u5904\u7406\u80FD\u529B\u7684\u5927\u5E45\u8FDB\u6B65\uFF0C\u73B0\u5728\u62E5\u6709\u6BCF\u79D2\u53EF\u4EE5\u6267\u884C\u6570\u5341\u4EBF\u6761\u6307\u4EE4\u7684\u5904\u7406\u5668\uFF0C\u4EE5\u53CA\u6570\u5341\u4EBF\u5B57\u8282\u5185\u5B58\u7684\u8BA1\u7B97\u673A\u5DF2\u7ECF\u5F88\u5E38\u89C1\u4E86\u3002\u800C\u5185\u5B58\u8D8A\u5927\uFF0C\u5904\u7406\u901F\u5EA6\u8D8A\u5FEB\uFF0C\u6211\u4EEC\u5BF9\u53EF\u53D8\u72B6\u6001\u7684\u4F9D\u8D56\u5C31\u4F1A\u8D8A\u5C11\u3002</p></blockquote><p>As a simple example, imagine a banking application that maintains the account balances of its customers. It mutates those balances when deposit and withdrawal transactions are executed.</p><blockquote><p>\u4E3E\u4E2A\u7B80\u5355\u7684\u4F8B\u5B50\uFF0C\u5047\u8BBE\u67D0\u4E2A\u94F6\u884C\u5E94\u7528\u7A0B\u5E8F\u9700\u8981\u7EF4\u62A4\u5BA2\u6237\u8D26\u6237\u4F59\u989D\u4FE1\u606F\uFF0C\u5F53\u5B83\u653E\u884C\u5B58\u53D6\u6B3E\u4E8B\u52A1\u65F6\uFF0C\u5C31\u8981\u540C\u65F6\u8D1F\u8D23\u4FEE\u6539\u4F59\u989D\u8BB0\u5F55\u3002</p></blockquote><p>Now imagine that instead of storing the account balances, we store only the transactions. Whenever anyone wants to know the balance of an account, we simply add up all the transactions for that account, from the beginning of time. This scheme requires no mutable variables.</p><blockquote><p>\u5982\u679C\u6211\u4EEC\u4E0D\u4FDD\u5B58\u5177\u4F53\u8D26\u6237\u4F59\u989D\uFF0C\u4EC5\u4EC5\u4FDD\u5B58\u4E8B\u52A1\u65E5\u5FD7\uFF0C\u90A3\u4E48\u5F53\u6709\u4EBA\u60F3\u67E5\u8BE2\u8D26\u6237\u4F59\u989D\u65F6\u3002\u6211\u4EEC\u5C31\u5C06\u5168\u90E8\u4EA4\u6613\u8BB0\u5F55\u53D6\u51FA\uFF0C\u5E76\u4E14\u6BCF\u6B21\u90FD\u5F97\u4ECE\u6700\u5F00\u59CB\u5230\u5F53\u4E0B\u8FDB\u884C\u7D2F\u8BA1\u3002\u5F53\u7136\uFF0C\u8FD9\u6837\u7684\u8BBE\u8BA1\u5C31\u4E0D\u9700\u8981\u7EF4\u62A4\u4EFB\u4F55\u53EF\u53D8\u53D8\u91CF\u4E86\u3002</p></blockquote><p>Obviously, this approach sounds absurd. Over time, the number of transactions would grow without bound, and the processing power required to compute the totals would become intolerable. To make this scheme work forever, we would need infinite storage and infinite processing power.</p><blockquote><p>\u4F46\u663E\u800C\u6613\u89C1\uFF0C\u8FD9\u79CD\u5B9E\u73B0\u662F\u6709\u4E9B\u4E0D\u5408\u7406\u7684\u3002\u56E0\u4E3A\u968F\u7740\u65F6\u95F4\u7684\u63A8\u79FB\uFF0C\u4E8B\u52A1\u7684\u6570\u76EE\u4F1A\u65E0\u9650\u5236\u589E\u957F\uFF0C\u6BCF\u6B21\u5904\u7406\u603B\u989D\u6240\u9700\u8981\u7684\u5904\u7406\u80FD\u529B\u5F88\u5FEB\u5C31\u4F1A\u53D8\u5F97\u4E0D\u80FD\u63A5\u53D7\u3002\u5982\u679C\u60F3\u4F7F\u8FD9\u79CD\u8BBE\u8BA1\u6C38\u8FDC\u53EF\u884C\u7684\u8BDD\uFF0C\u6211\u4EEC\u5C06\u9700\u8981\u65E0\u9650\u5BB9\u91CF\u7684\u5B58\u50A8\uFF0C\u4EE5\u53CA\u65E0\u9650\u7684\u5904\u7406\u80FD\u529B\u3002</p></blockquote><p>But perhaps we don\u2019t have to make the scheme work forever. And perhaps we have enough storage and enough processing power to make the scheme work for the reasonable lifetime of the application.</p><blockquote><p>\u4F46\u662F\u53EF\u80FD\u6211\u4EEC\u5E76\u4E0D\u9700\u8981\u8FD9\u4E2A\u8BBE\u8BA1\u6C38\u8FDC\u53EF\u884C\uFF0C\u800C\u4E14\u53EF\u80FD\u5728\u6574\u4E2A\u7A0B\u5E8F\u7684\u751F\u547D\u5468\u671F\u5185\uFF0C\u6211\u4EEC\u6709\u8DB3\u591F\u7684\u5B58\u50A8\u548C\u5904\u7406\u80FD\u529B\u6765\u6EE1\u8DB3\u5B83\u3002</p></blockquote><p>This is the idea behind event sourcing.2 Event sourcing is a strategy wherein we store the transactions, but not the state. When state is required, we simply apply all the transactions from the beginning of time.</p><blockquote><p>\u8FD9\u5C31\u662F\u4E8B\u4EF6\u6EAF\u6E90\uFF0C\u5728\u8FD9\u79CD\u4F53\u7CFB\u4E0B\uFF0C\u6211\u4EEC\u53EA\u5B58\u50A8\u4E8B\u52A1\u8BB0\u5F55\uFF0C\u4E0D\u5B58\u50A8\u5177\u4F53\u72B6\u6001\u3002\u5F53\u9700\u8981\u5177\u4F53\u72B6\u6001\u65F6\uFF0C\u6211\u4EEC\u53EA\u8981\u4ECE\u5934\u5F00\u59CB\u8BA1\u7B97\u6240\u6709\u7684\u4E8B\u52A1\u5373\u53EF\u3002</p></blockquote><p>Of course, we can take shortcuts. For example, we can compute and save the state every midnight. Then, when the state information is required, we need compute only the transactions since midnight.</p><p>Now consider the data storage required for this scheme: We would need a lot of it. Realistically, offline data storage has been growing so fast that we now consider trillions of bytes to be small\u2014so we have a lot of it.</p><blockquote><p>\u5728\u5B58\u50A8\u65B9\u9762\uFF0C\u8FD9\u79CD\u67B6\u6784\u7684\u786E\u9700\u8981\u5F88\u5927\u7684\u5B58\u50A8\u5BB9\u91CF\u3002\u5982\u4ECA\u79BB\u7EBF\u6570\u636E\u5B58\u50A8\u5668\u7684\u589E\u957F\u662F\u975E\u5E38\u5FEB\u7684\uFF0C\u73B0\u5728 1 TB \u5BF9\u6211\u4EEC\u6765\u8BF4\u4E5F\u5DF2\u7ECF\u4E0D\u7B97\u4EC0\u4E48\u4E86\u3002</p></blockquote><p>More importantly, nothing ever gets deleted or updated from such a data store. As a consequence, our applications are not CRUD; they are just CR. Also, because neither updates nor deletions occur in the data store, there cannot be any concurrent update issues.</p><blockquote><p>\u66F4\u91CD\u8981\u7684\u662F\uFF0C\u8FD9\u79CD\u6570\u636E\u5B58\u50A8\u6A21\u5F0F\u4E2D\u4E0D\u5B58\u5728\u5220\u9664\u548C\u66F4\u65B0\u7684\u60C5\u51B5\uFF0C\u6211\u4EEC\u7684\u5E94\u7528\u7A0B\u5E8F\u4E0D\u662F CRUD\uFF0C\u800C\u662F CR\u3002\u56E0\u4E3A\u66F4\u65B0\u548C\u5220\u9664\u8FD9\u4E24\u79CD\u64CD\u4F5C\u90FD\u4E0D\u5B58\u5728\u4E86\uFF0C\u81EA\u7136\u4E5F\u5C31\u4E0D\u5B58\u5728\u5E76\u53D1\u95EE\u9898\u3002</p></blockquote><p>If we have enough storage and enough processor power, we can make our applications entirely immutable\u2014and, therefore, entirely functional.</p><blockquote><p>\u5982\u679C\u6211\u4EEC\u6709\u8DB3\u591F\u5927\u7684\u5B58\u50A8\u91CF\u548C\u5904\u7406\u80FD\u529B\uFF0C\u5E94\u7528\u7A0B\u5E8F\u5C31\u53EF\u4EE5\u7528\u5B8C\u5168\u4E0D\u53EF\u53D8\u7684\u3001\u7EAF\u51FD\u6570\u5F0F\u7684\u65B9\u5F0F\u6765\u7F16\u7A0B\u3002</p></blockquote><p>If this still sounds absurd, it might help if you remembered that this is precisely the way your source code control system works.</p><blockquote><p>\u5982\u679C\u8BFB\u8005\u8FD8\u662F\u89C9\u5F97\u8FD9\u542C\u8D77\u6765\u4E0D\u592A\u9760\u8C31\uFF0C\u53EF\u4EE5\u60F3\u60F3\u6211\u4EEC\u73B0\u5728\u7528\u7684\u6E90\u4EE3\u7801\u7BA1\u7406\u7A0B\u5E8F\uFF0C\u5B83\u4EEC\u6B63\u662F\u7528\u8FD9\u79CD\u65B9\u5F0F\u5DE5\u4F5C\u7684\uFF01</p></blockquote><h2 id="conclusion-\u672C\u7AE0\u5C0F\u7ED3" tabindex="-1"><a class="header-anchor" href="#conclusion-\u672C\u7AE0\u5C0F\u7ED3" aria-hidden="true">#</a> CONCLUSION \u672C\u7AE0\u5C0F\u7ED3</h2><p>To summarize:</p><blockquote><p>\u4E0B\u9762\u6211\u4EEC\u6765\u603B\u7ED3\u4E00\u4E0B\uFF1A</p></blockquote><ul><li>Structured programming is discipline imposed upon direct transfer of control.</li><li>Object-oriented programming is discipline imposed upon indirect transfer of control.</li><li>Functional programming is discipline imposed upon variable assignment.</li></ul><hr><blockquote><ul><li>\u7ED3\u6784\u5316\u7F16\u7A0B\u662F\u591A\u5BF9\u7A0B\u5E8F\u63A7\u5236\u6743\u7684\u76F4\u63A5\u8F6C\u79FB\u7684\u9650\u5236\u3002</li><li>\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u662F\u5BF9\u7A0B\u5E8F\u63A7\u5236\u6743\u7684\u95F4\u63A5\u8F6C\u79FB\u7684\u9650\u5236\u3002</li><li>\u51FD\u6570\u5F0F\u7F16\u7A0B\u662F\u5BF9\u7A0B\u5E8F\u4E2D\u8D4B\u503C\u64CD\u4F5C\u7684\u9650\u5236\u3002</li></ul></blockquote><p>Each of these three paradigms has taken something away from us. Each restricts some aspect of the way we write code. None of them has added to our power or our capabilities.</p><blockquote><p>\u8FD9\u4E09\u4E2A\u7F16\u7A0B\u8303\u5F0F\u90FD\u5BF9\u7A0B\u5E8F\u5458\u63D0\u51FA\u4E86\u65B0\u7684\u9650\u5236\u3002\u6BCF\u4E2A\u8303\u5F0F\u90FD\u7EA6\u675F\u4E86\u67D0\u79CD\u7F16\u5199\u4EE3\u7801\u7684\u65B9\u5F0F\uFF0C\u6CA1\u6709\u4E00\u4E2A\u7F16\u7A0B\u8303\u5F0F\u662F\u5728\u589E\u52A0\u65B0\u80FD\u529B\u3002</p></blockquote><p>What we have learned over the last half-century is what not to do.</p><blockquote><p>\u4E5F\u5C31\u662F\u8BF4\uFF0C\u6211\u4EEC\u8FC7\u53BB 50 \u5E74\u5B66\u5230\u7684\u4E1C\u897F\u4E3B\u8981\u662F\u2014\u2014\u4EC0\u4E48\u4E0D\u5E94\u8BE5\u505A\u3002</p></blockquote><p>With that realization, we have to face an unwelcome fact: Software is not a rapidly advancing technology. The rules of software are the same today as they were in 1946, when Alan Turing wrote the very first code that would execute in an electronic computer. The tools have changed, and the hardware has changed, but the essence of software remains the same.</p><blockquote><p>\u6211\u4EEC\u5FC5\u987B\u9762\u5BF9\u8FD9\u79CD\u4E0D\u53CB\u597D\u7684\u73B0\u5B9E\uFF1A\u8F6F\u4EF6\u6784\u5EFA\u5E76\u4E0D\u662F\u4E00\u4E2A\u8FC5\u901F\u524D\u8FDB\u7684\u6280\u672F\u3002\u4ECA\u5929\u6784\u5EFA\u8F6F\u4EF6\u7684\u89C4\u5219\u548C 1946 \u5E74\u963F\u5170\xB7\u56FE\u7075\u5199\u4E0B\u7535\u5B50\u8BA1\u7B97\u673A\u7684\u7B2C\u4E00\u884C\u4EE3\u7801\u65F6\u662F\u4E00\u6837\u7684\u3002\u5C3D\u7BA1\u5DE5\u5177\u53D8\u5316\u4E86\uFF0C\u786C\u4EF6\u53D8\u5316\u4E86\uFF0C\u4F46\u662F\u8F6F\u4EF6\u7F16\u7A0B\u7684\u6838\u5FC3\u6CA1\u6709\u53D8\u3002</p></blockquote><p>Software\u2014the stuff of computer programs\u2014is composed of sequence, selection, iteration, and indirection. Nothing more. Nothing less.</p><blockquote><p>\u603B\u800C\u8A00\u4E4B\uFF0C\u8F6F\u4EF6\uFF0C\u6216\u8005\u8BF4\u8BA1\u7B97\u673A\u7A0B\u5E8F\u65E0\u4E00\u4F8B\u5916\u662F\u7531\u987A\u5E8F\u7ED3\u6784\u3001\u5206\u652F\u7ED3\u6784\u3001\u5FAA\u73AF\u7ED3\u6784\u548C\u95F4\u63A5\u8F6C\u79FB\u8FD9\u51E0\u79CD\u884C\u4E3A\u7EC4\u5408\u800C\u6210\u7684\uFF0C\u65E0\u53EF\u589E\u52A0\uFF0C\u4E5F\u7F3A\u4E00\u4E0D\u53EF\u3002</p></blockquote>`,55);function d(m,b){const a=c("Figures");return n(),o("div",null,[r,s(a,{figure:"6-1"},{default:i(()=>[u]),_:1}),h])}const g=t(l,[["render",d],["__file","ch6.html.vue"]]);export{g as default};
