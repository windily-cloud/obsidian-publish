import{_ as i}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as l,c as r,b as n,a,w as p,e,d as s,r as c}from"./app.887b133c.js";const u={},d=e(`<h1 id="chap5-object-oriented-programming-\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B" tabindex="-1"><a class="header-anchor" href="#chap5-object-oriented-programming-\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B" aria-hidden="true">#</a> Chap5. OBJECT-ORIENTED PROGRAMMING \u9762\u5411\u5BF9\u8C61\u7F16\u7A0B</h1><p>As we will see, the basis of a good architecture is the understanding and application of the principles of object-oriented design (OO). But just what is OO?</p><blockquote><p>\u7A0D\u540E\u6211\u4EEC\u4F1A\u8BB2\u5230\uFF0C\u8BBE\u8BA1\u4E00\u4E2A\u4F18\u79C0\u7684\u8F6F\u4EF6\u67B6\u6784\u8981\u57FA\u4E8E\u5BF9\u9762\u5411\u5BF9\u8C61\u8BBE\u8BA1\uFF08Object-Oriented Design\uFF09\u7684\u6DF1\u5165\u7406\u89E3\u53CA\u5E94\u7528\u3002\u4F46\u6211\u4EEC\u9996\u5148\u5F97\u5F04\u660E\u767D\u4E00\u4E2A\u95EE\u9898\uFF1A\u7A76\u7ADF\u4EC0\u4E48\u662F\u9762\u5411\u5BF9\u8C61\uFF1F</p></blockquote><p>One answer to this question is \u201CThe combination of data and function.\u201D Although often cited, this is a very unsatisfying answer because it implies that o.f() is somehow different from f(o). This is absurd. Programmers were passing data structures into functions long before 1966, when Dahl and Nygaard moved the function call stack frame to the heap and invented OO.</p><blockquote><p>\u5BF9\u4E8E\u8FD9\u4E2A\u95EE\u9898\uFF0C\u4E00\u79CD\u5E38\u89C1\u7684\u56DE\u7B54\u662F\u201C\u6570\u636E\u4E0E\u51FD\u6570\u7684\u7EC4\u5408\u201D\u3002\u8FD9\u79CD\u8BF4\u6CD5\u867D\u7136\u88AB\u5E7F\u4E3A\u5F15\u7528\uFF0C\u4F46\u603B\u663E\u5F97\u5E76\u4E0D\u662F\u90A3\u4E48\u8D34\u5207\uFF0C\u56E0\u4E3A\u5B83\u4F3C\u4E4E\u6697\u793A\u4E86 <code>o.f()</code> \u4E0E <code>f(o)</code> \u4E4B\u95F4\u662F\u6709\u533A\u522B\u7684\uFF0C\u8FD9\u663E\u7136\u4E0D\u662F\u4E8B\u5B9E\u3002\u9762\u5411\u5BF9\u8C61\u7406\u8BBA\u662F\u5728 1966 \u5E74\u63D0\u51FA\u7684\uFF0C\u5F53\u65F6 Dahl \u548C Nygaard \u4E3B\u8981\u662F\u5C06\u51FD\u6570\u8C03\u7528\u6808\u8FC1\u79FB\u5230\u4E86\u5806\u533A\u57DF\u4E2D\u3002\u6570\u636E\u7ED3\u6784\u88AB\u7528\u4F5C\u51FD\u6570\u7684\u8C03\u7528\u53C2\u6570\u8FD9\u4EF6\u4E8B\u60C5\u8FDC\u6BD4\u8FD9\u53D1\u751F\u7684\u65F6\u95F4\u66F4\u65E9\u3002</p></blockquote><p>Another common answer to this question is \u201CA way to model the real world.\u201D This is an evasive answer at best. What does \u201Cmodeling the real world\u201D actually mean, and why is it something we would want to do? Perhaps this statement is intended to imply that OO makes software easier to understand because it has a closer relationship to the real world\u2014but even that statement is evasive and too loosely defined. It does not tell us what OO is.</p><blockquote><p>\u53E6\u4E00\u79CD\u5E38\u89C1\u7684\u56DE\u7B54\u662F\u201C\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u662F\u4E00\u79CD\u5BF9\u771F\u5B9E\u4E16\u754C\u8FDB\u884C\u5EFA\u6A21\u7684\u65B9\u5F0F\u201D\uFF0C\u8FD9\u79CD\u56DE\u7B54\u53EA\u80FD\u7B97\u4F5C\u907F\u91CD\u5C31\u8F7B\u3002\u201C\u5BF9\u771F\u5B9E\u4E16\u754C\u7684\u5EFA\u6A21\u201D\u5230\u5E95\u8981\u5982\u4F55\u8FDB\u884C\uFF1F\u6211\u4EEC\u4E3A\u4EC0\u4E48\u8981\u8FD9\u4E48\u505A\uFF0C\u6709\u4EC0\u4E48\u597D\u5904\uFF1F\u4E5F\u8BB8\u8FD9\u53E5\u8BDD\u610F\u5473\u7740\u662F\u201C\u7531\u4E8E\u91C7\u7528\u9762\u5411\u5BF9\u8C61\u65B9\u5F0F\u6784\u5EFA\u7684\u8F6F\u4EF6\u4E0E\u771F\u5B9E\u4E16\u754C\u7684\u5173\u7CFB\u66F4\u7D27\u5BC6\uFF0C\u6240\u4EE5\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u53EF\u4EE5\u4F7F\u5F97\u8F6F\u4EF6\u5F00\u53D1\u66F4\u5BB9\u6613\u201D\u2014\u2014\u5373\u4F7F\u8FD9\u6837\u8BF4\uFF0C\u4E5F\u4ECD\u7136\u9003\u907F\u4E86\u5173\u952E\u95EE\u9898\u2014\u2014\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u7A76\u7ADF\u662F\u4EC0\u4E48?</p></blockquote><p>Some folks fall back on three magic words to explain the nature of OO: encapsulation, inheritance, and polymorphism. The implication is that OO is the proper admixture of these three things, or at least that an OO language must support these three things.</p><blockquote><p>\u8FD8\u6709\u4E9B\u4EBA\u5728\u56DE\u7B54\u8FD9\u4E2A\u95EE\u9898\u7684\u65F6\u5019\uFF0C\u5F80\u5F80\u4F1A\u642C\u51FA\u4E00\u4E9B\u795E\u79D8\u7684\u8BCD\u8BED\uFF0C\u8B6C\u5982\u5C01\u88C5\uFF08encapsulation\uFF09\u3001\u7EE7\u627F\uFF08inheritance\uFF09\u3001\u591A\u6001\uFF08polymorphism\uFF09\u3002\u5176\u9690\u542B\u610F\u601D\u5C31\u662F\u8BF4\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u662F\u8FD9\u4E09\u9879\u7684\u6709\u673A\u7EC4\u5408\uFF0C\u6216\u8005\u4EFB\u4F55\u4E00\u79CD\u652F\u6301\u9762\u5411\u5BF9\u8C61\u7684\u7F16\u7A0B\u8BED\u8A00\u5FC5\u987B\u652F\u6301\u8FD9\u4E09\u4E2A\u7279\u6027\u3002</p></blockquote><p>Let\u2019s examine each of these concepts in turn.</p><blockquote><p>\u90A3\u4E48\uFF0C\u6211\u4EEC\u63A5\u4E0B\u6765\u53EF\u4EE5\u9010\u4E2A\u6765\u5206\u6790\u4E00\u4E0B\u8FD9\u4E09\u4E2A\u6982\u5FF5\u3002</p></blockquote><h2 id="encapsulation-\u5C01\u88C5" tabindex="-1"><a class="header-anchor" href="#encapsulation-\u5C01\u88C5" aria-hidden="true">#</a> ENCAPSULATION? \u5C01\u88C5</h2><p>The reason encapsulation is cited as part of the definition of OO is that OO languages provide easy and effective encapsulation of data and function. As a result, a line can be drawn around a cohesive set of data and functions. Outside of that line, the data is hidden and only some of the functions are known. We see this concept in action as the private data members and the public member functions of a class.</p><blockquote><p>\u5BFC\u81F4\u5C01\u88C5\u8FD9\u4E2A\u6982\u5FF5\u7ECF\u5E38\u88AB\u5F15\u7528\u4E3A\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u5B9A\u4E49\u7684\u4E00\u90E8\u5206\u3002\u901A\u8FC7\u91C6\u7528\u5C01\u88C5\u7279\u6027\uFF0C\u6211\u4EEC\u53EF\u4EE5\u628A\u4E00\u7EC4\u76F8\u5173\u8054\u7684\u6570\u636E\u548C\u51FD\u6570\u5708\u8D77\u6765\uFF0C\u4FBF\u5708\u5916\u8840\u7684\u4EE3\u7801\u53EA\u80FD\u770B\u89C1\u90E8\u5206\u51FD\u6570\uFF0C\u6570\u636E\u5219\u5B8C\u5168\u4E0D\u53EF\u89C1\u3002\u8B6C\u5982\u5728\u5B9E\u9645\u5E94\u7528\u4E2D\uFF0C\u7C7B\uFF08class\uFF09\u4E2D\u7684\u516C\u5171\u51FD\u6570\u548C\u79C1\u6709\u6210\u5458\u53D8\u91CF\u5C31\u662F\u8FD9\u6837\u3002</p></blockquote><p>This idea is certainly not unique to OO. Indeed, we had perfect encapsulation in C. Consider this simple C program:</p><blockquote><p>\u7136\u800C\uFF0C\u8FD9\u4E2A\u7279\u6027\u5176\u5B9E\u5E76\u4E0D\u662F\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u6240\u72EC\u6709\u7684\u3002\u5176\u5B9E\uFF0Cc \u8BED\u8A00\u4E5F\u652F\u6301\u5B8C\u6574\u7684\u5C01\u88C5\uFF0C\u4E0B\u9762\u6765\u770B\u4E00\u4E2A\u7B80\u5355\u7684 c \u7A0B\u5E8F\uFF1A</p></blockquote><p>point.h</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">Point</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">Point</span><span class="token operator">*</span> <span class="token function">makePoint</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">,</span> <span class="token keyword">double</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> <span class="token function">distance</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Point</span> <span class="token operator">*</span>p1<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">Point</span> <span class="token operator">*</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>point.c</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;point.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;math.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>
  <span class="token keyword">double</span> x<span class="token punctuation">,</span>y<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Point</span><span class="token operator">*</span> <span class="token function">makepoint</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">,</span> <span class="token keyword">double</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">Point</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Point</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  p<span class="token operator">-&gt;</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
  p<span class="token operator">-&gt;</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
  <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">distance</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Point</span><span class="token operator">*</span> p1<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">Point</span><span class="token operator">*</span> p2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">double</span> dx <span class="token operator">=</span> p1<span class="token operator">-&gt;</span>x <span class="token operator">-</span> p2<span class="token operator">-&gt;</span>x<span class="token punctuation">;</span>
  <span class="token keyword">double</span> dy <span class="token operator">=</span> p1<span class="token operator">-&gt;</span>y <span class="token operator">-</span> p2<span class="token operator">-&gt;</span>y<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>dx<span class="token operator">*</span>dx<span class="token operator">+</span>dy<span class="token operator">*</span>dy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The users of point.h have no access whatsoever to the members of struct Point. They can call the makePoint() function, and the distance() function, but they have absolutely no knowledge of the implementation of either the Point data structure or the functions.</p><blockquote><p>\u663E\u7136\uFF0C\u4F7F\u7528 point.h \u7684\u7A0B\u5E8F\u662F\u6CA1\u6709 Point \u7ED3\u6784\u4F53\u6210\u5458\u7684\u8BBF\u95EE\u6743\u9650\u7684\u3002\u5B83\u4EEC\u53EA\u80FD\u8C03\u7528 <code>makePoint()</code> \u51FD\u6570\u548C <code>distance()</code> \u51FD\u6570\uFF0C\u4F46\u5BF9\u5B83\u4EEC\u6765\u8BF4\uFF0CPoint \u8FD9\u4E2A\u6570\u636E\u7ED3\u6784\u4F53\u7684\u5185\u90E8\u7EC6\u8282\uFF0C\u4EE5\u53CA\u51FD\u6570\u7684\u5177\u4F53\u5B9E\u73B0\u65B9\u5F0F\u90FD\u662F\u4E0D\u53EF\u89C1\u7684\u3002</p></blockquote><p>This is perfect encapsulation\u2014in a non-OO language. C programmers used to do this kind of thing all the time. We would forward declare data structures and functions in header files, and then implement them in implementation files. Our users never had access to the elements in those implementation files.</p><blockquote><p>\u8FD9\u6B63\u662F\u5B8C\u7F8E\u5C01\u88C5 \u867D\u7136 C \u8BED\u8A00\u662F\u975E\u9762\u5411\u5BF9\u8C61\u7684\u7F16\u7A0B\u8BED\u8A00\u3002\u4E0A\u8FF0 C \u7A0B\u5E8F\u662F\u5F88\u5E38\u89C1\u7684\u3002\u5728\u5934\u6587\u4EF6\u4E2D\u8FDB\u884C\u6570\u636E\u7ED3\u6784\u4EE5\u53CA\u51FD\u6570\u5B9A\u4E49\u7684\u524D\u7F6E\u58F0\u660E\uFF08forward declare\uFF09\uFF0C\u7136\u540E \u5728\u7A0B\u5E8F\u6587\u4EF6\u4E2D\u5177\u4F53\u5B9E\u73B0\u3002\u7A0B\u5E8F\u6587\u4EF6\u4E2D\u7684\u5177\u4F53\u5B9E\u73B0\u7EC6\u8282\u5BF9\u4F7F\u7528\u8005\u6765\u8BF4\u662F\u4E0D\u53EF\u89C1\u7684\u3002</p></blockquote><p>But then came OO in the form of C++\u2014and the perfect encapsulation of C was broken.</p><blockquote><p>\u800C C++\u4F5C\u4E3A\u4E00\u79CD\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u8BED\u8A00\uFF0C\u53CD\u800C\u7834\u574F\u4E86 c \u7684\u5B8C\u7F8E\u5C01\u88C5\u6027\u3002</p></blockquote><p>The C++ compiler, for technical reasons,1 needed the member variables of a class to be declared in the header file of that class. So our Point program changed to look like this:</p><blockquote><p>\u7531\u4E8E\u4E00\u4E9B\u6280\u672F\u539F\uFF0CC++\u7F16\u8BD1\u5668\u8981\u6C42\u7C7B\u7684\u6210\u5458\u53D8\u91CF\u5FC5\u987B\u5728\u8BE5\u7C7B\u7684\u5934\u6587\u4EF6\u4E2D\u58F0\u660E\u3002\u8FD9\u6837\u4E00\u6765\uFF0C\u6211\u4EEC\u7684 point.h \u7A0B\u5E8F\u968F\u4E4B\u5C31\u6539\u6210\u4E86\u8FD9\u6837\uFF1A</p></blockquote><p>point.h</p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">Point</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">,</span> <span class="token keyword">double</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">double</span> <span class="token function">distance</span><span class="token punctuation">(</span><span class="token keyword">const</span> Point<span class="token operator">&amp;</span> p<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">double</span> x<span class="token punctuation">;</span>
  <span class="token keyword">double</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,30),k={href:"http://point.cc",target:"_blank",rel:"noopener noreferrer"},h=s("point.cc"),m=e(`<div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;point.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;math.h&gt;</span></span>

<span class="token class-name">Point</span><span class="token double-colon punctuation">::</span><span class="token function">Point</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">,</span> <span class="token keyword">double</span> y<span class="token punctuation">)</span>
<span class="token operator">:</span> <span class="token function">x</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">y</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>
<span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token class-name">Point</span><span class="token double-colon punctuation">::</span><span class="token function">distance</span><span class="token punctuation">(</span><span class="token keyword">const</span> Point<span class="token operator">&amp;</span> p<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
  <span class="token keyword">double</span> dx <span class="token operator">=</span> x<span class="token operator">-</span>p<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
  <span class="token keyword">double</span> dy <span class="token operator">=</span> y<span class="token operator">-</span>p<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>dx<span class="token operator">*</span>dx <span class="token operator">+</span> dy<span class="token operator">*</span>dy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),v=s("Clients of the header file point.h know about the member variables x and y! The compiler will prevent access to them, but the client still knows they exist. For example, if those member names are changed, the "),b={href:"http://point.cc",target:"_blank",rel:"noopener noreferrer"},y=s("point.cc"),f=s(" file must be recompiled! Encapsulation has been broken."),g=s("\u597D\u4E86\uFF0Cpoint.h \u6587\u4EF6\u7684\u4F7F\u7528\u8005\u73B0\u5728\u77E5\u9053\u4E86\u6210\u5458\u53D8\u91CF x \u548C y \u7684\u5B58\u5728\uFF01\u867D\u7136\u7F16\u8BD1\u5668\u4F1A\u7981\u6B62\u5BF9\u8FD9\u4E24\u4E2A\u53D8\u91CF\u7684\u76F4\u63A5\u8BBF\u95EE\uFF0C\u4F46\u662F\u4F7F\u7528\u8005\u4ECD\u7136\u77E5\u9053\u4E86\u5B83\u4EEC\u7684\u5B58\u5728\u3002\u800C\u4E14\uFF0C\u5982\u679C x \u548C y \u53D8\u91CF\u540D\u79F0\u88AB\u6539\u53D8\u4E86\uFF0C"),w={href:"http://point.cc",target:"_blank",rel:"noopener noreferrer"},q=s("point.cc"),O=s(" \u4E5F\u5FC5\u987B\u91CD\u65B0\u7F16\u8BD1\u624D\u884C\uFF01\u8FD9\u6837\u7684\u5C01\u88C5\u6027\u663E\u7136\u662F\u4E0D\u5B8C\u7F8E\u7684\u3002"),I=e(`<p>Indeed, the way encapsulation is partially repaired is by introducing the public, private, and protected keywords into the language. This, however, was a hack necessitated by the technical need for the compiler to see those variables in the header file.</p><blockquote><p>\u5F53\u7136\uFF0CC++\u901A\u8FC7\u5728\u7F16\u7A0B\u8BED\u8A00\u5C42\u9762\u5F15\u5165 public\u3001private\u3001protected \u8FD9\u4E9B\u5173\u952E\u8BCD\uFF0C\u90E8\u5206\u7EF4\u62A4\u4E86\u5C01\u88C5\u6027\u3002\u4F46\u6240\u6709\u8FD9\u4E9B\u90FD\u662F\u4E3A\u4E86\u89E3\u51B3\u7F16\u8BD1\u5668\u81EA\u8EAB\u7684\u6280\u672F\u5B9E\u73B0\u95EE\u9898\u800C\u5F15\u5165\u7684 hack\u2014\u2014\u7F16\u8BD1\u5668\u7531\u4E8E\u6280\u672F\u5B9E\u73B0\u539F\u56E0\u5FC5\u987B\u5728\u5934\u6587\u4EF6\u4E2D\u770B\u5230\u6210\u5458\u53D8\u91CF\u7684\u5B9A\u4E49\u3002</p></blockquote><p>Java and C# simply abolished the header/implementation split altogether, thereby weakening encapsulation even more. In these languages, it is impossible to separate the declaration and definition of a class.</p><blockquote><p>\u800C Java \u548C C# \u5219\u5F7B\u5E95\u629B\u5F03\u4E86\u5934\u6587\u4EF6\u4E0E\u5B9E\u73B0\u6587\u4EF6\u5206\u79BB\u7684\u7F16\u7A0B\u65B9\u5F0F\uFF0C\u8FD9\u5176\u5B9E\u8FDB\u4E00\u6B65\u524A\u5F31\u4E86\u5C01\u88C5\u6027\u3002\u56E0\u4E3A\u5728\u8FD9\u4E9B\u8BED\u8A00\u4E2D\uFF0C\u6211\u4EEC\u662F\u65E0\u6CD5\u533A\u5206\u4E00\u4E2A\u7C7B\u7684\u58F0\u660E\u548C\u5B9A\u4E49\u7684\u3002</p></blockquote><p>For these reasons, it is difficult to accept that OO depends on strong encapsulation. Indeed, many OO languages2 have little or no enforced encapsulation.</p><blockquote><p>\u7531\u4E8E\u4E0A\u8FF0\u539F\u56E0\uFF0C\u6211\u4EEC\u5F88\u96BE\u8BF4\u5F3A\u5C01\u88C5\u662F\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u7684\u5FC5\u8981\u6761\u4EF6\u3002\u800C\u4E8B\u5B9E\u4E0A\uFF0C\u6709\u5F88\u591A\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u8BED\u8A00|\u5BF9\u5C01\u88C5\u6027\u5E76\u6CA1\u6709\u5F3A\u5236\u6027\u7684\u8981\u6C42\u3002</p></blockquote><p>OO certainly does depend on the idea that programmers are well-behaved enough to not circumvent encapsulated data. Even so, the languages that claim to provide OO have only weakened the once perfect encapsulation we enjoyed with C.</p><blockquote><p>\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u5728\u5E94\u7528\u4E0A\u786E\u5B9E\u4F1A\u8981\u6C42\u7A0B\u5E8F\u5458\u5C3D\u91CF\u907F\u514D\u7834\u574F\u6570\u636E\u7684\u5C01\u88C5\u6027\u3002\u4F46\u5B9E\u9645\u60C5\u51B5\u662F\uFF0C\u90A3\u4E9B\u58F0\u79F0\u81EA\u5DF1\u63D0\u4F9B\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u652F\u6301\u7684\u7F16\u7A0B\u8BED\u8A00\uFF0C\u76F8\u5BF9\u4E8E C \u8FD9\u79CD\u5B8C\u7F8E\u5C01\u88C5\u7684\u8BED\u8A00\u800C\u8A00\uFF0C\u5176\u5C01\u88C5\u6027\u90FD\u88AB\u524A\u5F31\u4E86\uFF0C\u800C\u4E0D\u662F\u52A0\u5F3A\u4E86\u3002</p></blockquote><h2 id="inheritance-\u7EE7\u627F" tabindex="-1"><a class="header-anchor" href="#inheritance-\u7EE7\u627F" aria-hidden="true">#</a> INHERITANCE? \u7EE7\u627F</h2><p>If OO languages did not give us better encapsulation, then they certainly gave us inheritance.</p><blockquote><p>\u65E2\u7136\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u8BED\u8A00\u5E76\u6CA1\u6709\u63D0\u4F9B\u66F4\u597D\u7684\u5C01\u88C5\u6027\uFF0C\u90A3\u4E48\u5728\u7EE7\u627F\u6027\u65B9\u9762\u53C8\u5982\u4F55\u5462\uFF1F</p></blockquote><p>Well\u2014sort of. Inheritance is simply the redeclaration of a group of variables and functions within an enclosing scope. This is something C programmers3 were able to do manually long before there was an OO language.</p><blockquote><p>\u55EF\uFF0C\u5176\u5B9E\u4E5F\u5C31\u4E00\u822C\u822C\u5427\u3002\u7B80\u800C\u8A00\u4E4B\uFF0C\u7EE7\u627F\u7684\u4E3B\u8981\u4F5C\u7528\u662F\u8BA9\u6211\u4EEC\u53EF\u4EE5\u5728\u67D0\u4E2A\u4F5C\u7528\u57DF\u5185\u5BF9\u5916\u90E8\u5B9A\u4E49\u7684\u67D0\u4E00\u7EC4\u53D8\u91CF\u4E0E\u51FD\u6570\u8FDB\u884C\u8986\u76D6\u3002\u8FD9\u4E8B\u5B9E\u4E0A\u4E5F\u662F c \u7A0B\u5E8F\u5458\u65E9\u5728\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u8BED\u8A00\u53D1\u660E\u4E4B\u524D\u5C31\u4E00\u76F4\u5728\u505A\u7684\u4E8B\u4E86\u3002</p></blockquote><p>Consider this addition to our original point.h C program:</p><blockquote><p>\u4E0B\u9762\uFF0C\u770B\u4E00\u4E0B\u521A\u624D\u7684 C \u7A0B\u5E8F point.h \u7684\u6269\u5C55\u7248\uFF1A</p></blockquote><p>namedPoint.h</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">NamedPoint</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">NamedPoint</span><span class="token operator">*</span> <span class="token function">makeNamedPoint</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">,</span> <span class="token keyword">double</span> y<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">NamedPoint</span><span class="token operator">*</span> np<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">NamedPoint</span><span class="token operator">*</span> np<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>namedPoint.c</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;namedPoint.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">NamedPoint</span> <span class="token punctuation">{</span>
  <span class="token keyword">double</span> x<span class="token punctuation">,</span>y<span class="token punctuation">;</span>
  <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">NamedPoint</span><span class="token operator">*</span> <span class="token function">makeNamedPoint</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">,</span> <span class="token keyword">double</span> y<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">NamedPoint</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">NamedPoint</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  p<span class="token operator">-&gt;</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
  p<span class="token operator">-&gt;</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
  p<span class="token operator">-&gt;</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">NamedPoint</span><span class="token operator">*</span> np<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  np<span class="token operator">-&gt;</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">NamedPoint</span><span class="token operator">*</span> np<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> np<span class="token operator">-&gt;</span>name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>main.c</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;point.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;namedPoint.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> ac<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> av<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">NamedPoint</span><span class="token operator">*</span> origin <span class="token operator">=</span> <span class="token function">makeNamedPoint</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token string">&quot;origin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">NamedPoint</span><span class="token operator">*</span> upperRight <span class="token operator">=</span> <span class="token function">makeNamedPoint</span>  <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token string">&quot;upperRight&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;distance=%f\\n&quot;</span><span class="token punctuation">,</span>
    <span class="token function">distance</span><span class="token punctuation">(</span>
             <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Point</span><span class="token operator">*</span><span class="token punctuation">)</span> origin<span class="token punctuation">,</span>
             <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Point</span><span class="token operator">*</span><span class="token punctuation">)</span> upperRight<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>If you look carefully at the main program, you\u2019ll see that the NamedPoint data structure acts as though it is a derivative of the Point data structure. This is because the order of the first two fields in NamedPoint is the same as Point. In short, NamedPoint can masquerade as Point because NamedPoint is a pure superset of Point and maintains the ordering of the members that correspond to Point.</p><blockquote><p>\u8BF7\u4ED4\u7EC6\u89C2\u5BDF main \u51FD\u6570\uFF0C\u8FD9\u91CC NamedPoint \u6570\u636E\u7ED3\u6784\u662F\u88AB\u5F53\u4F5C Point \u6570\u636E\u7ED3\u6784\u7684\u4E00\u4E2A\u884D\u751F\u4F53\u4F86\u4F7F\u7528\u7684\u3002\u4E4B\u6240\u4EE5\u53EF\u4EE5\u8FD9\u6837\u505A\uFF0C\u662F\u56E0\u4E3A NamedPoint \u7ED3\u6784\u4F53\u7684\u524D\u4E24\u4E2A\u6210\u5458\u7684\u987A\u7528\u4E0E Point \u7ED3\u6784\u4F11\u7684\u5B8C\u5168\u4E00\u81F4\u3002\u7B80\u5355\u6765\u8BF4\uFF0CNamedPoint \u4E4B\u6240\u4EE5\u53EF\u4EE5\u88AB\u4F2A\u88C5\u6210 Point \u6765\u4F7F\u7528\uFF0C\u662F\u56E0\u4E3A NamedPoint \u662F Point \u7ED3\u6784\u4F53\u7684\u4E00\u4E2A\u8D85\u96C6\uFF0C\u540C\u4E24\u8005\u5171\u540C\u6210\u5458\u7684\u987A\u5E8F\u4E5F\u662F\u4E00\u6837\u7684\u3002</p></blockquote><p>This kind of trickery was a common practice4 of programmers prior to the advent of OO. In fact, such trickery is how C++ implements single inheritance.</p><blockquote><p>\u9762\u8FD9\u79CD\u7F16\u7A0B\u65B9\u5F0F\u867D\u7136\u770B\u4E0A\u53BB\u6709\u4E9B\u6295\u673A\u53D6\u5DE7\uFF0C\u4F46\u662F\u5728\u9762\u5411\u5BF9\u8C61\u7406\u8BBA\u88AB\u63D0\u51FA\u4E4B\u524D\uFF0C\u8FD9\u5DF2\u7ECF\u5F88\u5E38\u89C1\u4E86\u3002\u5176\u5B9E\uFF0CC++\u5185\u90E8\u5C31\u662F\u8FD9\u6837\u5B9E\u73B0\u5355\u7EE7\u627F\u7684\u3002</p></blockquote><p>Thus we might say that we had a kind of inheritance long before OO languages were invented. That statement wouldn\u2019t quite be true, though. We had a trick, but it\u2019s not nearly as convenient as true inheritance. Moreover, multiple inheritance is a considerably more difficult to achieve by such trickery.</p><blockquote><p>\u56E0\u6B64\uFF0C\u6211\u4EEC\u53EF\u4EE5\u8BF4\uFF0C\u65E9\u5728\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u8BED\u8A00\u88AB\u53D1\u660E\u4E4B\u524D\uFF0C\u5BF9\u7EE7\u627F\u6027\u7684\u652F\u6301\u5C31\u5DF2\u7ECF\u5B58\u5728\u5F88\u4E45\u4E86\u3002\u5F53\u7136\u4E86\uFF0C\u8FD9\u79CD\u652F\u6301\u7528\u4E86\u4E00\u4E9B\u6295\u673A\u53D6\u5DE7\u7684\u624B\u6BB5\uFF0C\u5E76\u4E0D\u50CF\u5982\u4ECA\u7684\u7EE7\u663C\uFF1A\u6837\u4FBF\u5229\u6613\u7528\uFF0C\u800C\u4E14\uFF0C\u591A\u91CD\u7EE7\u627F\uFF08multiple inheritance\uFF09\u5982\u679C\u8FD8\u60F3\u7528\u8FD9\u79CD\u65B9\u6CD5\u6765\u5B9E\u73B0\uFF0C\u5C31\u66F4\u96BE\u4E86\u3002</p></blockquote><p>Note also that in main.c, I was forced to cast the NamedPoint arguments to Point. In a real OO language, such upcasting would be implicit.</p><blockquote><p>\u540C\u65F6\u5E94\u8BE5\u6CE8\u610F\u7684\u662F\uFF0C\u5728 main.c \u4E2D\uFF0C\u7A0B\u5E8F\u5458\u5FC5\u987B\u5F3A\u5236\u5C06 NamedPoint \u7684\u53C2\u6570\u7C7B\u578B\u8F6C\u6362\u4E3A Point\uFF0C\u800C\u5728\u771F\u6B63\u7684\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u8BED\u8A00\u4E2D\uFF0C\u8FD9\u79CD\u7C7B\u578B\u7684\u5411\u4E0A\u8F6C\u6362\u901A\u5E38\u5E94\u8BE5\u662F\u9690\u6027\u7684\u3002</p></blockquote><p>It\u2019s fair to say that while OO languages did not give us something completely brand new, it did make the masquerading of data structures significantly more convenient.</p><blockquote><p>\u7EFC\u4E0A\u6240\u8FF0\uFF0C\u6211\u4EEC\u53EF\u4EE5\u8BA4\u4E3A\uFF0C\u867D\u7136\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u5728\u7EE7\u627F\u6027\u65B9\u9762\u5E76\u6CA1\u6709\u5F00\u521B\u51FA\u65B0\uFF0C\u4F46\u662F\u7684\u786E\u5728\u6570\u636E\u7ED3\u6784\u7684\u4F2A\u88C5\u6027\u4E0A\u63D0\u4F9B\u4E86\u76F8\u5F53\u7A0B\u5EA6\u7684\u4FBF\u5229\u6027\u3002</p></blockquote><p>To recap: We can award no point to OO for encapsulation, and perhaps a half-point for inheritance. So far, that\u2019s not such a great score.</p><blockquote><p>\u56DE\u987E\u4E00\u4E0B\u5230\u76EE\u524D\u4E3A\u6B62\u7684\u5206\u6790\uFF0C\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u5728\u5C01\u88C5\u6027\u4E0A\u5F97 0 \u5206\uFF0C\u5728\u7EE7\u627F\u6027\u4E0A\u52C9\u5F3A\u53EF\u4EE5\u5F97 0.5 \u5206\uFF08\u6EE1\u5206\u4E3A 1)\u3002</p></blockquote><p>But there\u2019s one more attribute to consider.</p><blockquote><p>\u4E0B\u9762\uFF0C\u6211\u4EEC\u8FD8\u6709\u6700\u540E\u4E00\u4E2A\u7279\u6027\u8981\u8BA8\u8BBA\u3002</p></blockquote><h2 id="polymorphism-\u591A\u6001" tabindex="-1"><a class="header-anchor" href="#polymorphism-\u591A\u6001" aria-hidden="true">#</a> POLYMORPHISM? \u591A\u6001</h2><p>Did we have polymorphic behavior before OO languages? Of course we did. Consider this simple C copy program.</p><blockquote><p>\u5728\u9762\u5411\u7F16\u7A0B\u5BF9\u8C61\u8BED\u8A00\u88AB\u53D1\u660E\u4E4B\u524D\uFF0C\u6211\u4EEC\u6240\u4F7F\u7528\u7684\u7F16\u7A0B\u8BED\u8A00\u80FD\u652F\u6301\u591A\u6001\u5417? \u7B54\u6848\u662F\u80AF\u5B9A\u7684\uFF0C\u8BF7\u6CE8\u610F\u770B\u4E0B\u9762\u8FD9\u6BB5\u7528 C \u8BED\u8A00\u7F16\u5199\u7684 copy \u7A0B\u5E8F\uFF1A</p></blockquote><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> c<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c<span class="token operator">=</span><span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
    <span class="token function">putchar</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The function getchar() reads from STDIN. But which device is STDIN? The putchar() function writes to STDOUT. But which device is that? These functions are polymorphic\u2014their behavior depends on the type of STDIN and STDOUT.</p><blockquote><p>\u5728\u4E0A\u8FF0\u7A0B\u5E8F\u4E2D\uFF0C\u51FD\u6570 <code>getchar()</code> \u4E3B\u8981\u8D1F\u8D23\u4ECE STDTN \u4E2D\u8BFB\u53D6\u6570\u636E\u3002\u4F46\u662F STDLLN \u7A76\u7ADF\u6307\u4EE3\u7684\u662F\u54EA\u4E2A\u8BBE\u5907\u5462\uFF1F\u540C\u6837\u7684\u9053\u7406\uFF0C<code>putchar()</code> \u4E3B\u8981\u8D1F\u8D23\u5C06\u6570\u636E\u5199\u5165 STDOUT\uFF0C\u800C STDOUT \u53C8\u6307\u4EE3\u7684\u662F\u54EA\u4E2A\u8BBE\u5907\u5462\uFF1F\u5F88\u663E\u7136\uFF0C\u8FD9\u7C7B\u51FD\u6570\u5176\u5B9E\u5C31\u5177\u6709\u591A\u6001\u6027\uFF0C\u56E0\u4E3A\u5B83\u4EEC\u7684\u884C\u4E3A\u4F9D\u8D56\u4E8E STDIN \u548C STDOUT \u7684\u5177\u4F53\u7C7B\u578B\u3002</p></blockquote><p>It\u2019s as though STDIN and STDOUT are Java-style interfaces that have implementations for each device. Of course, there are no interfaces in the example C program\u2014so how does the call to getchar() actually get delivered to the device driver that reads the character?</p><blockquote><p>\u8FD9\u91CC\u7684 STDIN \u548C STDOUT \u4E0E Java \u4E2D\u7684\u63A5\u53E3\u7C7B\u4F3C\uFF0C\u5404\u79CD\u8BBE\u5907\u90FD\u6709\u5404\u81EA\u7684\u5B9E\u73B0\u3002\u5F53\u7136\uFF0C\u8FD9\u4E2A C \u7A0B\u5E8F\u4E2D\u662F\u6CA1\u6709\u63A5\u53E3\u8FD9\u4E2A\u6982\u5FF5\u7684\uFF0C\u90A3\u4E48 <code>getchar()</code> \u8FD9\u4E2A\u8C03\u7528\u7684\u52A8\u4F5C\u662F \u5982\u4F55\u771F\u6B63\u4F20\u9012\u5230\u8BBE\u5907\u9A71\u52A8\u7A0B\u5E8F\u4E2D\uFF0C\u4ECE\u800C\u8BFB\u53D6\u5230\u5177\u4F53\u5185\u5BB9\u7684\u5462\uFF1F</p></blockquote><p>The answer to that question is pretty straightforward. The UNIX operating system requires that every IO device driver provide five standard functions:5 open, close, read, write, and seek. The signatures of those functions must be identical for every IO driver.</p><blockquote><p>\u5176\u5B9E\u5F88\u7B80\u5355\uFF0CUNIX \u64CD\u4F5C\u7CFB\u7EDF\u5F3A\u5236\u8981\u6C42\u6BCF\u4E2A IO \u8BBE\u5907\u90FD\u8981\u63D0\u4F9B open\u3001close\u3001read\u3001write \u548C seek \u8FD9 5 \u4E2A\u6807\u51C6\u51FD\u6570\u3002\u4E5F\u5C31\u662F\u8BF4\uFF0C\u6BCF\u4E2A IO \u8BBE\u5907\u9A71\u52A8\u7A0B\u5E8F\u5BF9\u8FD9 5 \u79CD\u51FD\u6570\u7684\u5B9E\u73B0\u5728\u51FD\u6570\u8C03\u7528\u4E0A\u5FC5\u987B\u4FDD\u6301\u4E00\u81F4\u3002</p></blockquote><p>The FILE data structure contains five pointers to functions. In our example, it might look like this:</p><blockquote><p>\u9996\u5148\uFF0CFILE \u6570\u636E\u7ED3\u6784\u4F53\u4E2D\u5305\u542B\u4E86\u76F8\u5BF9\u5E94\u7684 5 \u4E2A\u51FD\u6570\u6307\u9488\uFF0C\u5206\u522B\u7528\u4E8E\u6307\u5411\u8FD9\u4E9B\u51FD\u6570\uFF1A</p></blockquote><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">FILE</span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>open<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>close<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>read<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>write<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>seek<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">long</span> index<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The IO driver for the console will define those functions and load up a FILE data structure with their addresses\u2014something like this:</p><blockquote><p>\u7136\u540E\uFF0C\u8B6C\u5982\u63A7\u5236\u53F0\u8BBE\u5907\u7684 IO \u9A71\u52A8\u7A0B\u5E8F\u5C31\u4F1A\u63D0\u4F9B\u8FD9 5 \u4E2A\u51FD\u6570\u7684\u5B9E\u9645\u5B9A\u4E49\uFF0C\u5C06 FILE \u7ED3\u6784\u4F53\u7684\u51FD\u6570\u6307\u9488\u6307\u5411\u8FD9\u4E9B\u5BF9\u5E94\u7684\u5B9E\u73B0\u51FD\u6570\uFF1A</p></blockquote><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;file.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">int</span> c<span class="token punctuation">;</span><span class="token comment">/*...*/</span> <span class="token keyword">return</span> c<span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">seek</span><span class="token punctuation">(</span><span class="token keyword">long</span> index<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">FILE</span> console <span class="token operator">=</span> <span class="token punctuation">{</span>open<span class="token punctuation">,</span> close<span class="token punctuation">,</span> read<span class="token punctuation">,</span> write<span class="token punctuation">,</span> seek<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now if STDIN is defined as a <code>FILE*</code>, and if it points to the console data structure, then getchar() might be implemented this way:</p><blockquote><p>\u73B0\u5728\uFF0C\u5982\u679C STDIN \u7684\u5B9A\u4E49\u662F <code>FILE*</code>\uFF0C\u5E76\u540C\u65F6\u6307\u5411\u4E86 console \u8FD9\u4E2A\u6570\u636E\u7ED3\u6784\uFF0C\u90A3\u4E48 <code>getchar()</code> \u7684\u5B9E\u73B0\u65B9\u5F0F\u5C31\u662F\u8FD9\u6837\u7684\uFF1A</p></blockquote><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">extern</span> <span class="token keyword">struct</span> <span class="token class-name">FILE</span><span class="token operator">*</span> STDIN<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> STDIN<span class="token operator">-&gt;</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>In other words, getchar() simply calls the function pointed to by the read pointer of the FILE data structure pointed to by STDIN.</p><blockquote><p>\u6362\u53E5\u8BDD\u8BF4\uFF0C<code>getchar()</code> \u53EA\u662F\u8C03\u7528\u4E86 STDIN \u6240\u6307\u5411\u7684 FIL E \u6570\u636E\u7ED3\u6784\u4F53\u4E2D\u7684 read \u51FD\u6570\u6307\u9488\u6307\u5411\u7684\u51FD\u6570\u3002</p></blockquote><p>This simple trick is the basis for all polymorphism in OO. In C++, for example, every virtual function within a class has a pointer in a table called a vtable, and all calls to virtual functions go through that table. Constructors of derivatives simply load their versions of those functions into the vtable of the object being created.</p><blockquote><p>\u8FD9\u4E2A\u7B80\u5355\u7684\u7F16\u7A0B\u6280\u5DE7\u6B63\u662F\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u4E2D\u591A\u6001\u7684\u57FA\u7840\u3002\u4F8B\u5982\u5728 C++\u4E2D\uFF0C\u7C7B\u4E2D\u7684\u6BCF\u4E2A\u865A\u51FD\u6570\uFF08virtual function\uFF09\u7684\u5730\u5740\u90FD\u88AB\u8BB0\u5F55\u5728\u4E00\u4E2A\u540D\u53EB vtable \u7684\u6570\u636E\u7ED3\u6784\u91CC\u3002\u6211\u4EEC\u5BF9\u865A\u51FD\u6570\u7684\u6BCF\u6B21\u8C03\u7528\u90FD\u8981\u5148\u67E5\u8BE2\u8FD9\u4E2A\u8868\uFF0C\u5176\u884D\u751F\u7C7B\u7684\u6784\u9020\u51FD\u6570\u8D1F\u8D23\u5C06\u8BE5\u884D\u751F\u7C7B\u7684\u865A\u51FD\u6570\u5730\u5740\u52A0\u8F7D\u5230\u6574\u4E2A\u5BF9\u8C61\u7684 vtable \u4E2D\u3002</p></blockquote><p>The bottom line is that polymorphism is an application of pointers to functions. Programmers have been using pointers to functions to achieve polymorphic behavior since Von Neumann architectures were first implemented in the late 1940s. In other words, OO has provided nothing new.</p><blockquote><p>\u5F52\u6839\u7ED3\u5E95\uFF0C\u591A\u6001\u5176\u5B9E\u4E0D\u8FC7\u5C31\u662F\u51FD\u6570\u6307\u9488\u7684\u4E00\u79CD\u5E94\u7528\u3002\u81EA\u4ECE 20 \u4E16\u7EAA 40 \u5E74\u4EE3\u672B\u671F\u51AF\xB7\u8BFA\u4F9D\u66FC\u67B6\u6784\u8BDE\u751F\u90A3\u5929\u8D77\uFF0C\u7A0B\u5E8F\u5458\u4EEC\u5C31\u4E00\u76F4\u5728\u4F7F\u7528\u51FD\u6570\u6307\u9488\u6A21\u62DF\u591A\u6001\u4E86\u3002\u4E5F\u5C31\u662F\u8BF4\uFF0C\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u5728\u591A\u6001\u65B9\u9762\u6CA1\u6709\u63D0\u51FA\u4EFB\u4F55\u65B0\u6982\u5FF5\u3002</p></blockquote><p>Ah, but that\u2019s not quite correct. OO languages may not have given us polymorphism, but they have made it much safer and much more convenient.</p><blockquote><p>\u5F53\u7136\u4E86\uFF0C\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u8BED\u8A00\u867D\u7136\u5728\u591A\u6001\u4E0A\u5E76\u6CA1\u6709\u7406\u8BBA\u521B\u65B0\uFF0C\u4F46\u5B83\u4EEC\u4E5F\u786E\u5B9E\u8BA9\u591A\u6001\u53D8\u5F97\u66F4\u5B89\u5168\u3001\u66F4\u4FBF\u4E8E\u4F7F\u7528\u4E86\u3002</p></blockquote><p>The problem with explicitly using pointers to functions to create polymorphic behavior is that pointers to functions are dangerous. Such use is driven by a set of manual conventions. You have to remember to follow the convention to initialize those pointers. You have to remember to follow the convention to call all your functions through those pointers. If any programmer fails to remember these conventions, the resulting bug can be devilishly hard to track down and eliminate.</p><blockquote><p>\u7528\u51FD\u6570\u6307\u9488\u663E\u5F0F\u5B9E\u73B0\u591A\u6001\u7684\u95EE\u9898\u5C31\u5728\u4E8E\u51FD\u6570\u6307\u9488\u7684\u5371\u9669\u6027\u3002\u6BD5\u7ADF\uFF0C\u51FD\u6570\u6307\u9488\u7684\u8C03\u7528\u4F9D\u8D56\u4E8E\u4E00\u7CFB\u5217\u9700\u8981\u4EBA\u4E3A\u9075\u5B88\u7684\u7EA6\u5B9A\u3002\u7A0B\u5E8F\u5458\u5FC5\u987B\u4E25\u683C\u6309\u7167\u56FA\u5B9A\u7EA6\u5B9A\u6765\u521D\u59CB\u5316\u51FD\u6570\u6307\u9488\uFF0C\u5E76\u540C\u6837\u4E25\u683C\u5730\u6309\u7167\u7EA6\u5B9A\u6765\u8C03\u7528\u8FD9\u4E9B\u6307\u9488\u3002\u53EA\u8981\u6709\u4E00\u4E2A\u7A0B\u5E8F\u5458\u6CA1\u6709\u9075\u5B88\u8FD9\u4E9B\u7EA6\u5B9A\uFF0C\u6574\u4E2A\u7A0B\u5E8F\u5C31\u4F1A\u4EA7\u751F\u6781\u5176\u96BE\u4EE5\u8DDF\u8E2A\u548C\u6D88\u9664\u7684 Bug\u3002</p></blockquote><p>OO languages eliminate these conventions and, therefore, these dangers. Using an OO language makes polymorphism trivial. That fact provides an enormous power that old C programmers could only dream of. On this basis, we can conclude that OO imposes discipline on indirect transfer of control.</p><blockquote><p>\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u8BED\u8A00\u4E3A\u6211\u4EEC\u6D88\u9664\u4EBA\u5DE5\u9075\u5B88\u8FD9\u4E9B\u7EA6\u5B9A\u7684\u5FC5\u8981\uFF0C\u4E5F\u5C31\u7B49\u4E8E\u6D88\u9664\u4E86\u8FD9\u65B9\u9762\u7684\u5371\u9669\u6027\u3002\u91C7\u7528\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u8BED\u8A00\u8BA9\u591A\u6001\u5B9E\u73B0\u53D8\u5F97\u975E\u5E38\u7B80\u5355\uFF0C\u8BA9\u4E00\u4E2A\u4F20\u7EDF C \u7A0B\u5E8F\u5458\u53EF\u4EE5\u53BB\u505A\u4EE5\u524D\u4E0D\u6562\u60F3\u7684\u4E8B\u60C5\u3002\u7EFC\u4E0A\u6240\u8FF0\uFF0C\u6211\u4EEC\u8BA4\u4E3A\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u5176\u5B9E\u662F\u5BF9\u7A0B\u5E8F\u95F4\u63A5\u63A7\u5236\u6743\u7684\u8F6C\u79FB\u8FDB\u884C\u4E86\u7EA6\u675F\u3002</p></blockquote><h3 id="the-power-of-polymorphism-\u591A\u6001\u7684\u5F3A\u5927\u6027" tabindex="-1"><a class="header-anchor" href="#the-power-of-polymorphism-\u591A\u6001\u7684\u5F3A\u5927\u6027" aria-hidden="true">#</a> THE POWER OF POLYMORPHISM \u591A\u6001\u7684\u5F3A\u5927\u6027</h3><p>What\u2019s so great about polymorphism? To better appreciate its charms, let\u2019s reconsider the example copy program. What happens to that program if a new IO device is created? Suppose we want to use the copy program to copy data from a handwriting recognition device to a speech synthesizer device: How do we need to change the copy program to get it to work with those new devices?</p><blockquote><p>\u90A3\u4E48\u591A\u6001\u7684\u4F18\u52BF\u5728\u54EA\u91CC\u5462\uFF1F\u4E3A\u4E86\u8BA9\u8BFB\u8005\u66F4\u597D\u5730\u7406\u89E3\u591A\u6001\u7684\u597D\u5904\uFF0C\u6211\u4EEC\u9700\u8981\u518D\u6765\u770B\u4E00\u4E0B\u521A\u624D\u7684 copy \u7A0B\u5E8F\u3002\u5982\u679C\u8981\u652F\u6301\u65B0\u7684 IO \u8BBE\u5907\uFF0C\u8BE5\u7A0B\u5E8F\u9700\u8981\u505A\u4EC0\u4E48\u6539\u52A8\u5462\uFF1F\u8B6C\u5982\uFF0C\u5047\u8BBE\u6211\u4EEC\u60F3\u8981\u7528\u8BE5 copy \u7A0B\u5E8F\u4ECE\u4E00\u4E2A\u624B\u5199\u8BC6\u522B\u8BBE\u5907\u5C06\u6570\u636E\u590D\u5236\u5230\u53E6\u4E00\u4E2A\u8BED\u97F3\u5408\u6210\u8BBE\u5907\u4E2D\uFF0C\u6211\u4EEC\u9700\u8981\u9488\u5BF9 copy \u7A0B\u5E8F\u505A\u4EC0\u4E48\u6539\u52A8\uFF0C\u624D\u80FD\u5B9E\u73B0\u8FD9\u4E2A\u76EE\u6807\u5462\uFF1F</p></blockquote><p>We don\u2019t need any changes at all! Indeed, we don\u2019t even need to recompile the copy program. Why? Because the source code of the copy program does not depend on the source code of the IO drivers. As long as those IO drivers implement the five standard functions defined by FILE, the copy program will be happy to use them.</p><blockquote><p>\u7B54\u6848\u662F\u5B8C\u5168\u4E0D\u9700\u8981\u505A\u4EFB\u4F55\u6539\u52A8\uFF01\u786E\u5B9E\uFF0C\u6211\u4EEC\u751A\u81F3\u4E0D\u9700\u8981\u91CD\u65B0\u7F16\u8BD1\u8BE5 copy \u7A0B\u5E8F\u3002\u4E3A\u4EC0\u4E48\uFF1F\u56E0\u4E3A copy \u7A0B\u5E8F\u7684\u6E90\u4EE3\u7801\u5E76\u4E0D\u4F9D\u8D56\u4E8E IO \u8BBE\u5907\u9A71\u52A8\u7A0B\u5E8F\u7684\u4EE3\u7801\u3002\u53EA\u8981 IO \u8BBE\u5907\u9A71\u52A8\u7A0B\u5E8F\u5B9E\u73B0\u4E86 FILE \u7ED3\u6784\u4F53\u4E2D\u5B9A\u4E49\u7684 5 \u4E2A\u6807\u51C6\u51FD\u6570\uFF0C\u8BE5 copy \u7A0B\u5E8F\u5C31\u53EF\u4EE5\u6B63\u5E38\u4F7F\u7528\u5B83\u4EEC\u3002</p></blockquote><p>In short, the IO devices have become plugins to the copy program.</p><blockquote><p>\u7B80\u5355\u6765\u8BF4\uFF0CIO \u8BBE\u5907\u53D8\u6210\u4E86 copy \u7A0B\u5E8F\u7684\u63D2\u4EF6\u3002</p></blockquote><p>Why did the UNIX operating system make IO devices plugins? Because we learned, in the late 1950s, that our programs should be device independent. Why? Because we wrote lots of programs that were device dependent, only to discover that we really wanted those programs to do the same job but use a different device.</p><blockquote><p>\u4E3A\u4EC0\u4E48 UNIX \u64CD\u4F5C\u7CFB\u7EDF\u4F1A\u5C06 IO \u8BBE\u5907\u8BBE\u8BA1\u6210\u63D2\u4EF6\u5F62\u5F0F\u5462\uFF1F\u56E0\u4E3A\u81EA 20 \u4E16\u7EAA 50 \u5E74\u4EE3\u672B\u671F\u4EE5\u6765\uFF0C\u6211\u4EEC\u5B66\u5230\u4E86\u4E00\u4E2A\u91CD\u8981\u7ECF\u9A8C\uFF1A\u7A0B\u5E8F\u5E94\u8BE5\u4E0E\u8BBE\u5907\u65E0\u5173\u3002\u8FD9\u4E2A\u7ECF\u9A8C\u4ECE\u4F55\u800C\u6765\u5462\uFF1F\u56E0\u4E3A\u4E00\u5EA6\u6240\u6709\u7A0B\u5E8F\u90FD\u662F\u8BBE\u5907\u76F8\u5173\u7684\uFF0C\u4F46\u662F\u540E\u6765\u6211\u4EEC\u53D1\u73B0\u81EA\u5DF1\u5176\u5B9E\u771F\u6B63\u9700\u8981\u7684\u662F\u5728\u4E0D\u540C\u7684\u8BBE\u5907\u4E0A\u5B9E\u73B0\u540C\u6837\u7684\u529F\u80FD\u3002</p></blockquote><p>For example, we often wrote programs that read input data from decks of cards,6 and then punched new decks of cards as output. Later, our customers stopped giving us decks of cards and started giving us reels of magnetic tape. This was very inconvenient, because it meant rewriting large portions of the original program. It would be very convenient if the same program worked interchangeably with cards or tape.</p><blockquote><p>\u4F8B\u5982\uFF0C\u6211\u4EEC\u66FE\u7ECF\u5199\u8FC7\u4E00\u4E9B\u7A0B\u5E8F\uFF0C\u9700\u8981\u4ECE\u5361\u7247\u76D2\u4E2D\u7684\u6253\u5B54\u5361\u7247\u8BFB\u53D6\u6570\u636E\uFF0C\u540C\u65F6\u8981\u901A\u8FC7\u5728\u65B0\u7684\u5361\u7247\u4E0A\u6253\u5B54\u6765\u8F93\u51FA\u6570\u636E\u3002\u540E\u6765\uFF0C\u5BA2\u6237\u4E0D\u518D\u4F7F\u7528\u6253\u5B54\u5361\u7247\uFF0C\u800C\u5F00\u59CB\u4F7F\u7528\u78C1\u5E26\u5377\u4E86\u3002\u8FD9\u5C31\u7ED9\u6211\u4EEC\u5E26\u6765\u4E86\u5F88\u591A\u9EBB\u70E6\uFF0C\u5F88\u591A\u7A0B\u5E8F\u90FD\u9700\u8981\u91CD\u5199\u3002\u4E8E\u662F\u6211\u4EEC\u5C31\u4F1A\u60F3\uFF0C\u5982\u679C\u8FD9\u6BB5\u7A0B\u5E8F\u53EF\u4EE5\u540C\u65F6\u64CD\u4F5C\u6253\u5B54\u5361\u7247\u548C\u78C1\u5E26\u90A3\u8BE5\u591A\u597D\u3002</p></blockquote><p>The plugin architecture was invented to support this kind of IO device independence, and has been implemented in almost every operating system since its introduction. Even so, most programmers did not extend the idea to their own programs, because using pointers to functions was dangerous.</p><blockquote><p>\u63D2\u4EF6\u5F0F\u67B6\u6784\u5C31\u662F\u4E3A\u4E86\u652F\u6301\u8FD9\u79CD IO \u4E0D\u76F8\u5173\u6027\u800C\u53D1\u660E\u7684\uFF0C\u5B83\u51E0\u4E4E\u5728\u968F\u540E\u7684\u6240\u6709\u7CFB\u7EDF\u4E2D\u90FD\u6709\u5E94\u7528\u3002\u4F46\u5373\u4F7F\u591A\u6001\u6709\u5982\u6B64\u591A\u4F18\u70B9\uFF0C\u5927\u90E8\u5206\u7A0B\u5E8F\u5458\u8FD8\u662F\u6CA1\u6709\u5C06\u63D2\u4EF6\u7279\u6027\u5F15\u5165\u4ED6\u4EEC\u81EA\u5DF1\u7684\u7A0B\u5E8F\u4E2D\uFF0C\u56E0\u4E3A\u51FD\u6570\u6307\u9488\u5B9E\u5728\u662F\u592A\u5371\u9669\u4E86\u3002</p></blockquote><p>OO allows the plugin architecture to be used anywhere, for anything.</p><blockquote><p>\u800C\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u7684\u51FA\u73B0\u4F7F\u5F97\u8FD9\u79CD\u63D2\u4EF6\u5F0F\u67B6\u6784\u53EF\u4EE5\u5728\u4EFB\u4F55\u5730\u65B9\u88AB\u5B89\u5168\u5730\u4F7F\u7528\u3002</p></blockquote><h3 id="dependency-inversion-\u4F9D\u8D56\u53CD\u8F6C" tabindex="-1"><a class="header-anchor" href="#dependency-inversion-\u4F9D\u8D56\u53CD\u8F6C" aria-hidden="true">#</a> DEPENDENCY INVERSION \u4F9D\u8D56\u53CD\u8F6C</h3><p>Imagine what software was like before a safe and convenient mechanism for polymorphism was available. In the typical calling tree, main functions called high-level functions, which called mid-level functions, which called low-level functions. In that calling tree, however, source code dependencies inexorably followed the flow of control (Figure 5.1).</p><blockquote><p>\u6211\u4EEC\u53EF\u4EE5\u60F3\u8C61\u4E00\u4E0B\u5728\u5B89\u5168\u548C\u4FBF\u5229\u7684\u591A\u6001\u652F\u6301\u51FA\u73B0\u4E4B\u524D\uFF0C\u8F6F\u4EF6\u662F\u4EC0\u4E48\u6837\u5B50\u7684\u3002\u4E0B\u9762\u6709\u4E00\u4E2A\u5178\u578B\u7684\u8C03\u7528\u6811\u7684\u4F8B\u5B50\uFF0Cmain \u51FD\u6570\u8C03\u7528\u4E86\u4E00\u4E9B\u9AD8\u5C42\u51FD\u6570\uFF0C\u8FD9\u4E9B\u9AD8\u5C42\u51FD\u6570\u53C8\u8C03\u7528\u4E86\u4E00\u4E9B\u4E2D\u5C42\u51FD\u6570\uFF0C\u8FD9\u4E9B\u4E2D\u5C42\u51FD\u6570\u53C8\u7EE7\u7EED\u8C03\u7528\u4E86\u4E00\u4E9B\u5E95\u5C42\u51FD\u6570\u3002\u5728\u8FD9\u91CC\uFF0C\u6E90\u4EE3\u7801\u9762\u7684\u4F9D\u8D56\u4E0D\u53EF\u907F\u514D\u5730\u8981\u8DDF\u968F\u7A0B\u5E8F\u7684\u63A7\u5236\u6D41\uFF08\u8BE6\u89C1\u56FE 5.1\uFF09\u3002</p></blockquote>`,84),T=s("Source code dependencies versus flow of control"),P=n("p",null,"For mainq1w2e3r4 to call one of the high-level functions, it had to mention the name of the module that contained that function In C, this was a #include. In Java, it was an import statement. In C#, it was a using statement. Indeed, every caller was forced to mention the name of the module that contained the callee.",-1),N=n("blockquote",null,[n("p",null,"\u5982\u4F60\u6240\u89C1\uFF0Cmain \u51FD\u6570\u4E3A\u4E86\u8C03\u7528\u9AD8\u5C42\u51FD\u6570\uFF0C\u5B83\u5C31\u5FC5\u987B\u80FD\u591F\u770B\u5230\u8FD9\u4E2A\u51FD\u6570\u6240\u5728\u6A21\u5757\u3002\u5728 C \u4E2D\uFF0C\u6211\u4EEC\u4F1A\u901A\u8FC7 #include \u6765\u5B9E\u73B0\uFF0C\u5728 Java \u4E2D\u5219\u901A\u8FC7 import \u6765\u5B9E\u73B0\uFF0C\u800C\u5728 C# \u4E2D\u5219\u7528\u7684\u662F using \u8BED\u53E5\u3002\u603B\u4E4B\uFF0C\u6BCF\u4E2A\u51FD\u6570\u7684\u8C03\u7528\u65B9\u90FD\u5FC5\u987B\u8981\u5F15\u7528\u88AB\u8C03\u7528\u65B9\u6240\u5728\u7684\u6A21\u5757\u3002")],-1),x=n("p",null,"This requirement presented the software architect with few, if any, options. The flow of control was dictated by the behavior of the system, and the source code dependencies were dictated by that flow of control.",-1),_=n("blockquote",null,[n("p",null,"\u663E\u7136\uFF0C\u8FD9\u6837\u505A\u5C31\u5BFC\u81F4\u4E86\u6211\u4EEC\u5728\u8F6F\u4EF6\u67B6\u6784\u4E0A\u522B\u65E0\u9009\u62E9\u3002\u5728\u8FD9\u91CC\uFF0C\u7CFB\u7EDF\u884C\u4E3A\u51B3\u5B9A\u4E86\u63A7\u5236\u6D41\uFF0C\u800C\u63A7\u5236\u6D41\u5219\u51B3\u5B9A\u4E86\u6E90\u4EE3\u7801\u4F9D\u8D56\u5173\u7CFB\u3002")],-1),C=n("p",null,"When polymorphism is brought into play, however, something very different can happen (Figure 5.2).",-1),L=n("blockquote",null,[n("p",null,"\u4F46\u4E00\u65E6\u6211\u4EEC\u4F7F\u7528\u4E86\u591A\u6001\uFF0C\u60C5\u51B5\u5C31\u4E0D\u4E00\u6837\u4E86\uFF08\u8BE6\u89C1\u56FE 5.2\uFF09\u3002")],-1),S=s("Dependency inversion"),E=e("<p>In Figure 5.2, module HL1 calls the F() function in module ML1. The fact that it calls this function through an interface is a source code contrivance. At runtime, the interface doesn\u2019t exist. HL1 simply calls F() within ML1.7</p><blockquote><p>\u5728\u56FE 5.2 \u4E2D\uFF0C\u6A21\u5757 HL1 \u8C03\u7528\u4E86 ML1 \u6A21\u5757\u4E2D\u7684 F() \u51FD\u6570\uFF0C\u8FD9\u91CC\u7684\u8C03\u7528\u662F\u901A\u8FC7\u6E90\u4EE3\u7801\u7EA7\u522B\u7684\u63A5\u53E3\u6765\u5B9E\u73B0\u7684\u3002\u5F53\u7136\u5728\u7A0B\u5E8F\u5B9E\u9645\u8FD0\u884C\u65F6\uFF0C\u63A5\u53E3\u8FD9\u4E2A\u6982\u5FF5\u662F\u4E0D\u5B58\u5728\u7684\uFF0CHL1 \u4F1A\u8C03\u7528 ML1 \u4E2D\u7684 F() \u51FD\u6570\u3002</p></blockquote><p>Note, however, that the source code dependency (the inheritance relationship) between ML1 and the interface I points in the opposite direction compared to the flow of control. This is called dependency inversion, and its implications for the software architect are profound.</p><blockquote><p>\u8BF7\u6CE8\u610F\u6A21\u5757 ML1 \u548C\u63A5\u53E3 I \u5728\u6E90\u4EE3\u7801\u4E0A\u7684\u4F9D\u8D56\u5173\u7CFB\uFF08\u6216\u8005\u53EB\u7EE7\u627F\u5173\u7CFB\uFF09\uFF0C\u8BE5\u5173\u7CFB\u7684\u65B9\u5411\u548C\u63A7\u5236\u6D41\u6B63\u597D\u662F\u76F8\u53CD\u7684\uFF0C\u6211\u4EEC\u79F0\u4E4B\u4E3A\u4F9D\u8D56\u53CD\u8F6C\u3002\u8FD9\u79CD\u53CD\u8F6C\u5BF9\u8F6F\u4EF6\u67B6\u6784\u8BBE\u8BA1\u7684\u5F71\u54CD\u662F\u975E\u5E38\u5927\u7684\u3002</p></blockquote><p>The fact that OO languages provide safe and convenient polymorphism means that any source code dependency, no matter where it is, can be inverted.</p><blockquote><p>\u4E8B\u5B9E\u4E0A\uFF0C\u901A\u8FC7\u5229\u7528\u9762\u5411\u7F16\u7A0B\u8BED\u8A00\u6240\u63D0\u4F9B\u7684\u8FD9\u79CD\u5B89\u5168\u4FBF\u5229\u7684\u591A\u6001\u5B9E\u73B0\uFF0C\u65E0\u8BBA\u6211\u4EEC\u9762\u5BF9\u600E\u6837\u7684\u6E90\u4EE3\u7801\u7EA7\u522B\u7684\u4F9D\u8D56\u5173\u7CFB\uFF0C\u90FD\u53EF\u4EE5\u5C06\u5176\u53CD\u8F6C\u3002</p></blockquote><p>Now look back at that calling tree in Figure 5.1, and its many source code dependencies. Any of those source code dependencies can be turned around by inserting an interface between them.</p><blockquote><p>\u73B0\u5728\uFF0C\u6211\u4EEC\u53EF\u4EE5\u518D\u56DE\u5934\u6765\u770B\u56FE 5.1 \u4E2D\u7684\u8C03\u7528\u6811\uFF0C\u5C31\u4F1A\u53D1\u73B0\u5176\u4E2D\u7684\u4F17\u591A\u6E90\u4EE3\u7801\u4F9D\u8D56\u5173\u7CFB\u90FD\u53EF\u4EE5\u901A\u8FC7\u5F15\u5165\u63A5\u53E3\u7684\u65B9\u5F0F\u6765\u8FDB\u884C\u53CD\u8F6C\u3002</p></blockquote><p>With this approach, software architects working in systems written in OO languages have absolute control over the direction of all source code dependencies in the system. They are not constrained to align those dependencies with the flow of control. No matter which module does the calling and which module is called, the software architect can point the source code dependency in either direction.</p><blockquote><p>\u901A\u8FC7\u8FD9\u79CD\u65B9\u6CD5\uFF0C\u8F6F\u4EF6\u67B6\u6784\u5E08\u53EF\u4EE5\u5B8C\u5168\u63A7\u5236\u91C7\u7528\u4E86\u9762\u5411\u5BF9\u8C61\u8FD9\u79CD\u7F16\u7A0B\u65B9\u5F0F\u7684\u7CFB\u7EDF\u4E2D\u6240\u6709\u7684\u6E90\u4EE3\u7801\u4F9D\u8D56\u5173\u7CFB\uFF0C\u800C\u4E0D\u518D\u53D7\u5230\u7CFB\u7EDF\u63A7\u5236\u6D41\u7684\u9650\u5236\u3002\u4E0D\u7BA1\u54EA\u4E2A\u6A21\u5757\u8C03\u7528\u6216\u8005\u88AB\u8C03\u7528\uFF0C\u8F6F\u4EF6\u67B6\u6784\u5E08\u90FD\u53EF\u4EE5\u968F\u610F\u66F4\u6539\u6E90\u4EE3\u7801\u4F9D\u8D56\u5173\u7CFB\u3002</p></blockquote><p>That is power! That is the power that OO provides. That\u2019s what OO is really all about\u2014at least from the architect\u2019s point of view.</p><blockquote><p>\u8FD9\u5C31\u662F\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u7684\u597D\u5904\uFF0C\u540C\u65F6\u4E5F\u662F\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u8FD9\u79CD\u8303\u5F0F\u7684\u6838\u5FC3\u672C\u8D28\u81F3\u5C11\u5BF9\u4E00\u4E2A\u8F6F\u4EF6\u67B6\u6784\u5E08\u6765\u8BF4\u662F\u8FD9\u6837\u7684\u3002</p></blockquote><p>What can you do with that power? As an example, you can rearrange the source code dependencies of your system so that the database and the user interface (UI) depend on the business rules (Figure 5.3), rather than the other way around.</p><blockquote><p>\u8FD9\u79CD\u80FD\u529B\u6709\u4EC0\u4E48\u7528\u5462\uFF1F\u5728\u4E0B\u9762\u7684\u4F8B\u5B50\u4E2D\uFF0C\u6211\u4EEC\u53EF\u4EE5\u7528\u5B83\u6765\u8BA9\u6570\u636E\u5E93\u6A21\u5757\u548C\u7528\u6237\u754C\u9762\u6A21\u5757\u90FD\u4F9D\u8D56\u4E8E\u4E1A\u52A1\u903B\u8F91\u6A21\u5757\uFF08\u89C1\u56FE 5.3\uFF09\uFF0C\u800C\u975E\u76F8\u53CD\u3002</p></blockquote>",14),D=s("The database and the user interface depend on the business rules"),F=e('<p>This means that the UI and the database can be plugins to the business rules. It means that the source code of the business rules never mentions the UI or the database.</p><blockquote><p>\u8FD9\u610F\u5473\u7740\u6211\u4EEC\u8BA9\u7528\u6237\u754C\u9762\u548C\u6570\u636E\u5E93\u90FD\u6210\u4E3A\u4E1A\u52A1\u903B\u8F91\u7684\u63D2\u4EF6\u3002\u4E5F\u5C31\u662F\u8BF4\uFF0C\u4E1A\u52A1\u903B\u8F91\u6A21\u5757\u7684\u6E90\u4EE3\u7801\u4E0D\u9700\u8981\u5F15\u5165\u7528\u6237\u754C\u9762\u548C\u6570\u636E\u5E93\u8FD9\u4E24\u4E2A\u6A21\u5757\u3002</p></blockquote><p>As a consequence, the business rules, the UI, and the database can be compiled into three separate components or deployment units (e.g., jar files, DLLs, or Gem files) that have the same dependencies as the source code. The component containing the business rules will not depend on the components containing the UI and database.</p><blockquote><p>\u8FD9\u6837\u4E00\u6765\uFF0C\u4E1A\u52A1\u903B\u8F91\u3001\u7528\u6237\u754C\u9762\u4EE5\u53CA\u6570\u636E\u5E93\u5C31\u53EF\u4EE5\u88AB\u7F16\u8BD1\u6210\u4E09\u4E2A\u72EC\u7ACB\u7684\u7EC4\u4EF6\u6216\u8005\u90E8\u7F72\u5355\u5143\uFF08\u4F8B\u5982 jar \u6587\u4EF6\u3001DLL \u6587\u4EF6\u3001Gem \u6587\u4EF6\u7B49\uFF09\u4E86\uFF0C\u8FD9\u4E9B\u7EC4\u4EF6\u6216\u8005\u90E8\u7F72\u5355\u5143\u7684\u4F9D\u8D56\u5173\u7CFB\u4E0E\u6E90\u4EE3\u7801\u7684\u4F9D\u8D56\u5173\u7CFB\u662F\u4E00\u81F4\u7684\uFF0C\u4E1A\u52A1\u903B\u8F91\u7EC4\u4EF6\u4E5F\u4E0D\u4F1A\u4F9D\u8D56\u4E8E\u7528\u6237\u754C\u9762\u548C\u6570\u636E\u5E93\u8FD9\u4E24\u4E2A\u7EC4\u4EF6\u3002</p></blockquote><p>In turn, the business rules can be deployed independently of the UI and the database. Changes to the UI or the database need not have any effect on the business rules. Those components can be deployed separately and independently.</p><blockquote><p>\u4E8E\u662F\uFF0C\u4E1A\u52A1\u903B\u8F91\u7EC4\u4EF6\u5C31\u53EF\u4EE5\u72EC\u7ACB\u4E8E\u7528\u6237\u754C\u9762\u548C\u6570\u636E\u5E93\u6765\u8FDB\u884C\u90E8\u7F72\u4E86\uFF0C\u6211\u4EEC\u5BF9\u7528\u6237\u754C\u9762\u6216\u8005\u6570\u636E\u5E93\u7684\u4FEE\u6539\u5C06\u4E0D\u4F1A\u5BF9\u4E1A\u52A1\u903B\u8F91\u4EA7\u751F\u4EFB\u4F55\u5F71\u54CD\uFF0C\u8FD9\u4E9B\u7EC4\u4EF6\u90FD\u53EF\u4EE5\u88AB\u5206\u53E6\u72EC\u7ACB\u5730\u90E8\u7F72\u3002</p></blockquote><p>In short, when the source code in a component changes, only that component needs to be redeployed. This is independent deployability.</p><blockquote><p>\u7B80\u5355\u6765\u8BF4\uFF0C\u5F53\u67D0\u4E2A\u7EC4\u4EF6\u7684\u6E90\u4EE3\u7801\u9700\u8981\u4FEE\u6539\u65F6\uFF0C\u4EC5\u4EC5\u9700\u8981\u91CD\u65B0\u90E8\u7F72\u8BE5\u7EC4\u4EF6\uFF0C\u4E0D\u9700\u8981\u66F4\u6539\u5176\u4ED6\u7EC4\u4EF6\uFF0C\u8FD9\u5C31\u662F\u72EC\u7ACB\u90E8\u7F72\u80FD\u529B\u3002</p></blockquote><p>If the modules in your system can be deployed independently, then they can be developed independently by different teams. That\u2019s independent developability.</p><blockquote><p>\u5982\u679C\u7CFB\u7EDF\u4E2D\u7684\u6240\u6709\u7EC4\u4EF6\u90FD\u53EF\u4EE5\u72EC\u7ACB\u90E8\u7F72\uFF0C\u90A3\u5B83\u4EEC\u5C31\u53EF\u4EE5\u7531\u4E0D\u540C\u7684\u56E2\u961F\u5E76\u884C\u5F00\u53D1\uFF0C\u8FD9\u5C31\u662F\u6240\u8C13\u7684\u72EC\u7ACB\u5F00\u53D1\u80FD\u529B\u3002</p></blockquote><h2 id="conclusion-\u672C\u7AE0\u5C0F\u7ED3" tabindex="-1"><a class="header-anchor" href="#conclusion-\u672C\u7AE0\u5C0F\u7ED3" aria-hidden="true">#</a> CONCLUSION \u672C\u7AE0\u5C0F\u7ED3</h2><p>What is OO? There are many opinions and many answers to this question. To the software architect, however, the answer is clear: OO is the ability, through the use of polymorphism, to gain absolute control over every source code dependency in the system. It allows the architect to create a plugin architecture, in which modules that contain high-level policies are independent of modules that contain low-level details. The low-level details are relegated to plugin modules that can be deployed and developed independently from the modules that contain high-level policies.</p><blockquote><p>\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u5230\u5E95\u662F\u4EC0\u4E48\uFF1F\u4E1A\u754C\u5728\u8FD9\u4E2A\u95EE\u9898\u4E0A\u5B58\u5728\u7740\u5F88\u591A\u4E0D\u540C\u7684\u8BF4\u6CD5\u548C\u610F\u89C1\u3002\u7136\u800C\u5BF9\u4E00\u4E2A\u8F6F\u4EF6\u67B6\u6784\u5E08\u6765\u8BF4\uFF0C\u5176\u542B\u4E49\u5E94\u8BE5\u662F\u975E\u5E38\u660E\u786E\u7684\uFF1A\u9762\u5411\u5BF9\u8C61\u7F16\u7A0B\u5C31\u662F\u4EE5\u5BF9\u8C61\u4E3A\u624B\u6BB5\u6765\u5BF9\u6E90\u4EE3\u7801\u4E2D\u7684\u4F9D\u8D56\u5173\u7CFB\u8FDB\u884C\u63A7\u5236\u7684\u80FD\u529B\uFF0C\u8FD9\u79CD\u80FD\u529B\u8BA9\u8F6F\u4EF6\u67B6\u6784\u5E08\u53EF\u4EE5\u6784\u5EFA\u51FA\u67D0\u79CD\u63D2\u4EF6\u5F0F\u67B6\u6784\uFF0C\u8BA9\u9AD8\u5C42\u7B56\u7565\u6027\u7EC4\u4EF6\u4E0E\u5E95\u5C42\u5B9E\u73B0\u6027\u7EC4\u4EF6\u76F8\u5206\u79BB\uFF0C\u5E95\u5C42\u7EC4\u4EF6\u53EF\u5FC5\u7F16\u8BD1\u6210\u63D2\u4EF6\uFF0C\u5B9E\u73B0\u72EC\u7ACB\u4E8E\u9AD8\u5C42\u7EC4\u4EF6\u7684\u5F00\u53D1\u548C\u90E8\u7F72\u3002</p></blockquote>',13);function U(W,A){const t=c("ExternalLinkIcon"),o=c("Figures");return l(),r("div",null,[d,n("p",null,[n("a",k,[h,a(t)])]),m,n("p",null,[v,n("a",b,[y,a(t)]),f]),n("blockquote",null,[n("p",null,[g,n("a",w,[q,a(t)]),O])]),I,a(o,{figure:"5-1"},{default:p(()=>[T]),_:1}),P,N,x,_,C,L,a(o,{figure:"5-2"},{default:p(()=>[S]),_:1}),E,a(o,{figure:"5-3"},{default:p(()=>[D]),_:1}),F])}const R=i(u,[["render",U],["__file","ch5.html.vue"]]);export{R as default};
