<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.51" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://windily-cloud.github.io/obsidian-publish/Publish/Clean%20Archtechture/ch29.html"><meta property="og:site_name" content="Windily Cloud"><meta property="og:title" content="Chap29. CLEAN EMBEDDED ARCHITECTURE æ•´æ´çš„åµŒå…¥å¼æ¶æ„"><meta property="og:type" content="article"><meta property="og:updated_time" content="2022-09-20T11:11:04.000Z"><meta property="og:locale" content="zh-CN"><meta property="article:modified_time" content="2022-09-20T11:11:04.000Z"><title>Chap29. CLEAN EMBEDDED ARCHITECTURE æ•´æ´çš„åµŒå…¥å¼æ¶æ„ | Windily Cloud</title><meta name="description" content="Windily Cloud's Blog">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/obsidian-publish/assets/style.12da8f21.css">
    <link rel="modulepreload" href="/obsidian-publish/assets/app.887b133c.js"><link rel="modulepreload" href="/obsidian-publish/assets/ch29.html.69ad75a7.js"><link rel="modulepreload" href="/obsidian-publish/assets/_plugin-vue_export-helper.cdc0426e.js"><link rel="modulepreload" href="/obsidian-publish/assets/ch29.html.7898d2ef.js"><link rel="prefetch" href="/obsidian-publish/assets/index.html.c7e76e53.js"><link rel="prefetch" href="/obsidian-publish/assets/home.html.f01af163.js"><link rel="prefetch" href="/obsidian-publish/assets/å¯¼èˆª.html.d24325cb.js"><link rel="prefetch" href="/obsidian-publish/assets/index.html.fc3247cd.js"><link rel="prefetch" href="/obsidian-publish/assets/afterword.html.279a3dae.js"><link rel="prefetch" href="/obsidian-publish/assets/ch1.html.ad67b7a0.js"><link rel="prefetch" href="/obsidian-publish/assets/ch10.html.74f49c94.js"><link rel="prefetch" href="/obsidian-publish/assets/ch11.html.7b8b868f.js"><link rel="prefetch" href="/obsidian-publish/assets/ch12.html.0897d88d.js"><link rel="prefetch" href="/obsidian-publish/assets/ch13.html.871f1a29.js"><link rel="prefetch" href="/obsidian-publish/assets/ch14.html.9cf7c1a7.js"><link rel="prefetch" href="/obsidian-publish/assets/ch15.html.1ee0e012.js"><link rel="prefetch" href="/obsidian-publish/assets/ch16.html.b2dc5528.js"><link rel="prefetch" href="/obsidian-publish/assets/ch17.html.d50b6029.js"><link rel="prefetch" href="/obsidian-publish/assets/ch18.html.f9083031.js"><link rel="prefetch" href="/obsidian-publish/assets/ch19.html.a8daed86.js"><link rel="prefetch" href="/obsidian-publish/assets/ch2.html.f712f0c4.js"><link rel="prefetch" href="/obsidian-publish/assets/ch20.html.008de7bb.js"><link rel="prefetch" href="/obsidian-publish/assets/ch21.html.bc3946ee.js"><link rel="prefetch" href="/obsidian-publish/assets/ch22.html.dcd080ee.js"><link rel="prefetch" href="/obsidian-publish/assets/ch23.html.4bd6fad0.js"><link rel="prefetch" href="/obsidian-publish/assets/ch24.html.5af7f550.js"><link rel="prefetch" href="/obsidian-publish/assets/ch25.html.cdcf732e.js"><link rel="prefetch" href="/obsidian-publish/assets/ch26.html.d56c6b1b.js"><link rel="prefetch" href="/obsidian-publish/assets/ch27.html.1d0c5f03.js"><link rel="prefetch" href="/obsidian-publish/assets/ch28.html.a9585c5e.js"><link rel="prefetch" href="/obsidian-publish/assets/ch3.html.4e106aa0.js"><link rel="prefetch" href="/obsidian-publish/assets/ch30.html.efd82950.js"><link rel="prefetch" href="/obsidian-publish/assets/ch31.html.054b22ad.js"><link rel="prefetch" href="/obsidian-publish/assets/ch32.html.25d75f30.js"><link rel="prefetch" href="/obsidian-publish/assets/ch33.html.058b06f6.js"><link rel="prefetch" href="/obsidian-publish/assets/ch34.html.61d3f411.js"><link rel="prefetch" href="/obsidian-publish/assets/ch4.html.a6691c1e.js"><link rel="prefetch" href="/obsidian-publish/assets/ch5.html.326ac1a0.js"><link rel="prefetch" href="/obsidian-publish/assets/ch6.html.b00c3f6a.js"><link rel="prefetch" href="/obsidian-publish/assets/ch7.html.4e35799e.js"><link rel="prefetch" href="/obsidian-publish/assets/ch8.html.f553bf58.js"><link rel="prefetch" href="/obsidian-publish/assets/ch9.html.1abe47e0.js"><link rel="prefetch" href="/obsidian-publish/assets/part1.html.61a30e56.js"><link rel="prefetch" href="/obsidian-publish/assets/part2.html.c688cf00.js"><link rel="prefetch" href="/obsidian-publish/assets/part3.html.19a54833.js"><link rel="prefetch" href="/obsidian-publish/assets/part4.html.e97d623d.js"><link rel="prefetch" href="/obsidian-publish/assets/part5.html.59f213ed.js"><link rel="prefetch" href="/obsidian-publish/assets/part6.html.565d8d69.js"><link rel="prefetch" href="/obsidian-publish/assets/obsidainæ–‡æ¡£å¯¼å‡ºçš„æ–¹æ³•.html.8c97282e.js"><link rel="prefetch" href="/obsidian-publish/assets/ç¬”è®°åˆ†ç±»æ–¹æ³•çš„æ€è€ƒ.html.7a0981ad.js"><link rel="prefetch" href="/obsidian-publish/assets/æ‚è¯ï¼šä»æ„è¯†å½¢æ€åˆ†æè¥¿æ–¹ç–«æƒ….html.609d0549.js"><link rel="prefetch" href="/obsidian-publish/assets/è¯»æ¸…æ”¿åºœæ˜¯å¦åº”è¯¥ä¿®å»ºé“è·¯ä¸€æ–‡.html.0ce08377.js"><link rel="prefetch" href="/obsidian-publish/assets/404.html.cc115e5e.js"><link rel="prefetch" href="/obsidian-publish/assets/index.html.60ae3ce2.js"><link rel="prefetch" href="/obsidian-publish/assets/index.html.c09081fd.js"><link rel="prefetch" href="/obsidian-publish/assets/index.html.70634028.js"><link rel="prefetch" href="/obsidian-publish/assets/index.html.3b70efd7.js"><link rel="prefetch" href="/obsidian-publish/assets/index.html.f5a6049f.js"><link rel="prefetch" href="/obsidian-publish/assets/index.html.d91b9c1f.js"><link rel="prefetch" href="/obsidian-publish/assets/index.html.32852561.js"><link rel="prefetch" href="/obsidian-publish/assets/index.html.0a68a710.js"><link rel="prefetch" href="/obsidian-publish/assets/home.html.93b7cca5.js"><link rel="prefetch" href="/obsidian-publish/assets/å¯¼èˆª.html.a1c9d7de.js"><link rel="prefetch" href="/obsidian-publish/assets/index.html.0da27cdd.js"><link rel="prefetch" href="/obsidian-publish/assets/afterword.html.b850d04a.js"><link rel="prefetch" href="/obsidian-publish/assets/ch1.html.5aa5f6f6.js"><link rel="prefetch" href="/obsidian-publish/assets/ch10.html.413c371f.js"><link rel="prefetch" href="/obsidian-publish/assets/ch11.html.3cd7a242.js"><link rel="prefetch" href="/obsidian-publish/assets/ch12.html.175ce04d.js"><link rel="prefetch" href="/obsidian-publish/assets/ch13.html.fc4a1701.js"><link rel="prefetch" href="/obsidian-publish/assets/ch14.html.199a9f38.js"><link rel="prefetch" href="/obsidian-publish/assets/ch15.html.5b8799e9.js"><link rel="prefetch" href="/obsidian-publish/assets/ch16.html.20b93b21.js"><link rel="prefetch" href="/obsidian-publish/assets/ch17.html.165fc3da.js"><link rel="prefetch" href="/obsidian-publish/assets/ch18.html.4cd429e5.js"><link rel="prefetch" href="/obsidian-publish/assets/ch19.html.3e2d64e7.js"><link rel="prefetch" href="/obsidian-publish/assets/ch2.html.384a9648.js"><link rel="prefetch" href="/obsidian-publish/assets/ch20.html.b1ad3804.js"><link rel="prefetch" href="/obsidian-publish/assets/ch21.html.58811bd6.js"><link rel="prefetch" href="/obsidian-publish/assets/ch22.html.44e934ae.js"><link rel="prefetch" href="/obsidian-publish/assets/ch23.html.d77e680e.js"><link rel="prefetch" href="/obsidian-publish/assets/ch24.html.79a8927d.js"><link rel="prefetch" href="/obsidian-publish/assets/ch25.html.a6d9e7e0.js"><link rel="prefetch" href="/obsidian-publish/assets/ch26.html.c53b41bf.js"><link rel="prefetch" href="/obsidian-publish/assets/ch27.html.fdbedd86.js"><link rel="prefetch" href="/obsidian-publish/assets/ch28.html.8d17578d.js"><link rel="prefetch" href="/obsidian-publish/assets/ch3.html.ef8bfaee.js"><link rel="prefetch" href="/obsidian-publish/assets/ch30.html.d5d16d0e.js"><link rel="prefetch" href="/obsidian-publish/assets/ch31.html.33b5c44c.js"><link rel="prefetch" href="/obsidian-publish/assets/ch32.html.6c12ea21.js"><link rel="prefetch" href="/obsidian-publish/assets/ch33.html.7adbcd24.js"><link rel="prefetch" href="/obsidian-publish/assets/ch34.html.c7a5cd99.js"><link rel="prefetch" href="/obsidian-publish/assets/ch4.html.f4b07606.js"><link rel="prefetch" href="/obsidian-publish/assets/ch5.html.0f2533d2.js"><link rel="prefetch" href="/obsidian-publish/assets/ch6.html.c64dc16e.js"><link rel="prefetch" href="/obsidian-publish/assets/ch7.html.d8f304e4.js"><link rel="prefetch" href="/obsidian-publish/assets/ch8.html.ac3dd3f7.js"><link rel="prefetch" href="/obsidian-publish/assets/ch9.html.e8bdc588.js"><link rel="prefetch" href="/obsidian-publish/assets/part1.html.f20e95e2.js"><link rel="prefetch" href="/obsidian-publish/assets/part2.html.46fb949d.js"><link rel="prefetch" href="/obsidian-publish/assets/part3.html.37fde797.js"><link rel="prefetch" href="/obsidian-publish/assets/part4.html.e291bbe5.js"><link rel="prefetch" href="/obsidian-publish/assets/part5.html.7deee47f.js"><link rel="prefetch" href="/obsidian-publish/assets/part6.html.6126ed62.js"><link rel="prefetch" href="/obsidian-publish/assets/obsidainæ–‡æ¡£å¯¼å‡ºçš„æ–¹æ³•.html.f99ad030.js"><link rel="prefetch" href="/obsidian-publish/assets/ç¬”è®°åˆ†ç±»æ–¹æ³•çš„æ€è€ƒ.html.f2f4101a.js"><link rel="prefetch" href="/obsidian-publish/assets/æ‚è¯ï¼šä»æ„è¯†å½¢æ€åˆ†æè¥¿æ–¹ç–«æƒ….html.9eadd293.js"><link rel="prefetch" href="/obsidian-publish/assets/è¯»æ¸…æ”¿åºœæ˜¯å¦åº”è¯¥ä¿®å»ºé“è·¯ä¸€æ–‡.html.71c36bf1.js"><link rel="prefetch" href="/obsidian-publish/assets/404.html.24a96f75.js"><link rel="prefetch" href="/obsidian-publish/assets/index.html.b76fc3f0.js"><link rel="prefetch" href="/obsidian-publish/assets/index.html.ba71ba2a.js"><link rel="prefetch" href="/obsidian-publish/assets/index.html.103ba7cd.js"><link rel="prefetch" href="/obsidian-publish/assets/index.html.7d4c0d5f.js"><link rel="prefetch" href="/obsidian-publish/assets/index.html.b1a4c497.js"><link rel="prefetch" href="/obsidian-publish/assets/index.html.0c6eca16.js"><link rel="prefetch" href="/obsidian-publish/assets/index.html.394348dd.js"><link rel="prefetch" href="/obsidian-publish/assets/auto.56c9cb2e.js"><link rel="prefetch" href="/obsidian-publish/assets/index.1f644ee1.js"><link rel="prefetch" href="/obsidian-publish/assets/flowchart.parse.1479ec3f.js"><link rel="prefetch" href="/obsidian-publish/assets/mermaid.esm.min.0e041931.js"><link rel="prefetch" href="/obsidian-publish/assets/highlight.esm.9b852bc5.js"><link rel="prefetch" href="/obsidian-publish/assets/markdown.esm.77e8db25.js"><link rel="prefetch" href="/obsidian-publish/assets/math.esm.cb9d4be3.js"><link rel="prefetch" href="/obsidian-publish/assets/notes.esm.62c5f19d.js"><link rel="prefetch" href="/obsidian-publish/assets/reveal.esm.41ec5d7f.js"><link rel="prefetch" href="/obsidian-publish/assets/search.esm.04894411.js"><link rel="prefetch" href="/obsidian-publish/assets/zoom.esm.78977eba.js"><link rel="prefetch" href="/obsidian-publish/assets/VuePlayground.3cfc7758.js"><link rel="prefetch" href="/obsidian-publish/assets/photoswipe.esm.f594e77b.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><a href="/obsidian-publish/" class="brand"><img class="logo" src="/obsidian-publish/logo.svg" alt="Windily Cloud"><!----><span class="site-name hide-in-pad">Windily Cloud</span></a><!----></div><div class="navbar-center"><!----><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/obsidian-publish/" class="nav-link" aria-label="åšå®¢ä¸»é¡µ"><span class="icon iconfont icon-home"></span>åšå®¢ä¸»é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><a href="/obsidian-publish/home.html" class="nav-link" aria-label="å›¾è°±"><span class="icon iconfont icon-home"></span>å›¾è°±<!----></a></div><div class="nav-item hide-in-mobile"><a href="https://vuepress-theme-hope.github.io/v2/zh/" rel="noopener noreferrer" target="_blank" aria-label="ä¸»é¢˜æ–‡æ¡£" class="nav-link"><span class="icon iconfont icon-note"></span>ä¸»é¢˜æ–‡æ¡£<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><!----></div><div class="navbar-right"><!----><!----><div class="nav-item"><a class="repo-link" href="https://github.com/windily-cloud/obsidian-publish" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form><!----><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><section class="sidebar-group"><p class="sidebar-heading clickable active"><span class="icon iconfont icon-folder"></span><a href="/obsidian-publish/" class="title">Vault</a><!----></p><ul class="sidebar-links"><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-folder"></span><span class="title">è§é—»</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-folder"></span><span class="title">Obsidian</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="icon iconfont icon-folder"></span><span class="title">Clean Archtechture</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/" class="nav-link sidebar-link sidebar-page" aria-label="README.md"><span class="icon iconfont icon-file"></span>README.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/afterword.html" class="nav-link sidebar-link sidebar-page" aria-label="afterword.md"><span class="icon iconfont icon-file"></span>afterword.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch1.html" class="nav-link sidebar-link sidebar-page" aria-label="ch1.md"><span class="icon iconfont icon-file"></span>ch1.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch10.html" class="nav-link sidebar-link sidebar-page" aria-label="ch10.md"><span class="icon iconfont icon-file"></span>ch10.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch11.html" class="nav-link sidebar-link sidebar-page" aria-label="ch11.md"><span class="icon iconfont icon-file"></span>ch11.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch12.html" class="nav-link sidebar-link sidebar-page" aria-label="ch12.md"><span class="icon iconfont icon-file"></span>ch12.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch13.html" class="nav-link sidebar-link sidebar-page" aria-label="ch13.md"><span class="icon iconfont icon-file"></span>ch13.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch14.html" class="nav-link sidebar-link sidebar-page" aria-label="ch14.md"><span class="icon iconfont icon-file"></span>ch14.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch15.html" class="nav-link sidebar-link sidebar-page" aria-label="ch15.md"><span class="icon iconfont icon-file"></span>ch15.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch16.html" class="nav-link sidebar-link sidebar-page" aria-label="ch16.md"><span class="icon iconfont icon-file"></span>ch16.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch17.html" class="nav-link sidebar-link sidebar-page" aria-label="ch17.md"><span class="icon iconfont icon-file"></span>ch17.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch18.html" class="nav-link sidebar-link sidebar-page" aria-label="ch18.md"><span class="icon iconfont icon-file"></span>ch18.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch19.html" class="nav-link sidebar-link sidebar-page" aria-label="ch19.md"><span class="icon iconfont icon-file"></span>ch19.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch2.html" class="nav-link sidebar-link sidebar-page" aria-label="ch2.md"><span class="icon iconfont icon-file"></span>ch2.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch20.html" class="nav-link sidebar-link sidebar-page" aria-label="ch20.md"><span class="icon iconfont icon-file"></span>ch20.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch21.html" class="nav-link sidebar-link sidebar-page" aria-label="ch21.md"><span class="icon iconfont icon-file"></span>ch21.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch22.html" class="nav-link sidebar-link sidebar-page" aria-label="ch22.md"><span class="icon iconfont icon-file"></span>ch22.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch23.html" class="nav-link sidebar-link sidebar-page" aria-label="ch23.md"><span class="icon iconfont icon-file"></span>ch23.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch24.html" class="nav-link sidebar-link sidebar-page" aria-label="ch24.md"><span class="icon iconfont icon-file"></span>ch24.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch25.html" class="nav-link sidebar-link sidebar-page" aria-label="ch25.md"><span class="icon iconfont icon-file"></span>ch25.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch26.html" class="nav-link sidebar-link sidebar-page" aria-label="ch26.md"><span class="icon iconfont icon-file"></span>ch26.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch27.html" class="nav-link sidebar-link sidebar-page" aria-label="ch27.md"><span class="icon iconfont icon-file"></span>ch27.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch28.html" class="nav-link sidebar-link sidebar-page" aria-label="ch28.md"><span class="icon iconfont icon-file"></span>ch28.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/obsidian-publish/Publish/Clean%20Archtechture/ch29.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="ch29.md"><span class="icon iconfont icon-file"></span>ch29.md<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/obsidian-publish/Publish/Clean%20Archtechture/ch29.html#app-titude-test-ç¨‹åºé€‚ç”¨æµ‹è¯•-æµ‹è¯•" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="APP-TITUDE TEST â€œç¨‹åºé€‚ç”¨æµ‹è¯•â€æµ‹è¯•"><!---->APP-TITUDE TEST â€œç¨‹åºé€‚ç”¨æµ‹è¯•â€æµ‹è¯•<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/obsidian-publish/Publish/Clean%20Archtechture/ch29.html#the-target-hardware-bottleneck-ç›®æ ‡ç¡¬ä»¶ç“¶é¢ˆ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="THE TARGET-HARDWARE BOTTLENECK ç›®æ ‡ç¡¬ä»¶ç“¶é¢ˆ"><!---->THE TARGET-HARDWARE BOTTLENECK ç›®æ ‡ç¡¬ä»¶ç“¶é¢ˆ<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/obsidian-publish/Publish/Clean%20Archtechture/ch29.html#a-clean-embedded-architecture-is-a-testable-embedded-architecture-æ•´æ´çš„åµŒå…¥å¼æ¶æ„å°±æ˜¯å¯æµ‹è¯•çš„åµŒå…¥å¼æ¶æ„" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="A CLEAN EMBEDDED ARCHITECTURE IS A TESTABLE EMBEDDED ARCHITECTURE æ•´æ´çš„åµŒå…¥å¼æ¶æ„å°±æ˜¯å¯æµ‹è¯•çš„åµŒå…¥å¼æ¶æ„"><!---->A CLEAN EMBEDDED ARCHITECTURE IS A TESTABLE EMBEDDED ARCHITECTURE æ•´æ´çš„åµŒå…¥å¼æ¶æ„å°±æ˜¯å¯æµ‹è¯•çš„åµŒå…¥å¼æ¶æ„<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/obsidian-publish/Publish/Clean%20Archtechture/ch29.html#layers-åˆ†å±‚" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Layers åˆ†å±‚"><!---->Layers åˆ†å±‚<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/obsidian-publish/Publish/Clean%20Archtechture/ch29.html#the-hardware-is-a-detail-ç¡¬ä»¶æ˜¯å®ç°ç»†èŠ‚" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="The Hardware Is a Detail ç¡¬ä»¶æ˜¯å®ç°ç»†èŠ‚"><!---->The Hardware Is a Detail ç¡¬ä»¶æ˜¯å®ç°ç»†èŠ‚<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/obsidian-publish/Publish/Clean%20Archtechture/ch29.html#don-t-reveal-hardware-details-to-the-user-of-the-hal-ä¸è¦å‘-hal-çš„ç”¨æˆ·æš´éœ²ç¡¬ä»¶ç»†èŠ‚" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="DONâ€™T REVEAL HARDWARE DETAILS TO THE USER OF THE HAL ä¸è¦å‘ HAL çš„ç”¨æˆ·æš´éœ²ç¡¬ä»¶ç»†èŠ‚"><!---->DONâ€™T REVEAL HARDWARE DETAILS TO THE USER OF THE HAL ä¸è¦å‘ HAL çš„ç”¨æˆ·æš´éœ²ç¡¬ä»¶ç»†èŠ‚<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/obsidian-publish/Publish/Clean%20Archtechture/ch29.html#the-processor-is-a-detail" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="The Processor Is a Detail"><!---->The Processor Is a Detail<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/obsidian-publish/Publish/Clean%20Archtechture/ch29.html#the-operating-system-is-a-detail-æ“ä½œç³»ç»Ÿæ˜¯å®ç°ç»†èŠ‚" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="The Operating System Is a Detail æ“ä½œç³»ç»Ÿæ˜¯å®ç°ç»†èŠ‚"><!---->The Operating System Is a Detail æ“ä½œç³»ç»Ÿæ˜¯å®ç°ç»†èŠ‚<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/obsidian-publish/Publish/Clean%20Archtechture/ch29.html#programming-to-interfaces-and-substitutability-é¢å‘æ¥å£ç¼–ç¨‹ä¸å¯æ›¿ä»£æ€§" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="PROGRAMMING TO INTERFACES AND SUBSTITUTABILITY é¢å‘æ¥å£ç¼–ç¨‹ä¸å¯æ›¿ä»£æ€§"><!---->PROGRAMMING TO INTERFACES AND SUBSTITUTABILITY é¢å‘æ¥å£ç¼–ç¨‹ä¸å¯æ›¿ä»£æ€§<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/obsidian-publish/Publish/Clean%20Archtechture/ch29.html#dry-conditional-compilation-directives-dry-æ¡ä»¶æ€§ç¼–è¯‘å‘½ä»¤" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="DRY CONDITIONAL COMPILATION DIRECTIVES DRY æ¡ä»¶æ€§ç¼–è¯‘å‘½ä»¤"><!---->DRY CONDITIONAL COMPILATION DIRECTIVES DRY æ¡ä»¶æ€§ç¼–è¯‘å‘½ä»¤<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/obsidian-publish/Publish/Clean%20Archtechture/ch29.html#conclusion-æœ¬ç« å°ç»“" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="CONCLUSION æœ¬ç« å°ç»“"><!---->CONCLUSION æœ¬ç« å°ç»“<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch3.html" class="nav-link sidebar-link sidebar-page" aria-label="ch3.md"><span class="icon iconfont icon-file"></span>ch3.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch30.html" class="nav-link sidebar-link sidebar-page" aria-label="ch30.md"><span class="icon iconfont icon-file"></span>ch30.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch31.html" class="nav-link sidebar-link sidebar-page" aria-label="ch31.md"><span class="icon iconfont icon-file"></span>ch31.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch32.html" class="nav-link sidebar-link sidebar-page" aria-label="ch32.md"><span class="icon iconfont icon-file"></span>ch32.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch33.html" class="nav-link sidebar-link sidebar-page" aria-label="ch33.md"><span class="icon iconfont icon-file"></span>ch33.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch34.html" class="nav-link sidebar-link sidebar-page" aria-label="ch34.md"><span class="icon iconfont icon-file"></span>ch34.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch4.html" class="nav-link sidebar-link sidebar-page" aria-label="ch4.md"><span class="icon iconfont icon-file"></span>ch4.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch5.html" class="nav-link sidebar-link sidebar-page" aria-label="ch5.md"><span class="icon iconfont icon-file"></span>ch5.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch6.html" class="nav-link sidebar-link sidebar-page" aria-label="ch6.md"><span class="icon iconfont icon-file"></span>ch6.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch7.html" class="nav-link sidebar-link sidebar-page" aria-label="ch7.md"><span class="icon iconfont icon-file"></span>ch7.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch8.html" class="nav-link sidebar-link sidebar-page" aria-label="ch8.md"><span class="icon iconfont icon-file"></span>ch8.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch9.html" class="nav-link sidebar-link sidebar-page" aria-label="ch9.md"><span class="icon iconfont icon-file"></span>ch9.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/part1.html" class="nav-link sidebar-link sidebar-page" aria-label="part1.md"><span class="icon iconfont icon-file"></span>part1.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/part2.html" class="nav-link sidebar-link sidebar-page" aria-label="part2.md"><span class="icon iconfont icon-file"></span>part2.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/part3.html" class="nav-link sidebar-link sidebar-page" aria-label="part3.md"><span class="icon iconfont icon-file"></span>part3.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/part4.html" class="nav-link sidebar-link sidebar-page" aria-label="part4.md"><span class="icon iconfont icon-file"></span>part4.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/part5.html" class="nav-link sidebar-link sidebar-page" aria-label="part5.md"><span class="icon iconfont icon-file"></span>part5.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/Clean%20Archtechture/part6.html" class="nav-link sidebar-link sidebar-page" aria-label="part6.md"><span class="icon iconfont icon-file"></span>part6.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section><!--]--></li><li><!--[--><a href="/obsidian-publish/Publish/%E5%AF%BC%E8%88%AA.html" class="nav-link sidebar-link sidebar-page" aria-label="å¯¼èˆª.md"><span class="icon iconfont icon-file"></span>å¯¼èˆª.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->Chap29. CLEAN EMBEDDED ARCHITECTURE æ•´æ´çš„åµŒå…¥å¼æ¶æ„</h1><div class="page-info"><span class="author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down" localizeddate="2022å¹´9æœˆ20æ—¥" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="https://windily-cloud.github.io" target="_blank" rel="noopener noreferrer">Windily-Cloud</a></span><span property="author" content="Windily-Cloud"></span></span><!----><span class="date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span>2022å¹´9æœˆ20æ—¥</span><meta property="datePublished" content="2022-09-20T11:03:58.000Z"></span><!----><!----><span class="reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down" localizeddate="2022å¹´9æœˆ20æ—¥" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 36 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT36M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">æ­¤é¡µå†…å®¹</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/obsidian-publish/Publish/Clean%20Archtechture/ch29.html#chap29-clean-embedded-architecture-æ•´æ´çš„åµŒå…¥å¼æ¶æ„" class="router-link-active router-link-exact-active toc-link level1">Chap29. CLEAN EMBEDDED ARCHITECTURE æ•´æ´çš„åµŒå…¥å¼æ¶æ„</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/obsidian-publish/Publish/Clean%20Archtechture/ch29.html#app-titude-test-ç¨‹åºé€‚ç”¨æµ‹è¯•-æµ‹è¯•" class="router-link-active router-link-exact-active toc-link level2">APP-TITUDE TEST â€œç¨‹åºé€‚ç”¨æµ‹è¯•â€æµ‹è¯•</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/obsidian-publish/Publish/Clean%20Archtechture/ch29.html#the-target-hardware-bottleneck-ç›®æ ‡ç¡¬ä»¶ç“¶é¢ˆ" class="router-link-active router-link-exact-active toc-link level2">THE TARGET-HARDWARE BOTTLENECK ç›®æ ‡ç¡¬ä»¶ç“¶é¢ˆ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/obsidian-publish/Publish/Clean%20Archtechture/ch29.html#conclusion-æœ¬ç« å°ç»“" class="router-link-active router-link-exact-active toc-link level2">CONCLUSION æœ¬ç« å°ç»“</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="chap29-clean-embedded-architecture-æ•´æ´çš„åµŒå…¥å¼æ¶æ„" tabindex="-1"><a class="header-anchor" href="#chap29-clean-embedded-architecture-æ•´æ´çš„åµŒå…¥å¼æ¶æ„" aria-hidden="true">#</a> Chap29. CLEAN EMBEDDED ARCHITECTURE æ•´æ´çš„åµŒå…¥å¼æ¶æ„</h1><p>By James Grenning</p><p>A while ago I read an article entitled â€œThe Growing Importance of Sustaining Software for the DoDâ€1 on Doug Schmidtâ€™s blog. Doug made the following claim:</p><blockquote><p>å‰ä¸€æ®µæ—¶é—´ï¼Œæˆ‘åœ¨ Doug Schmidt çš„ä¸ªäººåšå®¢ä¸Šçœ‹åˆ°äº†ä¸€ç¯‡æ–‡ç« ï¼Œæ ‡é¢˜æ˜¯â€œThe Growing Importance of Sustaining Software for the DoDâ€ï¼ŒDoug åœ¨è¿™ç¯‡æ–‡ç« ä¸­æå‡ºäº†ä»¥ä¸‹è§‚ç‚¹ï¼š</p></blockquote><p>â€œAlthough software does not wear out, firmware and hardware become obsolete, thereby requiring software modifications.â€</p><blockquote><p>â€œè™½ç„¶è½¯ä»¶æœ¬èº«å¹¶ä¸ä¼šéšæ—¶é—´æ¨ç§»è€Œç£¨æŸï¼Œä½†ç¡¬ä»¶åŠå…¶å›ºä»¶å´ä¼šéšæ—¶é—´æ¨ç§»è€Œè¿‡æ—¶ï¼Œéšå³ä¹Ÿéœ€è¦å¯¹è½¯ä»¶åšç›¸åº”æ”¹åŠ¨ã€‚â€</p></blockquote><p>It was a clarifying moment for me. Doug mentioned two terms that I would have thought to be obviousâ€”but maybe not. Software is this thing that can have a long useful life, but firmware will become obsolete as hardware evolves. If you have spent any time in embedded systems development, you know the hardware is continually evolving and being improved. At the same time, features are added to the new â€œsoftware,â€ and it continually grows in complexity.</p><blockquote><p>è¿™å¥è¯å¯¹æˆ‘æœ‰å¦‚é†é†çŒé¡¶ã€‚Doug åœ¨è¿™é‡Œç”¨åˆ°äº†ä¸¤ä¸ªä¸“ä¸šåè¯ï¼Œæˆ‘ä¸€ç›´è®¤ä¸ºæ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œä½†æ˜¯å…¶ä»–äººå¯èƒ½å¹¶æ²¡æœ‰è¿™ä¹ˆè§‰å¾—ã€‚å…¶ä¸­ï¼Œè½¯ä»¶ï¼ˆsoftwareï¼‰åº”è¯¥æ˜¯ä¸€ç§ä½¿ç”¨å‘¨æœŸå¾ˆé•¿çš„ä¸œè¥¿ï¼Œè€Œå›ºä»¶ï¼ˆfirmwareï¼‰åˆ™ä¼šéšç€ç¡¬ä»¶æ¼”è¿›è€Œæ·˜æ±°è¿‡æ—¶ã€‚æ›¾ç»å¼€å‘è¿‡åµŒå…¥å¼ç³»ç»Ÿçš„äººä¸€å®šéƒ½çŸ¥é“ï¼Œç¡¬ä»¶ç³»ç»Ÿæ˜¯åœ¨æŒç»­ä¸æ–­åœ°æ¼”è¿›çš„ã€‚ä¸æ­¤åŒæ—¶ï¼Œéšç€æ–°åŠŸèƒ½ä¸æ–­åœ°å¢åŠ ï¼Œè½¯ä»¶å¤æ‚åº¦ä¹Ÿåœ¨ä¸æ–­ä¸Šå‡ã€‚</p></blockquote><p>Iâ€™d like to add to Dougâ€™s statement:</p><blockquote><p>åœ¨è¿™é‡Œï¼Œæˆ‘æƒ³å¯¹ Dough ä¸Šé¢çš„é‚£ä¸ªè§‚ç‚¹åšä¸€ç‚¹è¡¥å……ï¼š</p></blockquote><p>Although software does not wear out, it can be destroyed from within by unmanaged dependencies on firmware and hardware.</p><blockquote><p>â€œè™½ç„¶è½¯ä»¶è´¨é‡æœ¬èº«å¹¶ä¸ä¼šéšæ—¶é—´æ¨ç§»è€ŒæŸè€—ï¼Œä½†æ˜¯æœªå¦¥å–„ç®¡ç†çš„ç¡¬ä»¶ä¾èµ–å’Œå›ºä»¶ä¾èµ–å´æ˜¯è½¯ä»¶çš„å¤´å·æ€æ‰‹ã€‚â€</p></blockquote><p>It is not uncommon for embedded software to be denied a potentially long life due to being infected with dependencies on hardware.</p><blockquote><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ¬å¯ä»¥é•¿æœŸä½¿ç”¨çš„åµŒå…¥å¼è½¯ä»¶å¯èƒ½ä¼šç”±äºå…¶ä¸­éšå«çš„ç¡¬ä»¶ä¾èµ–å…³ç³»è€Œæ— æ³•ç»§ç»­ä½¿ç”¨ï¼Œè¿™ç§æƒ…å†µæ˜¯å¾ˆå¸¸è§çš„ã€‚</p></blockquote><p>I like Dougâ€™s definition of firmware, but letâ€™s see which other definitions are out there. I found these alternatives:</p><blockquote><p>æˆ‘ä¸ªäººå¾ˆå–œæ¬¢ Doug å¯¹å›ºä»¶æ‰€åšçš„å®šä¹‰ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥æ¥çœ‹ä¸€ä¸‹å…¶ä»–äººå¯¹å›ºä»¶çš„å®šä¹‰ï¼Œä»¥ä¸‹æ˜¯æˆ‘ç›®å‰æ‰€æ‰¾åˆ°çš„ä¸€äº›è¯´æ³•ï¼š</p></blockquote><ul><li>â€œFirmware is held in non-volatile memory devices such as ROM, EPROM, or flash memory.â€ (<a href="https://en.wikipedia.org/wiki/Firmware" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Firmware<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>)</li><li>â€œFirmware is a software program or set of instructions programmed on a hardware device.â€ (<a href="https://techterms.com/definition/firmware" target="_blank" rel="noopener noreferrer">https://techterms.com/definition/firmware<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>)</li><li>â€œFirmware is software that is embedded in a piece of hardware.â€ (<a href="https://www.lifewire.com/what-is-firmware-2625881" target="_blank" rel="noopener noreferrer">https://www.lifewire.com/what-is-firmware-2625881<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>)</li><li>Firmware is â€œSoftware (programs or data) that has been written onto read-only memory (ROM).â€ (<a href="http://www.webopedia.com/TERM/F/firmware.html" target="_blank" rel="noopener noreferrer">http://www.webopedia.com/TERM/F/firmware.html<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>)</li></ul><hr><blockquote><ul><li>â€œå›ºä»¶é€šå¸¸è¢«å­˜å‚¨åœ¨éå¯å˜å†…å­˜è®¾å¤‡ï¼Œä¾‹å¦‚ ROMã€EPROM æˆ–è€…é—ªå­˜ä¸­ã€‚â€ï¼ˆ<a href="https://en.wikipedia.org/wiki/Firmware%EF%BC%89" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Firmwareï¼‰<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li>â€œå›ºä»¶æ˜¯ç›´æ¥ç¼–ç¨‹åœ¨ä¸€ä¸ªç¡¬ä»¶è®¾å¤‡ä¸Šçš„ä¸€ç»„æŒ‡ä»¤æˆ–è€…ä¸€æ®µç¨‹åºã€‚â€ï¼ˆ<a href="https://techterms.com/definition/firmware%EF%BC%89" target="_blank" rel="noopener noreferrer">https://techterms.com/definition/firmwareï¼‰<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li>â€œå›ºä»¶æ˜¯åµŒå…¥åœ¨ä¸€ä¸ªç¡¬ä»¶ä¸­çš„è½¯ä»¶ç¨‹åºã€‚â€ï¼ˆ<a href="https://www.lifewire.com/what-is-firmware-2625881%EF%BC%89" target="_blank" rel="noopener noreferrer">https://www.lifewire.com/what-is-firmware-2625881ï¼‰<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li>â€œå›ºä»¶æ˜¯è¢«å†™å…¥åˆ°åªè¯»å†…å­˜è®¾å¤‡ä¸­çš„ï¼ˆROMï¼‰ç¨‹åºæˆ–æ•°æ®ã€‚â€ï¼ˆ<a href="http://www.webopedia.com/TERM/F/firmware.html%EF%BC%89" target="_blank" rel="noopener noreferrer">http://www.webopedia.com/TERM/F/firmware.htmlï¼‰<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul></blockquote><p>Dougâ€™s statement makes me realize that these accepted definitions of firmware are wrong, or at least obsolete. Firmware does not mean code lives in ROM. Itâ€™s not firmware because of where it is stored; rather, it is firmware because of what it depends on and how hard it is to change as hardware evolves. Hardware does evolve (pause and look at your for phone for evidence), so we should structure our embedded code with that reality in mind.</p><blockquote><p>Doug çš„è¿™æ®µè§‚ç‚¹è¡¨è¿°è®©æˆ‘æ„è¯†åˆ°ï¼Œå¤§å®¶æ™®éæ‰€è®¤çŸ¥çš„å›ºä»¶å®šä¹‰æ˜¯é”™è¯¯çš„ï¼Œæˆ–è€…è‡³å°‘æ˜¯è¿‡æ—¶çš„ã€‚å›ºä»¶å¹¶ä¸ä¸€å®šæ˜¯å­˜å‚¨åœ¨ ROM ä¸­çš„ä»£ç ã€‚å›ºä»¶ä¹Ÿä¸æ˜¯ä¾æ®å…¶å­˜å‚¨çš„ä½ç½®æ¥å®šä¹‰çš„ï¼Œè€Œæ˜¯ç”±å…¶ä»£ç çš„ä¾èµ–å…³ç³»ï¼ŒåŠå…¶éšç€ç¡¬ä»¶çš„æ¼”è¿›åœ¨å˜æ›´éš¾åº¦ä¸Šçš„å˜åŒ–æ¥å®šä¹‰çš„ã€‚ç¡¬ä»¶çš„æ¼”è¿›æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼ˆå¦‚æœå¯¹æ­¤æœ‰ä»»ä½•ç–‘é—®ï¼Œè¯·æƒ³ä¸€æƒ³ä½ æ‰‹ä¸­çš„æ‰‹æœºï¼‰ï¼Œæˆ‘ä»¬åœ¨æ¶æ„åµŒå…¥å¼ä»£ç æ—¶è¦æ—¶åˆ»è®°ä½è¿™ä¸€ç‚¹ã€‚</p></blockquote><p>I have nothing against firmware, or firmware engineers (Iâ€™ve been known to write some firmware myself). But what we really need is less firmware and more software. Actually, I am disappointed that firmware engineers write so much firmware!</p><blockquote><p>æˆ‘å¹¶ä¸åå¯¹å›ºä»¶ï¼Œä¹Ÿä¸åå¯¹å›ºä»¶å·¥ç¨‹å¸ˆï¼ˆæˆ‘è‡ªå·±ä¹Ÿæ›¾ç»å†™è¿‡å›ºä»¶ï¼‰ã€‚ä½†æ˜¯æˆ‘ä»¬çœŸçš„åº”è¯¥å°‘å†™ç‚¹å›ºä»¶ï¼Œè€Œå¤šå†™ç‚¹è½¯ä»¶ã€‚äº‹å®ä¸Šï¼Œæˆ‘æœ€å¤±æœ›çš„æ˜¯å›ºä»¶å·¥ç¨‹å¸ˆç«Ÿç„¶è¦å†™é‚£ä¹ˆå¤šå›ºä»¶ç¨‹åºï¼</p></blockquote><p>Non-embedded engineers also write firmware! You non-embedded developers essentially write firmware whenever you bury SQL in your code or when you spread platform dependencies throughout your code. Android app developers write firmware when they donâ€™t separate their business logic from the Android API.</p><blockquote><p>è¿˜æœ‰ï¼ŒéåµŒå…¥å¼å·¥ç¨‹å¸ˆç«Ÿç„¶ä¹Ÿè¦å†™å›ºä»¶ç¨‹åºï¼è™½ç„¶ä½ å¯èƒ½å¹¶ä¸æ˜¯åµŒå…¥å¼ç³»ç»Ÿçš„å¼€å‘è€…ï¼Œä½†å¦‚æœä½ åœ¨ä»£ç ä¸­åµŒå…¥äº† SQL æˆ–è€…æ˜¯ä»£ç ä¸­å¼•å…¥äº†å¯¹æŸä¸ªå¹³å°çš„ä¾èµ–çš„è¯ï¼Œå…¶å®å°±æ˜¯åœ¨å†™å›ºä»¶ä»£ç ã€‚è­¬å¦‚ï¼ŒAndroid å·¥ç¨‹å¸ˆåœ¨æ²¡æœ‰å°†ä¸šåŠ¡é€»è¾‘ä¸ Android API åˆ†ç¦»ä¹‹å‰ï¼Œå®é™…ä¸Šä¹Ÿæ˜¯åœ¨å†™å›ºä»¶ä»£ç ã€‚</p></blockquote><p>Iâ€™ve been involved in a lot of efforts where the line between the product code (the software) and the code that interacts with the productâ€™s hardware (the firmware) is fuzzy to the point of nonexistence. For example, in the late 1990s I had the fun of helping redesign a communications subsystem that was transitioning from time-division multiplexing (TDM) to voice over IP (VOIP). VOIP is how things are done now, but TDM was considered the state of the art from the 1950s and 1960s, and was widely deployed in the 1980s and 1990s.</p><blockquote><p>æˆ‘å‚ä¸è¿‡å¾ˆå¤šè½¯ä»¶é¡¹ç›®ï¼Œå…¶ä¸­ä¸€äº›äº§å“çš„åŠŸèƒ½ä»£ç ï¼ˆè½¯ä»¶ï¼‰ä¸ç¡¬ä»¶æ”¯æŒä»£ç ï¼ˆå›ºä»¶ï¼‰çš„è¾¹ç•Œæ¨¡ç³Šå¾—å‡ ä¹ä¸å­˜åœ¨ã€‚ä¾‹å¦‚ï¼Œåœ¨ 20 ä¸–çºª 90 å¹´ä»£æœ«ï¼Œæˆ‘æœ‰å¹¸å‚ä¸äº†ä¸€å¥—é€šä¿¡ç³»ç»Ÿçš„é‡æ–°è®¾è®¡ï¼Œå°†å…¶ä»æ—¶åˆ†å¤ç”¨ï¼ˆTDMï¼‰æ¨¡å¼è¿ç§»åˆ° VOIP æ¨¡å¼ã€‚è™½ç„¶ VOIP å¦‚ä»Šå·²ç»æ˜¯è¡Œä¸šæ ‡å‡†ï¼Œä½†æ˜¯ä» 20 ä¸–çºª 50 å¹´ä»£åˆ° 60 å¹´ä»£ï¼ŒTDM ä¸€ç›´éƒ½æ˜¯éå¸¸å…ˆè¿›çš„æŠ€æœ¯ï¼Œç›´åˆ° 20 ä¸–çºª 80 å¹´ä»£å’Œ 90 å¹´ä»£å®ƒä¹Ÿè¢«å¹¿æ³›éƒ¨ç½²åœ¨å„ç§ç³»ç»Ÿä¸­ã€‚</p></blockquote><p>Whenever we had a question for the systems engineer about how a call should react to a given situation, he would disappear and a little later emerge with a very detailed answer. â€œWhere did he get that answer?â€ we asked. â€œFrom the current productâ€™s code,â€ heâ€™d answer. The tangled legacy code was the spec for the new product! The existing implementation had no separation between TDM and the business logic of making calls. The whole product was hardware/technology dependent from top to bottom and could not be untangled. The whole product had essentially become firmware.</p><blockquote><p>æ¯å½“æˆ‘ä»¬å‘ç³»ç»Ÿå·¥ç¨‹å¸ˆæå‡ºä¸€ä¸ªäº§å“é—®é¢˜â€”â€”ç³»ç»Ÿåœ¨æŸä¸ªæƒ…å†µä¸‹åº”è¯¥å¦‚ä½•å¤„ç†æŸé€šç”µè¯ï¼Œè¿™ä½ç³»ç»Ÿå·¥ç¨‹å¸ˆå°±ä¼šæ¶ˆå¤±ä¸€æ®µæ—¶é—´ï¼Œç„¶åç»™å‡ºä¸€ä¸ªéå¸¸å…·ä½“çš„ç­”æ¡ˆã€‚æˆ‘ä»¬é—®ä»–æ˜¯ä»å“ªé‡ŒæŸ¥åˆ°è¿™ä¸ªç»“æœçš„ï¼Ÿç­”æ¡ˆæ˜¯â€œä»å½“å‰çš„äº§å“ä»£ç é‡Œï¼â€è¿™äº›å¤æ‚äº¤é”™çš„è€ä»£ç å·±ç»æˆä¸ºç³»ç»Ÿå®šä¹‰çš„ä¸€éƒ¨åˆ†ã€‚è¯¥ç³»ç»Ÿåœ¨å®ç°è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰åŒºåˆ† TDM æŠ€æœ¯ä»£ç å’Œæ‹¨æ‰“ç”µè¯è¿™æ ·çš„ä¸šåŠ¡é€»è¾‘ä»£ç ã€‚æ•´ä¸ªäº§å“ä»å¤´åˆ°å°¾éƒ½ä¸å…·ä½“æŠ€æœ¯ã€å…·ä½“ç¡¬ä»¶æ¯æ¯ç›¸å…³ï¼Œæ— æ³•åˆ†å‰²ã€‚å¯ä»¥è¯´æ•´ä¸ªäº§å“å·²ç»æˆä¸ºäº‹å®ä¸Šçš„å›ºä»¶ã€‚</p></blockquote><p>Consider another example: Command messages arrive to this system via serial port. Unsurprisingly, there is a message processor/dispatcher. The message processor knows the format of messages, is able to parse them, and can then dispatch the message to the code that can handle the request. None of this is surprising, except that the message processor/dispatcher resides in the same file as code that interacts with a UART2 hardware. The message processor is polluted with UART details. The message processor could have been software with a potentially long useful life, but instead it is firmware. The message processor is denied the opportunity to become softwareâ€”and that is just not right!</p><blockquote><p>å†æ¥çœ‹å¦å¤–ä¸€ä¸ªä¾‹å­ï¼šæˆ‘ä»¬éƒ½çŸ¥é“å‘½ä»¤æ¶ˆæ¯æ˜¯é€šè¿‡ä¸²è¡Œç«¯å£ä¼ é€’ç»™ç³»ç»Ÿçš„ã€‚è¿™è‡ªç„¶å°±è¦æœ‰ä¸€ä¸ªæ¶ˆæ¯çš„å¤„ç†å™¨/åˆ†å‘å™¨ç³»ç»Ÿã€‚å…¶ä¸­ï¼Œæ¶ˆæ¯å¤„ç†å™¨å¾—äº†è§£æ¶ˆæ¯æ ¼å¼ï¼Œå¯ä»¥è§£ææ¶ˆæ¯ï¼Œç„¶åå°†æ¶ˆæ¯åˆ†å‘ç»™å…·ä½“çš„å¤„ç†ä»£ç ã€‚è¿™äº›éƒ½å¾ˆæ­£å¸¸ï¼Œä½†æ¶ˆæ¯å¤„ç†å™¨åˆ†å‘å™¨çš„ä»£ç å’Œæ“ä½œ UART ç¡¬ä»¶çš„ä»£ç å¾€å¾€ä¼šè¢«æ”¾å­˜åŒä¸€ä¸ªæ–‡ä»¶ä¸­æ¶ˆæ¯å¤„ç†å™¨çš„ä»£ç ä¸­å¸¸å¸¸å……æ–¥ç€ä¸ UART ç›¸å…³çš„å®ç°ç»†èŠ‚ã€‚è¿™æ ·ä¸€æ¥ï¼Œæœ¬å¯ä»¥é•¿æ—¶é—´ä½¿ç”¨çš„æ¶ˆæ¯å¤„ç†å™¨ä»£ç å˜æˆäº†ä¸€æ®µå›ºä»¶ä»£ç ï¼Œè¿™å¤ªä¸åº”è¯¥äº†ï¼</p></blockquote><p>Iâ€™ve known and understood the need for separating software from hardware for a long time, but Dougâ€™s words clarified how to use the terms software and firmware in relationship to each other.</p><blockquote><p>è™½ç„¶æˆ‘æ„è¯†åˆ°è¦ä»ä½¿ç”¨æ„ä¹‰ä¸Šå°†è½¯ä»¶ä¸ç¡¬ä»¶ã€å›ºä»¶åŒºåˆ†å¼€æ¥ä¹Ÿå·²ç»æœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œä½†æ˜¯å€ŸåŠ© Doug å¯¹è½¯ä»¶å’Œå›ºä»¶çš„å®šä¹‰ï¼Œæˆ‘ç°åœ¨å¯ä»¥å§è¿™ä»¶äº‹æƒ…è¯´å¾—æ›´æ˜ç™½ä¸€äº›ã€‚</p></blockquote><p>For engineers and programmers, the message is clear: Stop writing so much firmware and give your code a chance at a long useful life. Of course, demanding it wonâ€™t make it so. Letâ€™s look at how we can keep embedded software architecture clean to give the software a fighting chance of having a long and useful life.</p><blockquote><p>å¯¹äºç¨‹åºå‘˜å’Œå·¥ç¨‹å¸ˆï¼Œæˆ‘çš„æ„æ€å¾ˆæ˜ç¡®ï¼šä¸è¦å†å†™å›ºä»¶ä»£ç äº†ï¼Œè®©æˆ‘ä»¬çš„ä»£ç æ´»å¾—æ›´ä¹…ç‚¹ï¼å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿä¸èƒ½æ€»æ˜¯ç©ºè°ˆç†å¿µï¼Œä¸‹é¢å°±æ¥çœ‹ä¸€ä¸‹åº”è¯¥å¦‚ä½•é€šè¿‡å¥½çš„æ¶æ„è®¾è®¡è®©åµŒå…¥å¼ä»£ç æ‹¥æœ‰æ›´é•¿çš„æœ‰æ•ˆç”Ÿå‘½å‘¨æœŸã€‚</p></blockquote><h2 id="app-titude-test-ç¨‹åºé€‚ç”¨æµ‹è¯•-æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#app-titude-test-ç¨‹åºé€‚ç”¨æµ‹è¯•-æµ‹è¯•" aria-hidden="true">#</a> APP-TITUDE TEST â€œç¨‹åºé€‚ç”¨æµ‹è¯•â€æµ‹è¯•</h2><p>Why does so much potential embedded software become firmware? It seems that most of the emphasis is on getting the embedded code to work, and not so much emphasis is placed on structuring it for a long useful life. Kent Beck describes three activities in building software (the quoted text is Kentâ€™s words and the italics are my commentary):</p><blockquote><p>ä¸ºä»€ä¹ˆè¿™ä¹ˆå¤šåµŒå…¥å¼è½¯ä»¶æœ€åéƒ½æˆäº†å›ºä»¶ï¼Ÿçœ‹èµ·æ¥ï¼Œå¾ˆå¯èƒ½æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨åšåµŒå…¥å¼è®¾è®¡æ—¶åªå…³æ³¨ä»£ç èƒ½å¦é¡ºåˆ©è¿è¡Œï¼Œå¹¶ä¸å¤ªå…³å¿ƒå…¶ç»“æ„èƒ½å¦æ’‘èµ·ä¸€ä¸ªè¾ƒé•¿çš„æœ‰æ•ˆç”Ÿå‘½å‘¨æœŸã€‚Kent Beck æè¿°äº†è½¯ä»¶æ„å»ºè¿‡ç¨‹ä¸­çš„ä¸‰ä¸ªé˜¶æ®µï¼ˆå¼•å·éƒ¨åˆ†æ˜¯ä»–çš„åŸè¯ï¼Œæ¥·ä½“éƒ¨åˆ†æ˜¯æˆ‘çš„æ³¨è§£ï¼‰ï¼š</p></blockquote><ol><li>â€œFirst make it work.â€ You are out of business if it doesnâ€™t work.</li><li>â€œThen make it right.â€ Refactor the code so that you and others can understand it and evolve it as needs change or are better understood.</li><li>â€œThen make it fast.â€ Refactor the code for â€œneededâ€ performance.</li></ol><hr><blockquote><ol><li>â€œå…ˆè®©ä»£ç å·¥ä½œèµ·æ¥â€â€”â€”å¦‚æœä»£ç ä¸èƒ½å·¥ä½œï¼Œå°±ä¸èƒ½äº§ç”Ÿä»·å€¼ã€‚</li><li>â€œç„¶åå†è¯•å›¾å°†å®ƒå˜å¥½â€”â€”é€šè¿‡å¯¹ä»£ç è¿›è¡Œé‡æ„ï¼Œè®©æˆ‘ä»¬è‡ªå·±å’Œå…¶ä»–äººæ›´å¥½åœ°ç†è§£ä»£ç ï¼Œå¹¶èƒ½æŒ‰ç…§éœ€æ±‚ä¸æ–­åœ°ä¿®æ”¹ä»£ç ã€‚</li><li>â€œæœ€åå†è¯•ç€è®©å®ƒè¿è¡Œå¾—æ›´å¿«â€â€”â€”æŒ‰ç…§æ€§èƒ½æå‡çš„â€œéœ€æ±‚â€æ¥é‡æ„ä»£ç ã€‚</li></ol></blockquote><p>Much of the embedded systems software that I see in the wild seems to have been written with â€œMake it workâ€ in mindâ€”and perhaps also with an obsession for the â€œMake it fastâ€ goal, achieved by adding micro-optimizations at every opportunity. In The Mythical Man-Month, Fred Brooks suggests we â€œplan to throw one away.â€ Kent and Fred are giving virtually the same advice: Learn what works, then make a better solution.</p><blockquote><p>æˆ‘æ‰€è§è¿‡çš„å¤§éƒ¨åˆ†â€œé‡ç”Ÿâ€çš„åµŒå…¥å¼ä»£ç ï¼Œéƒ½åªå…³æ³¨â€œå…ˆè®©å®ƒå·¥ä½œèµ·æ¥â€è¿™ä¸ªç›®æ ‡â€”â€”ä¹Ÿè®¸è¿˜æœ‰äº›å›¢é˜Ÿä¼šåŒæ—¶ç—´è¿·äºâ€œè®©å®ƒæ›´å¿«â€è¿™ä¸ªç›®æ ‡ï¼Œä¸æ”¾è¿‡ä»»ä½•ä¸€ä¸ªæœºä¼šåŠ å…¥å„ç§å¾®ä¼˜åŒ–ã€‚åœ¨ã€Šäººæœˆç¥è¯ã€‹è¿™æœ¬ä¹¦ä¸­ï¼ŒFred Brooks å»ºè®®æˆ‘ä»¬åº”è¯¥éšæ—¶å‡†å¤‡â€œæŠ›å¼ƒä¸€ä¸ªè®¾è®¡â€ã€‚Kent å’Œ Fred è¯´çš„å…¶å®æ˜¯åŒä¸€ä»¶äº‹ï¼šâ€œåœ¨å®è·µä¸­å­¦ä¹ æ­£ç¡®çš„å·¥ä½œæ–¹æ³•ï¼Œç„¶åå†é‡å†™ä¸€ä¸ªæ›´å¥½çš„ç‰ˆæœ¬â€ã€‚</p></blockquote><p>Embedded software is not special when it comes to these problems. Most non-embedded apps are built just to work, with little regard to making the code right for a long useful life.</p><blockquote><p>è¿™ä¸ªå»ºè®®å¯¹éåµŒå…¥å¼è½¯ä»¶ç³»ç»Ÿå¼€å‘åŒæ ·æœ‰ç”¨ã€‚æ¯•ç«Ÿç›®å‰å¤§éƒ¨åˆ†éåµŒå…¥å¼åº”ç”¨ä¹Ÿä»…ä»…åœç•™åœ¨â€œå¯ç”¨â€è¿™ä¸ªç›®æ ‡ä¸Šï¼Œå¾ˆå°‘è€ƒè™‘ä¸ºäº†é•¿ä¹…ä½¿ç”¨è€Œè¿›è¡Œæ­£ç¡®çš„è®¾è®¡ã€‚</p></blockquote><p>Getting an app to work is what I call the App-titude test for a programmer. Programmers, embedded or not, who just concern themselves with getting their app to work are doing their products and employers a disservice. There is much more to programming than just getting an app to work.</p><blockquote><p>å¯¹äºç¨‹åºå‘˜æ¥è¯´ï¼Œè®©ä»–çš„ç¨‹åºå·¥ä½œè¿™ä»¶äº‹åªèƒ½è¢«ç§°ä¸ºâ€œç¨‹åºé€‚ç”¨æµ‹è¯•ï¼ˆapp-titude testï¼‰â€ã€‚ä¸€ä¸ªç¨‹åºå‘˜ï¼Œä¸è®ºä»–å†™çš„æ˜¯å¦æ˜¯åµŒå…¥å¼ç¨‹åºï¼Œå¦‚æœç›®æ ‡ä»…ä»…æ˜¯è®©ç¨‹åºå¯ä»¥å·¥ä½œï¼Œææ€•å¯¹ä»–çš„è€æ¿å’Œè¿™ä¸ªç¨‹åºæœ¬èº«è€Œè¨€éƒ½æ˜¯ä¸€ä»¶åäº‹ã€‚æ¯•ç«Ÿï¼Œç¼–ç¨‹è¿™ä»¶äº‹å¯è¿œä¸æ­¢æ˜¯è®©ç¨‹åºå¯ä»¥å·¥ä½œè¿™ä¹ˆç®€å•ã€‚</p></blockquote><p>As an example of code produced while passing the App-titude test, check out these functions located in one file of a small embedded system:</p><blockquote><p>ä¸‹é¢æˆ‘ä»¬æ¥ç¤ºèŒƒä¸€ä¸‹å¯ä»¥é€šè¿‡â€œç¨‹åºé€‚ç”¨æµ‹è¯•â€çš„ä»£ç æ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚å…ˆæ¥çœ‹ä¸€ä¸ªå°å‹åµŒå…¥å¼ç³»ç»Ÿä¸­æŸä¸ªæºæ–‡ä»¶ä¸­çš„ä¸€æ®µå‡½æ•°å£°æ˜ï¼š</p></blockquote><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token function">ISR</span><span class="token punctuation">(</span>TIMER1_vect<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token function">ISR</span><span class="token punctuation">(</span>INT2_vect<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">btn_Handler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token keyword">float</span> <span class="token function">calc_RPM</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token function">Read_RawData</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">Do_Average</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">Get_Next_Measurement</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">Zero_Sensor_1</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">Zero_Sensor_2</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">Dev_Control</span><span class="token punctuation">(</span><span class="token keyword">char</span> Activation<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token keyword">char</span> <span class="token function">Load_FLASH_Setup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">Save_FLASH_Setup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">Store_DataSet</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token keyword">float</span> <span class="token function">bytes2float</span><span class="token punctuation">(</span><span class="token keyword">char</span> bytes<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">Recall_DataSet</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">Sensor_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">uC_Sleep</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>That list of functions is in the order I found them in the source file. Now Iâ€™ll separate them and group them by concern:</p><blockquote><p>å¯ä»¥çœ‹åˆ°è¯¥æºæ–‡ä»¶ä¸­çš„å‡½æ•°æ˜¯æŒ‰ä¸€å®šé¡ºåºåˆ—å‡ºæ¥çš„ã€‚ç°åœ¨æˆ‘ä»¬è¦æŒ‰ç…§åŠŸèƒ½è¿›è¡Œåˆ†ç»„ï¼š</p></blockquote><ul><li>Functions that have domain logic</li></ul><blockquote><ul><li>ç”¨äºå®šä¹‰åŸŸé€»è¾‘ï¼ˆdomain logicï¼‰çš„å‡½æ•°</li></ul></blockquote><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">float</span> <span class="token function">calc_RPM</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Do_Average</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Get_Next_Measurement</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Zero_Sensor_1</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Zero_Sensor_2</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Functions that set up the hardware platform</li></ul><blockquote><ul><li>ç”¨äºè®¾ç½®ç¡¬ä»¶å¹³å°çš„å‡½æ•°</li></ul></blockquote><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token function">ISR</span><span class="token punctuation">(</span>TIMER1_vect<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token operator">*</span>

<span class="token function">ISR</span><span class="token punctuation">(</span>INT2_vect<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">uC_Sleep</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

Functions that react to the on off button press

<span class="token keyword">void</span> <span class="token function">btn_Handler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Dev_Control</span><span class="token punctuation">(</span><span class="token keyword">char</span> Activation<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>A Function that can get A/D input readings from the hardware</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token class-name">Read_RawData</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>Functions that store values to the persistent storage</li></ul><blockquote><ul><li>ç”¨äºæ‰§è¡ŒæŒä¹…åŒ–å­˜å‚¨çš„å‡½æ•°</li></ul></blockquote><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">char</span> <span class="token class-name">Load_FLASH_Setup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">Save_FLASH_Setup</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">Store_DataSet</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">bytes2float</span><span class="token punctuation">(</span><span class="token keyword">char</span> bytes<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">Recall_DataSet</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Function that does not do what its name implies</li></ul><blockquote><ul><li>åŠŸèƒ½ä¸å…¶åå­—ä¸ç¬¦çš„å‡½æ•°</li></ul></blockquote><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token class-name">Sensor_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Looking at some of the other files in this application, I found many impediments to understanding the code. I also found a file structure that implied that the only way to test any of this code is in the embedded target. Virtually every bit of this code knows it is in a special microprocessor architecture, using â€œextendedâ€ C constructs3 that tie the code to a particular tool chain and microprocessor. There is no way for this code to have a long useful life unless the product never needs to be moved to a different hardware environment.</p><blockquote><p>åœ¨æŸ¥çœ‹è¯¥åº”ç”¨ç¨‹åºå…¶ä»–æºä»£ç æ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘åŒæ ·å‘ç°äº†è®¸å¤šç†è§£ä¸Šçš„éšœç¢ç‚¹ã€‚åŒæ—¶ï¼Œæˆ‘è¿˜å‘ç°è¿™ä¸ªé¡¹ç›®çš„ç»“æ„å†³å®šäº†è¯¥åº”ç”¨ç¨‹åºçš„æ‰€æœ‰ä»£ç åªæœ‰åœ¨æŒ‡å®šç¡¬ä»¶å¹³å°ä¸Šæ‰èƒ½è¢«æµ‹è¯•ã€‚å‡ ä¹ä»£ç çš„æ‰€æœ‰éƒ¨åˆ†éƒ½çŸ¥é“å®ƒè¦è¿è¡Œåœ¨ä¸€ä¸ªç‰¹æ®Šçš„å¾®å¤„ç†å™¨å¹³å°ä¸Šï¼Œå› ä¸ºå®ƒä»¬ç”¨çš„æ˜¯â€œè¢«æ‰©å±•äº†çš„â€ C ç»“æ„ï¼Œéœ€è¦ç‰¹æ®Šçš„å·¥å…·é“¾å’Œå¾®å¤„ç†å™¨æ‰èƒ½æ‰§è¡Œã€‚é™¤éè¿™ä¸ªäº§å“æ°¸è¿œä¸éœ€è¦è¿ç§»åˆ°å¦ä¸€ä¸ªç¡¬ä»¶å¹³å°ä¸Šï¼Œå¦åˆ™è¿™æ®µä»£ç å‡ ä¹ä¸å¯èƒ½æœ‰é•¿ä¹…çš„ä½¿ç”¨ä»·å€¼ã€‚</p></blockquote><p>This application works: The engineer passed the App-titude test. But the application canâ€™t be said to have a clean embedded architecture.</p><blockquote><p>æ‰€ä»¥ä½ çœ‹ï¼Œè¿™æ®µä»£ç çš„ç¡®èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼šå®ƒçš„å·¥ç¨‹å¸ˆä¹Ÿé€šè¿‡äº†â€œç¨‹åºé€‚ç”¨æ€§æµ‹è¯•â€ï¼Œä½†æˆ‘ä»¬ä¸èƒ½è¯´è¯¥åº”ç”¨ç¨‹åºæœ‰ä¸€å¥—æ•´æ´çš„åµŒå…¥å¼æ¶æ„ã€‚</p></blockquote><h2 id="the-target-hardware-bottleneck-ç›®æ ‡ç¡¬ä»¶ç“¶é¢ˆ" tabindex="-1"><a class="header-anchor" href="#the-target-hardware-bottleneck-ç›®æ ‡ç¡¬ä»¶ç“¶é¢ˆ" aria-hidden="true">#</a> THE TARGET-HARDWARE BOTTLENECK ç›®æ ‡ç¡¬ä»¶ç“¶é¢ˆ</h2><p>There are many special concerns that embedded developers have to deal with that non-embedded developers do notâ€”for example, limited memory space, real-time constraints and deadlines, limited IO, unconventional user interfaces, and sensors and connections to the real world. Most of the time the hardware is concurrently developed with the software and firmware. As an engineer developing code for this kind of system, you may have no place to run the code. If thatâ€™s not bad enough, once you get the hardware, it is likely that the hardware will have its own defects, making software development progress even slower than usual.</p><blockquote><p>åµŒå…¥å¼ç³»ç»Ÿçš„ç¨‹åºå‘˜é€šå¸¸éœ€è¦å¤„ç†å¾ˆå¤šåœ¨å†™éåµŒå…¥å¼ç³»ç»Ÿæ—¶ä¸éœ€è¦å…³å¿ƒçš„äº‹æƒ…â€”â€”ä¾‹å¦‚ï¼Œæœ‰é™çš„åœ°å€ç©ºé—´ã€å®æ—¶æ€§é™åˆ¶ã€è¿è¡Œæˆªæ­¢æ—¶é—´ã€æœ‰é™çš„ I/O èƒ½åŠ›ã€éå¸¸è§„çš„ç”¨æˆ·æ¥å£ã€æ„Ÿåº”å™¨ï¼Œä»¥åŠå…¶ä»–ä¸ç‰©ç†ä¸–ç•Œçš„å®é™…é“¾æ¥ã€‚å¤§éƒ¨åˆ†æ—¶å€™ï¼Œè¿™äº›ç³»ç»Ÿçš„ç¡¬ä»¶æ˜¯å’Œå®ƒçš„è½¯ä»¶ã€å›ºä»¶å¹¶è¡Œå¼€å‘çš„ã€‚å·¥ç¨‹å¸ˆåœ¨ä¸ºè¿™ç§ç³»ç»Ÿç¼–å†™ä»£ç çš„æ—¶å€™ï¼Œå¾€å¾€æ²¡æœ‰ä»»ä½•åœ°æ–¹å¯ä»¥è¿è¡Œã€‚å¦‚æœä½ è®¤ä¸ºè¿™è¿˜ä¸ç®—ç³Ÿç³•çš„è¯ï¼Œè¯·æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬è¦ç­‰åˆ°çœŸæ­£æ‹¿åˆ°ç¡¬ä»¶æ—¶ï¼Œæ‰èƒ½äº†è§£ä»£ç åœ¨è¯¥ç¡¬ä»¶ä¸Šå­˜åœ¨ç€å“ªäº›æ„æ–™ä¹‹å¤–çš„ç¼ºé™·ï¼Œè¿™ä¼šåœ¨å¤šå¤§ç¨‹åº¦ä¸Šæ‹–æ…¢æˆ‘ä»¬çš„å¼€å‘è¿›åº¦?</p></blockquote><p>Yes, embedded is special. Embedded engineers are special. But embedded development is not so special that the principles in this book are not applicable to embedded systems.</p><blockquote><p>æ˜¯çš„ï¼Œæˆ‘ä»¬æ‰¿è®¤åµŒå…¥å¼ç³»ç»Ÿçš„å¼€å‘æœ‰å…¶ç‰¹æ®Šæ€§ï¼ŒåµŒå…¥å¼å·¥ç¨‹å¸ˆçš„å·¥ä½œæœ‰å…¶ç‰¹æ®Šæ€§ï¼Œä½†æˆ‘ä»¬å¹¶ä¸è®¤ä¸ºåµŒå…¥å¼å¼€å‘ç‰¹æ®Šåˆ°æœ¬ä¹¦æ‰€è®²çš„åŸåˆ™éƒ½ä¸é€‚ç”¨çš„ç¨‹åº¦ã€‚</p></blockquote><p>One of the special embedded problems is the target-hardware bottleneck. When embedded code is structured without applying clean architecture principles and practices, you will often face the scenario in which you can test your code only on the target. If the target is the only place where testing is possible, the target-hardware bottleneck will slow you down.</p><blockquote><p>æ ‡ç¡¬ä»¶ç“¶é¢ˆï¼ˆtarget-hardware bottleneckï¼‰æ˜¯åµŒå…¥å¼å¼€å‘æ‰€ç‰¹æœ‰çš„ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰é‡‡ç”¨æŸç§æ¸…æ™°çš„æ¶æ„æ¥è®¾è®¡åµŒå…¥å¼ç³»ç»Ÿçš„ä»£ç ç»“æ„ï¼Œå°±ç»å¸¸ä¼šé¢ä¸´åªèƒ½åœ¨ç›®æ ‡ç³»ç»Ÿå¹³å°ä¸Šæµ‹è¯•ä»£ç çš„éš¾é¢˜ã€‚å¦‚æœåªèƒ½åœ¨ç‰¹å®šçš„å¹³å°ä¸Šæµ‹è¯•ä»£ç ï¼Œé‚£ä¹ˆè¿™ä¸€å®šä¼šæ‹–æ…¢é¡¹ç›®çš„å¼€å‘è¿›åº¦ã€‚</p></blockquote><h3 id="a-clean-embedded-architecture-is-a-testable-embedded-architecture-æ•´æ´çš„åµŒå…¥å¼æ¶æ„å°±æ˜¯å¯æµ‹è¯•çš„åµŒå…¥å¼æ¶æ„" tabindex="-1"><a class="header-anchor" href="#a-clean-embedded-architecture-is-a-testable-embedded-architecture-æ•´æ´çš„åµŒå…¥å¼æ¶æ„å°±æ˜¯å¯æµ‹è¯•çš„åµŒå…¥å¼æ¶æ„" aria-hidden="true">#</a> A CLEAN EMBEDDED ARCHITECTURE IS A TESTABLE EMBEDDED ARCHITECTURE æ•´æ´çš„åµŒå…¥å¼æ¶æ„å°±æ˜¯å¯æµ‹è¯•çš„åµŒå…¥å¼æ¶æ„</h3><p>Letâ€™s see how to apply some of the architectural principles to embedded software and firmware to help you eliminate the target-hardware bottleneck.</p><blockquote><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…·ä½“åº”å¦‚ä½•å°†æ¶æ„è®¾è®¡çš„åŸåˆ™åº”ç”¨åœ¨åµŒå…¥å¼è½¯ä»¶å’Œå›ºä»¶ä¸Šï¼Œä»¥é¿å…é™·å…¥ç›®æ ‡ç¡¬ä»¶ç“¶é¢ˆã€‚</p></blockquote><h3 id="layers-åˆ†å±‚" tabindex="-1"><a class="header-anchor" href="#layers-åˆ†å±‚" aria-hidden="true">#</a> Layers åˆ†å±‚</h3><p>Layering comes in many flavors. Letâ€™s start with three layers, as shown in Figure 29.1. At the bottom, there is the hardware. As Doug warns us, due to technology advances and Mooreâ€™s law, the hardware will change. Parts become obsolete, and new parts use less power or provide better performance or are cheaper. Whatever the reason, as an embedded engineer, I donâ€™t want to have a bigger job than is necessary when the inevitable hardware change finally happens.</p><blockquote><p>åˆ†å±‚å¯ä»¥æœ‰å¾ˆå¤šç§æ–¹å¼ï¼Œè¿™é‡Œå…ˆæŒ‰å›¾ 29.1 æ‰€ç¤ºçš„è®¾è®¡å°†ç³»ç»Ÿåˆ†æˆä¸‰å±‚ã€‚é¦–å…ˆï¼Œåº•å±‚æ˜¯ç¡¬ä»¶å±‚ã€‚æ­£å¦‚ Doug è­¦å‘Šæˆ‘ä»¬çš„é‚£æ ·ï¼Œç”±äºç§‘æŠ€çš„è¿›æ­¥ä¸æ‘©å°”å®šå¾‹ï¼Œç¡¬ä»¶æ˜¯ä¸€å®šä¼šæ”¹å˜çš„ã€‚æ—§çš„ç¡¬ä»¶ä¸è§å°†ä¼šè¢«æ·˜æ±°ï¼Œæ–°çš„ç¡¬ä»¶éƒ¨ä»¶å¯èƒ½è€—ç”µé‡æ›´å°‘ï¼Œæˆ–è€…æ€§èƒ½æ›´å¥½ï¼Œæˆ–è€…ä»·æ ¼æ›´ä¾¿å®œã€‚ä¸ç®¡ç¡¬ä»¶æ›´æ–°çš„åŸå› æ˜¯ä»€ä¹ˆï¼Œä½œä¸ºåµŒå…¥å¼å·¥ç¨‹å¸ˆï¼Œæˆ‘ä»¬éƒ½ä¸ä¼šå¸Œæœ›è¿™äº›ä¸å¯é¿å…çš„ç¡¬ä»¶å˜åŠ¨å¸¦æ¥æ›´å¤šçš„å·¥ä½œé‡ã€‚</p></blockquote><!----><p>The separation between hardware and the rest of the system is a givenâ€”at least once the hardware is defined (Figure 29.2). Here is where the problems often begin when you are trying to pass the App-titude test. There is nothing that keeps hardware knowledge from polluting all the code. If you are not careful about where you put things and what one module is allowed to know about another module, the code will be very hard to change. Iâ€™m not just talking about when the hardware changes, but when the user asks for a change, or when a bug needs to be fixed.</p><blockquote><p>ç¡¬ä»¶ä¸ç³»ç»Ÿå…¶ä»–éƒ¨åˆ†çš„åˆ†éš”æ˜¯æ—¢å®šçš„â€”â€”è‡³å°‘åœ¨ç¡¬ä»¶è®¾è®¡å®Œæˆä¹‹åå¦‚æ­¤ï¼ˆå¦‚å›¾ 29.2 æ‰€ç¤ºï¼‰ã€‚è¿™ä¹Ÿæ˜¯åœ¨æˆ‘ä»¬è¯•å›¾é€šè¿‡ç¨‹åºé€‚ç”¨æµ‹è¯•ä¹‹æ—¶å¾€å¾€ä¼šå‘ç”Ÿé—®é¢˜çš„åœ°æ–¹ã€‚å› ä¸ºæ²¡æœ‰ä»€ä¹ˆä¸œè¥¿å¯ä»¥çœŸæ­£é˜»ç¢ç¡¬ä»¶å®ç°ç»†èŠ‚æ±¡æŸ“åˆ°åº”ç”¨ä»£ç ã€‚å¦‚æœæˆ‘ä»¬åœ¨æ„å»ºä»£ç çš„æ—¶å€™ä¸å¤Ÿå°å¿ƒï¼Œæ²¡æœ‰å°å¿ƒå®‰æ’å“ªäº›æ¨¡å—ä¹‹é—´å¯ä»¥äº’ç›¸ä¾èµ–ï¼Œä»£ç å¾ˆå¿«å°±éå¸¸éš¾ä»¥æ›´æ”¹äº†ã€‚è¯·æ³¨æ„ï¼Œè¿™é‡Œæ‰€è¯´çš„å˜æ›´ä¸ä»…ä»…æ˜¯æŒ‡æ¥è‡ªç¡¬ä»¶çš„å˜æ›´ï¼Œè¿˜åŒ…æ‹¬ç”¨æˆ·çš„åŠŸèƒ½æ€§å˜æ›´ã€ä¿®å¤ä»£ç ä¸­çš„ Bugã€‚</p></blockquote><!----><p>Software and firmware intermingling is an anti-pattern. Code exhibiting this anti-pattern will resist changes. In addition, changes will be dangerous, often leading to unintended consequences. Full regression tests of the whole system will be needed for minor changes. If you have not created externally instrumented tests, expect to get bored with manual testsâ€”and then you can expect new bug reports.</p><blockquote><p>å¦å¤–ï¼Œè½¯ä»¶ä¸å›ºä»¶é›†æˆåœ¨ä¸€èµ·ä¹Ÿå±äºè®¾è®¡ä¸Šçš„åæ¨¡å¼ï¼ˆanti-patternï¼‰ã€‚ç¬¦åˆè¿™ç§åæ¨¡å¼çš„ä»£ç ä¿®æ”¹èµ·æ¥éƒ½ä¼šå¾ˆå›°éš¾ã€‚åŒæ—¶ï¼Œè¿™ç§ä»£ç ä¹Ÿå¾ˆå±é™©ï¼Œå®¹æ˜“é€ æˆæ„å¤–äº‹æ•…ï¼Œè¿™å¯¼è‡´å®ƒç»å†ä»»ä½•å¾®å°‘çš„æ”¹åŠ¨éƒ½éœ€è¦è¿›è¡Œå®Œæ•´çš„å›å½’æµ‹è¯•ã€‚å¦‚æœæ²¡æœ‰å®Œå–„çš„æµ‹è¯•æµç¨‹ï¼Œé‚£ä¹ˆä½ å°±ç­‰ç€æ— ç©·æ— å°½çš„æ‰‹å·¥æµ‹è¯•å§â€”â€”åŒæ—¶è¿˜æœ‰çº·æ²“è€Œæ¥çš„ Bug æŠ¥å‘Šã€‚</p></blockquote><h3 id="the-hardware-is-a-detail-ç¡¬ä»¶æ˜¯å®ç°ç»†èŠ‚" tabindex="-1"><a class="header-anchor" href="#the-hardware-is-a-detail-ç¡¬ä»¶æ˜¯å®ç°ç»†èŠ‚" aria-hidden="true">#</a> The Hardware Is a Detail ç¡¬ä»¶æ˜¯å®ç°ç»†èŠ‚</h3><p>The line between software and firmware is typically not so well defined as the line between code and hardware, as shown in Figure 29.3.</p><blockquote><p>è½¯ä»¶ä¸å›ºä»¶ä¹‹é—´çš„è¾¹ç•Œå¾€å¾€æ²¡æœ‰ä»£ç ä¸ç¡¬ä»¶ä¹‹é—´çš„è¾¹ç•Œé‚£ä¹ˆæ¸…æ™°ï¼Œå¦‚å›¾ 29.3 æ‰€ç¤ºã€‚</p></blockquote><!----><p>One of your jobs as an embedded software developer is to firm up that line. The name of the boundary between the software and the firmware is the hardware abstraction layer (HAL) (Figure 29.4). This is not a new idea: It has been in PCs since the days before Windows.</p><blockquote><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬çš„å·¥ä½œä¹‹ä¸€å°±æ˜¯å°†è¿™ä¸ªè¾¹ç•Œå®šä¹‰å¾—æ›´æ¸…æ™°ä¸€äº›ã€‚è½¯ä»¶ä¸å›ºä»¶ä¹‹é—´çš„è¾¹ç•Œè¢«ç§°ä¸ºç¡¬ä»¶æŠ½è±¡å±‚ï¼ˆHALï¼‰ï¼Œå¦‚å›¾ 29.4 æ‰€ç¤ºã€‚è¿™ä¸æ˜¯ä¸€ä¸ªæ–°æ¦‚å¿µï¼Œå®ƒåœ¨ PC ä¸Šçš„å­˜åœ¨ç”šè‡³å¯ä»¥è¿½æº¯åˆ° Windows è¯ç”Ÿä¹‹å‰ã€‚</p></blockquote><!----><p>The HAL exists for the software that sits on top of it, and its API should be tailored to that softwareâ€™s needs. As an example, the firmware can store bytes and arrays of bytes into flash memory. In contrast, the application needs to store and read name/value pairs to some persistence mechanism. The software should not be concerned that the name/value pairs are stored in flash memory, a spinning disk, the cloud, or core memory. The HAL provides a service, and it does not reveal to the software how it does it. The flash implementation is a detail that should be hidden from software.</p><blockquote><p>HAL çš„å­˜åœ¨æ˜¯ä¸ºäº†ç»™å®ƒä¸Šå±‚çš„è½¯ä»¶æä¾›æœåŠ¡ï¼ŒHAL çš„ API åº”è¯¥æŒ‰ç…§è¿™äº›è½¯ä»¶çš„éœ€è¦æ¥é‡èº«å®šåšã€‚ä¾‹å¦‚ï¼Œå›ºä»¶å¯ä»¥ç›´æ¥å°†å­—èŠ‚å’Œå­—èŠ‚ç»„å­˜å…¥é—ªå­˜ä¸­ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œè½¯ä»¶éœ€è¦çš„æ˜¯ä»æŸç§æŒä¹…åŒ–å¹³å°ä¿å­˜å’Œè¯»å– name/value å¯¹ä¿¡æ¯ï¼Œå®ƒä¸åº”è¯¥å…³å¿ƒè‡ªå·±ä¿¡æ¯åˆ°åº•æ˜¯è¢«å­˜å‚¨åˆ°é—ªå­˜ä¸­ã€ç£ç›˜ä¸­ã€äº‘ç«¯å­˜å‚¨ä¸­ï¼Œè¿˜æ˜¯åœ¨å†…å­˜ä¸­è¯»å–/å­˜å‚¨è¿™äº›ä¿¡æ¯ã€‚æ€»ä¹‹ï¼ŒHAL çš„ä½œç”¨æ˜¯ä¸ºè½¯ä»¶éƒ¨åˆ†æä¾›ä¸€ç§æœåŠ¡ï¼Œä»¥ä¾¿éšè—å…·ä½“çš„å®ç°ç»†èŠ‚ã€‚æ¯•ç«Ÿæ˜¯ä¸“é—¨é’ˆå¯¹é—ªå­˜çš„å®ç°ä»£ç æ˜¯ä¸€ç§ç»†èŠ‚ä¿¡æ¯ï¼Œå®ƒåº”è¯¥ä¸è½¯ä»¶éƒ¨åˆ†éš”ç¦»ã€‚</p></blockquote><p>As another example, an LED is tied to a GPIO bit. The firmware could provide access to the GPIO bits, where a HAL might provide Led_TurnOn(5). That is a pretty low-level hardware abstraction layer. Letâ€™s consider raising the level of abstraction from a hardware perspective to the software/product perspective. What is the LED indicating? Suppose that it indicated low battery power. At some level, the firmware (or a board support package) could provide Led_TurnOn(5), while the HAL provides Indicate_LowBattery(). You can see the HAL expressing services needed by the application. You can also see that layers may contain layers. It is more of a repeating fractal pattern than a limited set of predefined layers. The GPIO assignments are details that should be hidden from the software.</p><blockquote><p>æˆ‘ä»¬å†æ¥çœ‹å¦ä¸€ä¸ªä¾‹å­ï¼šæœ‰ä¸€ä¸ª LED è¢«è¿æ¥åˆ°ä¸€ä¸ª GPIO æ¯”ç‰¹ä½ä¸Šã€‚å›ºä»¶å¯ä»¥ç›´æ¥æ“ä½œ GPIO æ¯”ç‰¹ä½ï¼Œè€Œ HAL åˆ™ä¼šæä¾›ä¸€ä¸ª Led_TurnOn(5) æ•°ã€‚è¿™ç§ç¡¬ä»¶æŠ½è±¡å±‚çš„å±‚æ¬¡æ˜¯ç›¸å½“ä½çš„ã€‚ç°åœ¨ï¼Œå‡è®¾æˆ‘ä»¬æƒ³å°†æŠ½è±¡å±‚æ¬¡ä»ç¡¬ä»¶å±‚æ¬¡æå‡åˆ°è½¯ä»¶/äº§å“çš„å±‚æ¬¡ã€‚è¿™æ—¶å€™å°±è¦å¼„æ¸…æ¥šè¿™ä¸ª LED åˆ°åº•ä»£è¡¨çš„æ˜¯ä»€ä¹ˆã€‚å‡è®¾å®ƒä»£è¡¨äº†ç”µæ± ç”µé‡ä¸è¶³ï¼Œé‚£ä¹ˆå…¶å›ºç ï¼ˆæˆ–è¯¥ç”µè·¯æ¿çš„æ”¯æŒåŒ…ï¼‰å¯èƒ½å°±ä¼šè´Ÿè´£æä¾› Led_TurnOn(5) å‡½æ•°ï¼Œè€Œ HAL åˆ™è´Ÿè´£æä¾› Indicate_LowBattery() å‡½æ•°ã€‚ç”±æ­¤å¯è§ï¼ŒHAL å±‚æ˜¯æŒ‰ç…§åº”ç”¨ç¨‹åºçš„éœ€è¦æ¥æä¾›æœåŠ¡çš„ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½çœ‹å‡ºæ¥ç³»ç»Ÿçš„æ¯ä¸€ä¸ªåˆ†å±‚ä¸­éƒ½å¯ä»¥åŒ…å«è®¸å¤šåˆ†å±‚ã€‚ç›¸å¯¹äºä¹‹å‰çš„å›ºå®šåˆ†å±‚æ³•ï¼Œè¿™é‡Œæ›´åƒæ˜¯ä¸€ç§æ— é™åˆ†å±‚æ¨¡å¼ã€‚æ€»ä¹‹ï¼ŒGPIO ä½çš„å¯¹åº”å…³ç³»åº”è¯¥æ˜¯ä¸€ä¸ªå…·ä½“çš„å®ç°ç»†èŠ‚ï¼Œå®ƒåº”è¯¥ä¸è½¯ä»¶éƒ¨åˆ†éš”ç¦»ã€‚</p></blockquote><h3 id="don-t-reveal-hardware-details-to-the-user-of-the-hal-ä¸è¦å‘-hal-çš„ç”¨æˆ·æš´éœ²ç¡¬ä»¶ç»†èŠ‚" tabindex="-1"><a class="header-anchor" href="#don-t-reveal-hardware-details-to-the-user-of-the-hal-ä¸è¦å‘-hal-çš„ç”¨æˆ·æš´éœ²ç¡¬ä»¶ç»†èŠ‚" aria-hidden="true">#</a> DONâ€™T REVEAL HARDWARE DETAILS TO THE USER OF THE HAL ä¸è¦å‘ HAL çš„ç”¨æˆ·æš´éœ²ç¡¬ä»¶ç»†èŠ‚</h3><p>A clean embedded architectureâ€™s software is testable off the target hardware. A successful HAL provides that seam or set of substitution points that facilitate off-target testing.</p><blockquote><p>ä¾ç…§æ•´æ´çš„åµŒå…¥å¼æ¶æ„æ‰€å»ºæ„çš„è½¯ä»¶åº”è¯¥æ˜¯å¯ä»¥è„±ç¦»ç›®æ ‡ç¡¬ä»¶å¹³å°æ¥è¿›è¡Œæµ‹è¯•çš„ã€‚å› ä¸ºè®¾è®¡åˆç†çš„ HAL å¯ä»¥ä¸ºæˆ‘ä»¬è„±ç¦»ç¡¬ä»¶å¹³å°çš„æµ‹è¯•æä¾›ç›¸åº”çš„æ”¯æ’‘ã€‚</p></blockquote><h3 id="the-processor-is-a-detail" tabindex="-1"><a class="header-anchor" href="#the-processor-is-a-detail" aria-hidden="true">#</a> The Processor Is a Detail</h3><p>When your embedded application uses a specialized tool chain, it will often provide header files to <code>&lt;i&gt;</code>help you<code>&lt;/i&gt;</code>.4 These compilers often take liberties with the C language, adding new keywords to access their processor features. The code will look like C, but it is no longer C.</p><blockquote><p>å½“æˆ‘ä»¬çš„åµŒå…¥å¼åº”ç”¨ä¾èµ–äºæŸç§ç‰¹æ®Šçš„å·¥å…·é“¾æ—¶ï¼Œè¯¥å·¥å…·é“¾é€šå¸¸ä¼šä¸ºæˆ‘ä»¬æä¾›ä¸€äº›â€œ<code>&lt;i&gt;å¸®åŠ©&lt;/i&gt;</code>&quot;æ€§è´¨çš„å¤´æ–‡ä»¶ã€‚è¿™äº›ç¼–è¯‘å™¨å¾€å¾€ä¼šè‡ªå¸¦ä¸€äº›åŸºäº C è¯­è¨€çš„æ‰©å±•åº“ï¼Œå¹¶æ·»åŠ ä¸€äº›ç”¨äºè®¿é—®ç‰¹æ®ŠåŠŸèƒ½çš„å…³é”®è¯ã€‚è¿™ä¼šå¯¼è‡´è¿™äº›ç¨‹åºçš„ä»£ç çœ‹èµ·æ¥ä»ç„¶ç”¨çš„æ˜¯ C è¯­è¨€ï¼Œä½†å®é™…ä¸Šå®ƒä»¬å·²ç»ä¸æ˜¯ C è¯­è¨€äº†ã€‚</p></blockquote><p>Sometimes vendor-supplied C compilers provide what look like global variables to give access directly to processor registers, IO ports, clock timers, IO bits, interrupt controllers, and other processor functions. It is helpful to get access to these things easily, but realize that any of your code that uses these helpful facilities is no longer C. It wonâ€™t compile for another processor, or maybe even with a different compiler for the same processor.</p><blockquote><p>æœ‰æ—¶å€™ï¼Œè¿™äº›åµŒå…¥å¼åº”ç”¨çš„æä¾›å•†æ‰€æŒ‡å®šçš„ C ç¼–è¯‘å™¨è¿˜ä¼šæä¾›ç±»ä¼¼äºå…¨å±€å˜é‡çš„åŠŸèƒ½ï¼Œä»¥ä¾¿æˆ‘ä»¬ç›´æ¥è®¿é—®å¯„å­˜å™¨ã€I/O ç«¯å£ã€æ—¶é’Ÿä¿¡æ¯ã€I/O ä½ã€ä¸­æ–­æ§åˆ¶å™¨ä»¥åŠå…¶ä»–å¤„ç†å™¨å‡½æ•°ï¼Œè¿™äº›å‡½æ•°ä¼šæå¤§åœ°æ–¹ä¾¿æˆ‘ä»¬å¯¹ç›¸å…³ç¡¬ä»¶çš„è®¿é—®ã€‚ä½†è¯·æ³¨æ„ï¼Œä¸€æ—¦ä½ åœ¨ä»£ç ä¸­ä½¿ç”¨äº†è¿™äº›å‡½æ•°ï¼Œä½ å†™çš„å°±ä¸å†æ˜¯ C è¯­è¨€ç¨‹åºï¼Œå®ƒå°±ä¸èƒ½ç”¨å…¶ä»–ç¼–è¯‘å™¨æ¥ç¼–è¯‘äº†ï¼Œç”šè‡³å¯èƒ½è¿åŒä¸€ä¸ªå¤„ç†å™¨çš„ä¸åŒç¼–è¯‘å™¨ä¹Ÿä¸è¡Œã€‚</p></blockquote><p>I would hate to think that the silicon and tool provider is being cynical, tying your product to the compiler. Letâ€™s give the provider the benefit of a doubt by assuming that it is truly trying to help. But now itâ€™s up to you to use that help in a way that does not hurt in the future. You will have to limit which files are allowed to know about the C extensions.</p><blockquote><p>æˆ‘ä¸æƒ³è¯´è¿™æ˜¯æä¾›å•†æ•…æ„ç»™æˆ‘ä»¬è®¾ç½®çš„é™·é˜±ï¼Œå³ä¾¿æˆ‘ä»¬å‡è®¾è¿™äº›ç¡¬ä»¶æä¾›å•†è¿™æ ·åšçœŸçš„æ˜¯ä¸ºäº†â€œå¸®åŠ©â€æˆ‘ä»¬ï¼Œæˆ‘ä»¬è‡ªå·±ä¹Ÿè¦çŸ¥é“å¦‚ä½•æ¥åˆ©ç”¨è¿™äº›â€œå¸®åŠ©â€ï¼Œè¿™æ‰æ˜¯é—®é¢˜çš„å…³é”®ã€‚ä¸ºé¿å…è‡ªå·±çš„ä»£ç åœ¨æœªæ¥å‡ºç°é—®é¢˜ï¼Œæˆ‘ä»¬å°±å¿…é¡»é™åˆ¶è¿™äº› C æ‰©å±•çš„ä½¿ç”¨èŒƒå›´ã€‚</p></blockquote><p>Letâ€™s look at this header file designed for the ACME family of DSPsâ€”you know, the ones used by Wile E. Coyote:</p><blockquote><p>ä¸‹é¢æ¥çœ‹ä¸€ä¸‹é’ˆå¯¹ ACME DSPï¼ˆæ•°å­—ä¿¡å·å¤„ç†å™¨ï¼‰ç³»ç»Ÿè®¾è®¡çš„å¤´æ–‡ä»¶â€”â€”While E Coyote é‡‡ç”¨çš„å°±æ˜¯è¿™ä¸ªç³»ç»Ÿï¼š</p></blockquote><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_ACME_STD_TYPES</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_ACME_STD_TYPES</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>_ACME_X42<span class="token punctuation">)</span></span></span>
    <span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span>        Uint_32<span class="token punctuation">;</span>
    <span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span>      Uint_16<span class="token punctuation">;</span>
    <span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span>       Uint_8<span class="token punctuation">;</span>

    <span class="token keyword">typedef</span> <span class="token keyword">int</span>                 Int_32<span class="token punctuation">;</span>
    <span class="token keyword">typedef</span> <span class="token keyword">short</span>               Int_16<span class="token punctuation">;</span>
    <span class="token keyword">typedef</span> <span class="token keyword">char</span>                Int_8<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>_ACME_A42<span class="token punctuation">)</span></span></span>
    <span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span>       Uint_32<span class="token punctuation">;</span>
    <span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span>        Uint_16<span class="token punctuation">;</span>
    <span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span>       Uint_8<span class="token punctuation">;</span>

    <span class="token keyword">typedef</span> <span class="token keyword">long</span>                Int_32<span class="token punctuation">;</span>
    <span class="token keyword">typedef</span> <span class="token keyword">int</span>                 Int_16<span class="token punctuation">;</span>
    <span class="token keyword">typedef</span> <span class="token keyword">char</span>                Int_8<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">error</span> <span class="token expression"><span class="token operator">&lt;</span>acmetypes<span class="token punctuation">.</span>h<span class="token operator">&gt;</span> is not supported <span class="token keyword">for</span> this environment</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The acmetypes.h header file should not be used directly. If you do, your code gets tied to one of the ACME DSPs. You are using an ACME DSP, you say, so what is the harm? You canâ€™t compile your code unless you include this header. If you use the header and define <code>__ACME_X42</code> or <code>__ACME_A42</code>, your integers will be the wrong size if you try to test your code off-target. If that is not bad enough, one day youâ€™ll want to port your application to another processor, and you will have made that task much more difficult by not choosing portability and by not limiting what files know about ACME.</p><blockquote><p>è¯¥ <code>acmetypes.h</code> å¤´æ–‡ä»¶é€šå¸¸ä¸åº”è¯¥ç›´æ¥ä½¿ç”¨ã€‚å› ä¸ºå¦‚æœè¿™æ ·åšçš„è¯ï¼Œä»£ç å°±å’ŒæŸä¸ª ACME DSP ç»‘å®šåœ¨ä¸€èµ·äº†ã€‚è¿™æ—¶å€™ä½ å¯èƒ½ä¼šé—®ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå†™ä»£ç ä¸å°±æ˜¯ä¸ºäº†ä½¿ç”¨ ACME DSP å—ï¼Ÿä¸å¼•ç”¨è¿™ä¸ªå¤´æ–‡ä»¶å¦‚ä½•ç¼–è¯‘ä»£ç å‘¢ï¼Ÿä½†å¦‚æœå¼•ç”¨äº†è¿™ä¸ªå¤´æ–‡ä»¶ï¼Œå°±ç­‰äºåŒæ—¶å®šä¹‰äº† <code>__ACME_X42</code> å’Œ <code>__ACME_A42</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ä»£ç åœ¨å¹³å°ä¹‹å¤–è¿›è¡Œæµ‹è¯•çš„æ—¶å€™æ•´æ•°ç±»å‹çš„å¤§å°å°±ä¼šæ˜¯é”™è¯¯çš„ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œæœ‰ä¸€å¤©å½“æˆ‘ä»¬æƒ³å°†ä»£ç è¿ç§»åˆ°å¦å¤–ä¸€ä¸ªå¤„ç†å™¨ä¸Šçš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰åœ¨è¿™é‡Œé™åˆ¶ ACME å¤´æ–‡ä»¶è¢«å¼•ç”¨çš„èŒƒå›´ï¼Œå°±ä¼šå¤§å¤§å¢åŠ è¿™é¡¹è¿ç§»å·¥ä½œçš„éš¾åº¦ã€‚</p></blockquote><p>Instead of using acmetypes.h, you should try to follow a more standardized path and use stdint.h. But what if the target compiler does not provide stdint.h? You can write this header file. The stdint.h you write for target builds uses the acmetypes.h for target compiles like this:</p><blockquote><p>å› æ­¤åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åº”è¯¥ç”¨æ ‡å‡†çš„ <code>stdint.h</code> æ¥æ›¿ä»£ <code>acmetypes.h</code>ã€‚å¦‚æœç›®æ ‡ç¼–è¯‘å™¨æ²¡æœ‰æä¾› <code>stdint.h</code> çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±å†™ä¸€ä¸ªã€‚ä¾‹å¦‚ï¼Œä¸‹é¢å°±æ˜¯ä¸€ä¸ªé’ˆå¯¹ç›®æ ‡ç¼–è¯‘å™¨çš„ï¼Œå¯ä»¥ç”¨ <code>acmetypes.h</code> æ¥æ„å»ºç›®æ ‡çš„è‡ªå®šä¹‰ <code>stdint.h</code>ï¼š</p></blockquote><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_STDINT_H_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_STDINT_H_</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;acmetypes.h&gt;</span></span>

<span class="token keyword">typedef</span> Uint_32 <span class="token class-name">uint32_t</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> Uint_16 <span class="token class-name">uint16_t</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> Uint_8  <span class="token class-name">uint8_t</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> Int_32  <span class="token class-name">int32_t</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> Int_16  <span class="token class-name">int16_t</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> Int_8   <span class="token class-name">int8_t</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Having your embedded software and firmware use stdint.h helps keep your code clean and portable. Certainly, all of the software should be processor independent, but not all of the firmware can be. This next code snippet takes advantage of special extensions to C that gives your code access to the peripherals in the micro-controller. Itâ€™s likely your product uses this micro-controller so that you can use its integrated peripherals. This function outputs a line that says &quot;hi&quot; to the serial output port. (This example is based on real code from the wild.)</p><blockquote><p>ä½¿ç”¨ <code>stdint.h</code> æ¥ç¼–å†™åµŒå…¥å¼çš„è½¯ä»¶å’Œå›ºä»¶ï¼Œä½ çš„ä»£ç ä¼šæ˜¯æ•´æ´ä¸”å¯ç§»æ¤çš„ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬åº”è¯¥è®©æ‰€æœ‰çš„è½¯ä»¶éƒ½ç‹¬ç«‹äºå¤„ç†å™¨ï¼Œä½†è¿™å¹¶ä¸æ˜¯æ‰€æœ‰å›ºä»¶éƒ½å¯ä»¥åšåˆ°çš„ã€‚ä¸‹é¢è¿™æ®µä»£ç ä½¿ç”¨äº†ç‰¹æ®Šçš„ C æ‰©å±•æ¥è®¿é—®å¾®å¤„ç†å™¨çš„é…ä»¶ï¼Œè¿™æ ·åšçš„ç›®çš„å¾ˆå¯èƒ½å°±æ˜¯ä¸ºäº†ä½¿ç”¨è¿™ä¸ªé…ä»¶ã€‚è¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯è¾“å‡ºä¸€è¡Œ&quot;hi&quot;åˆ°ä¸²å£ã€‚ï¼ˆè¯¥ä¾‹å­æ¥è‡ªäºä¸€ä¸ªçœŸå®é¡¹ç›®ã€‚ï¼‰</p></blockquote><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">say_hi</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  IE <span class="token operator">=</span> <span class="token number">0</span>b11000000<span class="token punctuation">;</span>
  SBUF0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>TI_0 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  TI_0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  SBUF0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0x69</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>TI_0 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  TI_0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  SBUF0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0x0a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>TI_0 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  TI_0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  SBUF0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0x0d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>TI_0 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  TI_0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  IE <span class="token operator">=</span> <span class="token number">0</span>b11010000<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>There are lots of problems with this small function. One thing that might jump out at you is the presence of 0b11000000. This binary notation is cool; can C do that? Unfortunately, no. A few other problems relate to this code directly using the custom C extensions:</p><blockquote><p>è¿™ä¸ªå°å‡½æ•°ä¸­å­˜åœ¨å¤§é‡çš„é—®é¢˜ã€‚é¦–å…ˆï¼Œä½ æ³¨æ„åˆ°çš„å¯èƒ½å°±æ˜¯ <code>0b11000000</code>ã€‚äºŒè¿›åˆ¶è¡¨ç¤ºæ³•çš„ç¡®å¾ˆé…·ï¼Œä½† C è¯­è¨€æ”¯æŒå®ƒå—ï¼Ÿå¹¶ä¸æ”¯æŒã€‚å¦å¤–è¿˜æœ‰ä¸€äº›é—®é¢˜ä¹Ÿä¸ C è¯­è¨€çš„æ‰©å±•æœ‰å…³ã€‚</p></blockquote><p>IE: Interrupt enable bits.</p><p>SBUF0: Serial output buffer.</p><p>TI_0: Serial transmit buffer empty interrupt. Reading a 1 indicates the buffer is empty.</p><blockquote><p>IEï¼šè®¾ç½®ä¸­æ–­æ¯”ç‰¹ä½ã€‚</p><p>SBUF0ï¼šä¸²å£è¾“å‡ºç¼“å†²åŒºã€‚</p><p>TI_0ï¼šä¸²å£ä¼ è¾“åŒºç©ºä¸­æ–­ã€‚è¯»å–åˆ° 1 è¡¨æ˜ç¼“å†²åŒºä¸ºç©ºã€‚</p></blockquote><p>The uppercase variables actually access micro-controller built-in peripherals. If you want to control interrupts and output characters, you must use these peripherals. Yes, this is convenientâ€”but itâ€™s not C.</p><blockquote><p>è¿™äº›åå­—å¤§å†™çš„å˜é‡å®é™…ä¸Šéƒ½æ˜¯ç”¨æ¥è®¿é—®å¾®å¤„ç†å™¨çš„å†…ç½®éƒ¨ä»¶çš„ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦æ§åˆ¶ä¸­æ–­å¹¶ä¸”è¾“å‡ºå­—ç¬¦ï¼Œå°±å¿…é¡»ä½¿ç”¨è¿™äº›éƒ¨ä»¶ï¼Œå®ƒä»¬ä¹Ÿç¡®å®å¾ˆæ–¹ä¾¿â€”â€”ä½†è¿™ä¸æ˜¯ C ä»£ç ã€‚</p></blockquote><p>A clean embedded architecture would use these device access registers directly in very few places and confine them totally to the firmware. Anything that knows about these registers becomes firmware and is consequently bound to the silicon. Tying code to the processor will hurt you when you want to get code working before you have stable hardware. It will also hurt you when you move your embedded application to a new processor.</p><blockquote><p>åœ¨æ•´æ´çš„åµŒå…¥å¼æ¶æ„ä¸­ï¼Œæˆ‘ä»¬ä¼šå°†è¿™äº›ç”¨äºè®¾å¤‡è®¿é—®çš„å¯„å­˜å™¨è®¿é—®é›†ä¸­åœ¨ä¸€èµ·ï¼Œå¹¶å°†å…¶é™åˆ¶åœ¨å›ºä»¶å±‚ä¸­ã€‚è¿™æ ·ä¸€æ¥ï¼Œä»»ä½•éœ€è¦çŸ¥é“è¿™äº›å¯„å­˜å™¨å€¼çš„ä»£ç éƒ½å¿…é¡»æˆä¸ºå›ºä»¶ä»£ç ï¼Œä¸ç¡¬ä»¶å®ç°ç»‘å®šã€‚ä¸€æ—¦è¿™äº›ä»£ç ä¸å¤„ç†å™¨å®ç°å¼ºç»‘å®šï¼Œé‚£ä¹ˆåœ¨å¤„ç†å™¨ç¨³å®šå·¥ä½œä¹‹å‰å®ƒä»¬æ˜¯æ— æ³•å·¥ä½œçš„ï¼Œå¹¶ä¸”åœ¨éœ€è¦å°†å…¶è¿ç§»åˆ°ä¸€ä¸ªæ–°å¤„ç†å™¨ä¸Šæ—¶ä¹Ÿä¼šé‡åˆ°éº»çƒ¦ã€‚</p></blockquote><p>If you use a micro-controller like this, your firmware could isolate these low-level functions with some form of a processor abstraction layer (PAL). Firmware above the PAL could be tested off-target, making it a little less firm.</p><blockquote><p>å¦‚æœæˆ‘ä»¬çœŸçš„éœ€è¦ä½¿ç”¨è¿™ç§å¾®å¤„ç†å™¨ï¼Œå›ºä»¶å°±å¿…é¡»å°†è¿™ç±»åº•å±‚å‡½æ•°éš”ç¦»æˆå¤„ç†å™¨æŠ½è±¡å±‚ï¼ˆPALï¼‰ï¼Œè¿™æ ·ä¸€æ¥ï¼Œä½¿ç”¨ PAL çš„å›ºä»¶ä»£ç å°±å¯ä»¥åœ¨ç›®æ ‡å¹³å°ä¹‹å¤–è¢«æµ‹è¯•äº†ã€‚</p></blockquote><h3 id="the-operating-system-is-a-detail-æ“ä½œç³»ç»Ÿæ˜¯å®ç°ç»†èŠ‚" tabindex="-1"><a class="header-anchor" href="#the-operating-system-is-a-detail-æ“ä½œç³»ç»Ÿæ˜¯å®ç°ç»†èŠ‚" aria-hidden="true">#</a> The Operating System Is a Detail æ“ä½œç³»ç»Ÿæ˜¯å®ç°ç»†èŠ‚</h3><p>A HAL is necessary, but is it sufficient? In bare-metal embedded systems, a HAL may be all you need to keep your code from getting too addicted to the operating environment. But what about embedded systems that use a real-time operating system (RTOS) or some embedded version of Linux or Windows?</p><blockquote><p>HAL çš„å¿…è¦æ€§æ˜¯ä¸è¨€è€Œå–»çš„ï¼Œä½†å…‰æœ‰ HAL å°±å¤Ÿäº†å—ï¼Ÿåœ¨è£¸æœºçš„åµŒå…¥å¼ç³»ç»Ÿä¸­ï¼ŒHAL çš„ç¡®å¯èƒ½å¯ä»¥ä¿è¯æˆ‘ä»¬çš„ä»£ç ä¸ä¼šå’Œè¿è¡Œç¯å¢ƒç»‘å®šå¾—å¤ªç´§å¯†ã€‚ä½†å¦‚æœåµŒå…¥å¼ç³»ç»Ÿä½¿ç”¨äº†æŸç§å®æ—¶æ“ä½œç³»ç»Ÿï¼ˆRTOSï¼‰ï¼Œæˆ–è€…æŸç§åµŒå…¥å¼çš„ Linux æˆ– Windows å‘¢ï¼Ÿ</p></blockquote><p>To give your embedded code a good chance at a long life, you have to treat the operating system as a detail and protect against OS dependencies.</p><blockquote><p>ä¸ºäº†å»¶é•¿ä»£ç çš„ç”Ÿå‘½å‘¨æœŸï¼Œæˆ‘ä»¬å¿…é¡»å°†æ“ä½œç³»ç»Ÿä¹Ÿå®šä¹‰ä¸ºå®ç°ç»†èŠ‚ï¼Œè®©ä»£ç é¿å…ä¸æ“ä½œç³»ç»Ÿå±‚äº§ç”Ÿä¾èµ–ã€‚</p></blockquote><p>The software accesses the services of the operating environment through the OS. The OS is a layer separating the software from firmware (Figure 29.5). Using an OS directly can cause problems. For example, what if your RTOS supplier is bought by another company and the royalties go up, or the quality goes down? What if your needs change and your RTOS does not have the capabilities that you now require? Youâ€™ll have to change lots of code. These wonâ€™t just be simple syntactical changes due to the new OSâ€™s API, but will likely have to adapt semantically to the new OSâ€™s different capabilities and primitives.</p><blockquote><p>è½¯ä»¶é€šè¿‡æ“ä½œç³»ç»Ÿæ¥è®¿é—®è¿è¡Œç¯å¢ƒæœåŠ¡ã€‚æ“ä½œç³»ç»Ÿæ˜¯å°†è½¯ä»¶ä¸å›ºä»¶éš”ç¦»çš„é‚£ä¸€å±‚ï¼ˆè§å›¾ 29.5ï¼‰ï¼Œç›´æ¥ä½¿ç”¨æ“ä½œç³»ç»ŸæœåŠ¡å¯èƒ½ä¼šå¸¦æ¥é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ›´æ¢äº† RTOS æ“ä½œç³»ç»Ÿå‚å•†ï¼Œæˆæƒè´¹ç”¨æé«˜ï¼Œæˆ–è€…è´¨é‡ä¸‹é™æ€ä¹ˆåŠï¼Ÿå¦‚æœéœ€æ±‚å‘ç”Ÿå˜åŒ–ï¼ŒRTOS æ— æ³•æ»¡è¶³æ€ä¹ˆåŠï¼Ÿå¾ˆå¤šä»£ç éƒ½éœ€è¦å˜åŠ¨ï¼Œä¸ä»…è¦æ›´æ”¹è¯­æ³•é€‚åº”æ–°æ“ä½œç³»ç»Ÿ APIï¼Œå¾ˆæœ‰å¯èƒ½éœ€è¦é‡æ–°é€‚åº”æ–°æ“ä½œç³»ç»Ÿçš„è¯­ä¹‰ä¸åŸè¯­ã€‚</p></blockquote><!----><p>A clean embedded architecture isolates software from the operating system, through an operating system abstraction layer (OSAL) (Figure 29.6). In some cases, implementing this layer might be as simple as changing the name of a function. In other cases, it might involve wrapping several functions together.</p><blockquote><p>æ•´æ´çš„åµŒå…¥å¼æ¶æ„ä¼šå¼•å…¥æ“ä½œç³»ç»ŸæŠ½è±¡å±‚ï¼ˆOSALï¼Œå¦‚å›¾ 29.6 æ‰€ç¤ºï¼‰ï¼Œå°†è½¯ä»¶ä¸æ“ä½œç³»ç»Ÿåˆ†å‰²å¼€ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå®ç°è¿™ä¸ªæŠ½è±¡å±‚å°±åƒç»™å‡½æ•°æ”¹ä¸ªåå­—é‚£ä¹ˆç®€å•ã€‚è€Œåœ¨å¦ä¸€äº›æƒ…å†µä¸‹ï¼Œåˆ™éœ€è¦å°†å‡ ä¸ªå‡½æ•°å°è£…åœ¨ä¸€èµ·ã€‚</p></blockquote><!----><p>If you have ever moved your software from one RTOS to another, you know it is painful. If your software depended on an OSAL instead of the OS directly, you would largely be writing a new OSAL that is compatible with the old OSAL. Which would you rather do: modify a bunch of complex existing code, or write new code to a defined interface and behavior? This is not a trick question. I choose the latter.</p><blockquote><p>å¦‚æœä½ æœ‰è¿ç§»è¿‡ RTOS ç³»ç»Ÿçš„ç»å†ï¼Œå°±ä¸€å®šçŸ¥é“é‚£æœ‰å¤šç—›è‹¦ã€‚å¦‚æœæˆ‘ä»¬èƒ½è®©è‡ªå·±çš„è½¯ä»¶ä¾èµ–äº OSALï¼Œè€Œä¸æ˜¯ç›´æ¥ä¾èµ–äºæ“ä½œç³»ç»Ÿï¼Œæˆ‘ä»¬å°±åªéœ€è¦å†™ä¸€ä¸ªå…¼å®¹ä»¥å‰çš„ OSAL å®ç°çš„æ–°ç‰ˆæœ¬å³å¯ã€‚ä½ è§‰å¾—å“ªä¸€ç§æ–¹å¼æ›´å¥½ï¼Ÿæ˜¯ä¿®æ”¹ä¸€å †å¤æ‚çš„ç°æœ‰ä»£ç ï¼Œè¿˜æ˜¯æŒ‰ç…§æ¥å£å’Œè¡Œä¸ºå®šä¹‰æ¥å†™ä¸€å¥—æ–°ä»£ç ï¼Ÿè¿™é‡Œæ˜¾è€Œæ˜“è§ï¼Œåè€…æ›´å¥½ã€‚</p></blockquote><p>You might start worrying about code bloat about now. Really, though, the layer becomes the place where much of the duplication around using an OS is isolated. This duplication does not have to impose a big overhead. If you define an OSAL, you can also encourage your applications to have a common structure. You might provide message passing mechanisms, rather than having every thread handcraft its concurrency model.</p><blockquote><p>å½“ç„¶ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæ‹…å¿ƒä»£ç è†¨èƒ€çš„é—®é¢˜ã€‚ä½†æ˜¯ï¼Œå…¶å®ä¸Šé¢è¿™ç§åˆ†å±‚å·²ç»å°†å› ä¸ºä½¿ç”¨æ“ä½œç³»ç»Ÿæ‰€å¸¦æ¥çš„é‡å¤æ€§ä»£ç éš”ç¦»å¼€äº†ï¼Œå› æ­¤è¿™ç§é‡å¤ä¸ä¸€å®šä¼šå¸¦æ¥å¾ˆå¤§çš„é¢å¤–è´Ÿæ‹…ã€‚è€Œä¸”ï¼Œå¦‚æœæˆ‘ä»¬å®šä¹‰äº† OSALï¼Œè¿˜å¯ä»¥è®©è‡ªå·±çš„åº”ç”¨å…±äº«ä¸€ç§å…¬ç”¨ç»“æ„ã€‚æ¯”å¦‚é‡‡ç”¨ä¸€å¥—æ ‡å‡†çš„æ¶ˆæ¯ä¼ é€’æœºåˆ¶ï¼Œè¿™æ ·æ¯ä¸ªçº¿ç¨‹å°±ä¸ç”¨è‡ªå·±å®šä¹‰ä¸€ä¸ªå¹¶è¡Œæ¨¡å‹äº†ã€‚</p></blockquote><p>The OSAL can help provide test points so that the valuable application code in the software layer can be tested off-target and off-OS. A clean embedded architectureâ€™s software is testable off the target operating system. A successful OSAL provides that seam or set of substitution points that facilitate off-target testing.</p><blockquote><p>å¦å¤–ï¼ŒOSAL è¿˜å¯ä»¥å¸®åŠ©é«˜ä»·å€¼çš„åº”ç”¨ç¨‹åºå®ç°åœ¨ç›®æ ‡å¹³å°ã€ç›®æ ‡æ“ä½œç³»ç»Ÿä¹‹å¤–è¿›è¡Œæµ‹è¯•ã€‚ä¸€ä¸ªç”±æ•´æ´çš„åµŒå…¥å¼æ¶æ„æ‰€æ„å»ºå‡ºæ¥çš„è½¯ä»¶æ˜¯å¯ä»¥åœ¨ç›®æ ‡æ“ä½œç³»ç»Ÿä¹‹å¤–è¢«æµ‹è¯•çš„ã€‚è®¾è®¡è‰¯å¥½çš„ OSAL ä¼šä¸ºè¿™ç§ç›®æ ‡ç¯å¢ƒå¤–çš„æµ‹è¯•æä¾›æ”¯æ’‘ç‚¹ã€‚</p></blockquote><h3 id="programming-to-interfaces-and-substitutability-é¢å‘æ¥å£ç¼–ç¨‹ä¸å¯æ›¿ä»£æ€§" tabindex="-1"><a class="header-anchor" href="#programming-to-interfaces-and-substitutability-é¢å‘æ¥å£ç¼–ç¨‹ä¸å¯æ›¿ä»£æ€§" aria-hidden="true">#</a> PROGRAMMING TO INTERFACES AND SUBSTITUTABILITY é¢å‘æ¥å£ç¼–ç¨‹ä¸å¯æ›¿ä»£æ€§</h3><p>In addition to adding a HAL and potentially an OSAL inside each of the major layers (software, OS, firmware, and hardware), you canâ€”and shouldâ€”apply the principles described throughout this book. These principles encourage separation of concerns, programming to interfaces, and substitutability.</p><blockquote><p>é™¤äº†åœ¨åµŒå…¥å¼ç³»ç»Ÿçš„ä¸»è¦åˆ†å±‚ï¼ˆæŒ‡è½¯ä»¶ã€æ“ä½œç³»ç»Ÿã€å›ºä»¶ã€ç¡¬ä»¶è¿™å››å±‚ï¼‰ä¹‹ä¸­å¢åŠ  HAL å’Œ OSAL ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥â€”â€”ä¹Ÿåº”è¯¥â€”â€”åº”ç”¨æœ¬ä¹¦ä¸­æåˆ°çš„å…¶ä»–è®¾è®¡åŸåˆ™ã€‚è¿™äº›è®¾è®¡åŸåˆ™å¯ä»¥å¸®åŠ©æˆ‘ä»¬æŒ‰åŠŸèƒ½æ¨¡å—ã€æ¥å£ç¼–ç¨‹ä»¥åŠå¯æ›¿ä»£æ€§æ¥åˆ’åˆ†ç³»ç»Ÿã€‚</p></blockquote><p>The idea of a layered architecture is built on the idea of programming to interfaces. When one module interacts with another though an interface, you can substitute one service provider for another. Many readers will have written their own small version of printf for deployment in the target. As long as the interface to your printf is the same as the standard version of printf, you can override the service one for the other.</p><blockquote><p>åˆ†å±‚æ¶æ„çš„ç†å¿µæ˜¯åŸºäºæ¥å£ç¼–ç¨‹çš„ç†å¿µæ¥è®¾è®¡çš„ã€‚å½“æ¨¡å—ä¹‹é—´èƒ½ä»¥æ¥å£å½¢å¼äº¤äº’æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†ä¸€ä¸ªæœåŠ¡æ›¿æ¢æˆå¦å¤–ä¸€ä¸ªæœåŠ¡ã€‚ä¾‹å¦‚ï¼Œå¾ˆå¤šè¯»è€…åº”è¯¥éƒ½å†™è¿‡èƒ½åœ¨æŸä¸ªç›®æ ‡æœºå™¨ä¸Šè¿è¡Œçš„ã€å°å‹çš„è‡ªå®šä¹‰çš„ printf å‡½æ•°ã€‚åªè¦æˆ‘ä»¬çš„ printf ä¸æ ‡å‡†çš„ printf å‡½æ•°æ¥å£ä¸€è‡´ï¼Œå®ƒä»¬å°±å¯ä»¥äº’ç›¸æ›¿æ¢ã€‚</p></blockquote><p>One basic rule of thumb is to use header files as interface definitions. When you do so, however, you have to be careful about what goes in the header file. Limit header file contents to function declarations as well as the constants and struct names that are needed by the function.</p><blockquote><p>ç›®å‰çš„æ™®é€‚è§„åˆ™ä¹‹ä¸€å°±æ˜¯ç”¨å¤´ä¸ˆä»¶æ¥å……å½“æ¥å£çš„å®šä¹‰ã€‚ç„¶è€Œï¼Œå¦‚æœçœŸçš„è¦è¿™æ ·åšçš„è¯ï¼Œå°±éœ€è¦å°å¿ƒæ§åˆ¶å¤´æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œå°½é‡ç¡®ä¿å¤´æ–‡ä»¶ä¸­åªåŒ…æ‹¬å‡½æ•°å£°æ˜ï¼Œä»¥åŠå‡½æ•°æ‰€éœ€è¦çš„ç»“æ„ä½“åå­—å’Œå¸¸é‡ã€‚</p></blockquote><p>Donâ€™t clutter the interface header files with data structures, constants, and typedefs that are needed by only the implementation. Itâ€™s not just a matter of clutter: That clutter will lead to unwanted dependencies. Limit the visibility of the implementation details. Expect the implementation details to change. The fewer places where code knows the details, the fewer places where code will have to be tracked down and modified.</p><blockquote><p>å¦å¤–ï¼Œä¸è¦åœ¨å®šä¹‰æ¥å£çš„å¤´æ–‡ä»¶ä¸­åŒ…å«åªæœ‰å…·ä½“å®ç°ä»£ç æ‰éœ€è¦çš„æ•°æ®ç»“æ„ã€å¸¸é‡ä»¥åŠç±»å‹å®šä¹‰ï¼ˆtypedefï¼‰ã€‚è¿™ä¸ä»…ä»…æ˜¯æ¶æ„æ˜¯å¦æ•´æ´çš„é—®é¢˜ï¼Œè€Œæ˜¯è¿™æ ·åšå¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„ä¾èµ–å…³ç³»ã€‚æ€»ä¹‹ï¼Œæˆ‘ä»¬å¿…é¡»æ§åˆ¶å¥½å®ç°ç»†èŠ‚çš„å¯è§æ€§ï¼Œå› ä¸ºè¿™äº›å®ç°ç»†èŠ‚æ˜¯è‚¯å®šä¼šå˜åŒ–çš„ã€‚å…³æ³¨å®ç°ç»†èŠ‚çš„ä»£ç è¶Šå°‘ï¼Œå®ƒä»¬æ‰€éœ€çš„å˜æ›´å°±è¶Šå°‘ã€‚</p></blockquote><p>A clean embedded architecture is testable within the layers because modules interact through interfaces. Each interface provides that seam or substitution point that facilitates off-target testing.</p><blockquote><p>ç”±æ•´æ´çš„åµŒå…¥å¼æ¶æ„æ‰€æ„å»ºçš„ç³»ç»Ÿåº”è¯¥åœ¨æ¯ä¸€ä¸ªåˆ†å±‚ä¸­éƒ½æ˜¯å¯æµ‹è¯•çš„ï¼Œå› ä¸ºå®ƒçš„æ¨¡å—ä¹‹é—´é‡‡ç”¨æ¥å£é€šä¿¡ï¼Œæ¯ä¸€ä¸ªæ¥å£éƒ½ä¸ºå¹³å°ä¹‹å¤–çš„æµ‹è¯•æä¾›äº†æ›¿æ¢ç‚¹ã€‚</p></blockquote><h3 id="dry-conditional-compilation-directives-dry-æ¡ä»¶æ€§ç¼–è¯‘å‘½ä»¤" tabindex="-1"><a class="header-anchor" href="#dry-conditional-compilation-directives-dry-æ¡ä»¶æ€§ç¼–è¯‘å‘½ä»¤" aria-hidden="true">#</a> DRY CONDITIONAL COMPILATION DIRECTIVES DRY æ¡ä»¶æ€§ç¼–è¯‘å‘½ä»¤</h3><p>One use of substitutability that is often overlooked relates to how embedded C and C++ programs handle different targets or operating systems. There is a tendency to use conditional compilation to turn on and off segments of code. I recall one especially problematic case where the statement #ifdef BOARD_V2 was mentioned several thousand times in a telecom application.</p><blockquote><p>å¦ä¸€ä¸ªç»å¸¸è¢«å¿½è§†çš„å¯æ›¿ä»£æ¢æ€§è§„åˆ™çš„å®é™…æ¡ˆä¾‹æ˜¯åµŒå…¥å¼ C/C++ ç¨‹åºå¯¹ä¸åŒå¹³å°å’Œæ“ä½œç³»ç»Ÿçš„å¤„ç†æ–¹å¼ã€‚è¿™äº›ç¨‹åºç»å¸¸ä¼šç”¨æ¡ä»¶æ€§ç¼–è¯‘å‘½ä»¤æ¥æ ¹æ®ä¸åŒçš„å¹³å°å¯ç”¨å’Œç¦ç”¨æŸä¸€æ®µä»£ç ã€‚ä¾‹å¦‚ï¼Œæˆ‘æ›¾ç»é‡åˆ°è¿‡ <code>#ifdef BOARD_V2</code> è¿™æ¡è¯­å¥åœ¨ä¸€ä¸ªç”µä¿¡åº”ç”¨ç¨‹åºä¸­å‡ºç°äº†å‡ åƒæ¬¡çš„æƒ…å†µã€‚</p></blockquote><p>This repetition of code violates the Donâ€™t Repeat Yourself (DRY) principle.5 If I see #ifdef BOARD_V2 once, itâ€™s not really a problem. Six thousand times is an extreme problem. Conditional compilation identifying the target-hardwareâ€™s type is often repeated in embedded systems. But what else can we do?</p><blockquote><p>å¾ˆæ˜¾ç„¶ï¼Œè¿™ç§ä»£ç çš„é‡å¤è¿èƒŒäº†â€œä¸è¦é‡å¤è‡ªå·±ï¼ˆDRYï¼‰â€åŸåˆ™ã€‚å¦‚æœ <code>#ifdef BOARD_V2</code> åªå‡ºç°ä¸€æ¬¡ï¼Œè¿™å½“ç„¶ä¸æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Œè€Œå¦‚æœå‡ºç°äº† 6000 æ¬¡ï¼Œé‚£å°±éå¸¸ä¸¥é‡äº†ã€‚ä½†è¿™ç±»æ¡ä»¶æ€§ç¼–è¯‘è¯­å¥åœ¨åµŒå…¥å¼ç¼–ç¨‹ä¸­éå¸¸å¸¸è§ï¼Œæœ‰ä»€ä¹ˆå¥½çš„è§£å†³æ–¹æ¡ˆå—ï¼Ÿ</p></blockquote><p>What if there is a hardware abstraction layer? The hardware type would become a detail hidden under the HAL. If the HAL provides a set of interfaces, instead of using conditional compilation, we could use the linker or some form of runtime binding to connect the software to the hardware.</p><blockquote><p>ä½¿ç”¨ç¡¬ä»¶æŠ½è±¡å±‚å¦‚ä½•ï¼Ÿè¿™æ ·çš„è¯ï¼Œç¡¬ä»¶ç±»å‹å°±åªæ˜¯ HAL ä¸­çš„ä¸€ä¸ªå®ç°ç»†èŠ‚äº†ã€‚è€Œä¸”ï¼Œå¦‚æœç³»ç»Ÿä¸­ä½¿ç”¨çš„æ˜¯ HAL æ‰€æä¾›çš„ä¸€ç³»åˆ—æ¥å£ï¼Œè€Œä¸æ˜¯æ¡ä»¶æ€§ç¼–è¯‘è¯­å¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç”¨é“¾æ¥å™¨ï¼Œæˆ–è€…æŸç§è¿è¡Œæ—¶åŠ è½½å™¨æ¥å°†è½¯ä»¶ä¸ç¡¬ä»¶ç›¸ç»“åˆäº†ã€‚</p></blockquote><h2 id="conclusion-æœ¬ç« å°ç»“" tabindex="-1"><a class="header-anchor" href="#conclusion-æœ¬ç« å°ç»“" aria-hidden="true">#</a> CONCLUSION æœ¬ç« å°ç»“</h2><p>People who are developing embedded software have a lot to learn from experiences outside of embedded software. If you are an embedded developer who has picked up this book, you will find a wealth of software development wisdom in the words and ideas.</p><blockquote><p>åµŒå…¥å¼ç¼–ç¨‹äººå‘˜åº”è¯¥å¤šå­¦ä¹ ä¸€äº›éåµŒå…¥å¼ç³»ç»Ÿçš„ç¼–ç¨‹ç»éªŒã€‚å¦‚æœä½ ä»äº‹çš„æ˜¯åµŒå…¥å¼ç¼–ç¨‹å·¥ä½œï¼Œç›¸ä¿¡ä½ ä¸€å®šä¼šä»æœ¬ç« çš„å»ºè®®ä¸­å¾—åˆ°å¾ˆå¤šå¯å‘ã€‚</p></blockquote><p>Letting all code become firmware is not good for your productâ€™s long-term health. Being able to test only in the target hardware is not good for your productâ€™s long-term health. A clean embedded architecture is good for your productâ€™s long-term health.</p><blockquote><p>ä¸ºäº†è®©æˆ‘ä»¬çš„äº§å“èƒ½é•¿æœŸåœ°ä¿æŒå¥åº·ï¼Œè¯·åˆ«è®©ä½ çš„ä»£ç éƒ½å˜æˆå›ºä»¶ã€‚å¦‚æœä¸€ä¸ªç³»ç»Ÿçš„ä»£ç åªèƒ½åœ¨ç›®æ ‡ç¡¬ä»¶ä¸Šæµ‹è¯•ï¼Œé‚£ä¹ˆå®ƒçš„å¼€å‘è¿‡ç¨‹ä¼šå˜å¾—éå¸¸è‰°éš¾ã€‚æ€»ä¹‹ï¼Œä¸ºäº§å“çš„é•¿æœŸå¥åº·ç€æƒ³è€Œé‡‡ç”¨ä¸€å¥—æ•´æ´çš„åµŒå…¥å¼æ¶æ„æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚</p></blockquote></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/windily-cloud/obsidian-publish/edit/main/Publish/Publish/Clean Archtechture/ch29.md" rel="noopener noreferrer" target="_blank" aria-label="ç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->ç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><span class="info">2022/9/20 11:11:04</span></div><div class="meta-item contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: wwww.4399li@qq.com">windilycloud</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch28.html" class="nav-link prev" aria-label="ch28.md"><div class="hint"><span class="arrow left"></span>ä¸Šä¸€é¡µ</div><div class="link"><span class="icon iconfont icon-file"></span>ch28.md</div></a><a href="/obsidian-publish/Publish/Clean%20Archtechture/ch3.html" class="nav-link next" aria-label="ch3.md"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow right"></span></div><div class="link">ch3.md<span class="icon iconfont icon-file"></span></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">ä»€ä¹ˆæ˜¯å¹¸è¤”ï¼Ÿ å¹¸ç¦å°±æ˜¯çŒ«åƒé±¼ç‹—åƒè‚‰ï¼Œå¥¥ç‰¹æ›¼æ‰“å°æ€ªå…½ï¼</div><div class="copyright">Copyright Â© 2022 Windily-Cloud</div></footer><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/obsidian-publish/assets/app.887b133c.js" defer></script>
  </body>
</html>
